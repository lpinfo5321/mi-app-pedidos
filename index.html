<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Gestión General de Pedidos e Inventario</title>

  <!-- Iconos Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <!-- Librerías jsPDF y jsPDF-AutoTable para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ====== ESTILOS GENERALES ====== */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      color: #333;
      overflow-x: hidden;
      animation: fadeIn 0.6s ease forwards;
    }
    /* Clase para bloquear el scroll del body cuando un modal está abierto */
    body.body-modal-open {
      overflow-y: hidden;
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px) translateX(-50%); }
      20% { opacity: 1; transform: translateY(0) translateX(-50%); }
      80% { opacity: 1; transform: translateY(0) translateX(-50%); }
      100% { opacity: 0; transform: translateY(-20px) translateX(-50%); }
    }

    /* ====== SPLASH ====== */
    .splash {
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo {
      width: 300px;
      height: 300px;
      animation: blurInOut 3s forwards ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    @keyframes blurInOut {
      0% { opacity: 0; filter: blur(20px); transform: scale(0.7); }
      30% { opacity: 1; filter: blur(0); transform: scale(1); }
      60% { opacity: 1; filter: blur(0); transform: scale(1); }
      100% { opacity: 0; filter: blur(20px); transform: scale(0.7); }
    }

    /* ====== CABECERA Y TABS ====== */
    @keyframes slideDown {
      0% { transform: translateY(-50px); }
      100% { transform: translateY(0); }
    }
    .header {
      background: #fff;
      color: #000;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      animation: slideDown 0.5s ease;
      padding: 0.5rem; /* Ajustado para dar espacio a la nueva fila */
      border-bottom: 1px solid #ddd;
    }
    .header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      width: 100%; /* Asegurar que ocupe todo el ancho */
    }

    /* Nueva fila superior para iconos y búsqueda */
    .header-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.2rem 0; /* Padding vertical ligero, horizontal se maneja en header o por gap */
      margin-bottom: 0.6rem; /* Espacio antes del selector de compañía y tabs */
      gap: 0.5rem; /* Espacio entre grupos de iconos y barra de búsqueda */
    }

    .header-icon-group-left,
    .header-icon-group-right {
      display: flex;
      align-items: center;
      gap: 0.6rem; /* Espacio entre los iconos dentro de un grupo */
    }
    
    .header-icon-btn {
      background: #f0f0f0; /* Fondo gris claro */
      border: none;
      border-radius: 10px; /* Esquinas redondeadas */
      cursor: pointer;
      outline: none;
      width: 42px; /* Tamaño unificado */
      height: 42px; /* Tamaño unificado */
      display: flex;
      align-items: center;
      justify-content: center;
      padding:0;
      color: #333; /* Iconos oscuros por defecto */
      transition: background-color 0.2s ease;
      position: relative; /* Añadido para que los popups puedan posicionarse relativos a estos botones */
    }
    .header-icon-btn:hover {
      background: #e0e0e0; /* Un poco más oscuro al pasar el mouse */
    }
    .header-icon-btn .material-icons {
      font-size: 24px; /* Tamaño de icono ajustado */
    }

    /* Estilo específico para el botón de tienda */
    .header-icon-btn.store-icon-btn {
      background: #f0f0f0; /* Fondo claro, igual al botón de menú */
      color: #333; /* Color de icono oscuro por defecto */
    }
    .header-icon-btn.store-icon-btn:hover {
      background: #e0e0e0;
    }
    /* Contenedor para el icono/logo dentro del botón de tienda */
    #storeButtonIconContainer img {
      width: 26px; /* Ajustar tamaño del logo de compañía */
      height: 26px;
      border-radius: 4px; /* Ligeras esquinas redondeadas para el logo */
      object-fit: contain; /* Asegurar que el logo se vea completo */
    }

    /* Estilo para el botón de carrito (para el badge) */
    .header-icon-btn.cart-icon-btn {
      position: relative; /* Para posicionar el badge */
    }
    
    .tabs {
      display: flex;
      justify-content: center;
      gap: 1rem;
      width: 100%;
      background: #fff;
    }
    .tab {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 1rem;
      color: #000;
    }
    .tab:hover { opacity: 0.8; }
    .tab.active { border-bottom: 2px solid #000; }

    /* BARRA DE BÚSQUEDA */
    .search-bar {
      display: flex;
      align-items: center;
      background: #f0f0f0; /* Consistente con botones */
      padding: 6px 12px; /* Ajustar padding */
      border-radius: 22px; /* Más redondeado, tipo píldora */
      flex-grow: 1; 
      margin: 0; /* Sin margen extra, el gap de header-top-row lo maneja */
      position: relative; 
      min-width: 150px; /* Para evitar que se colapse demasiado */
    }
    .search-bar .material-icons { font-size: 20px; color: #555; margin-right: 8px; }
    .search-bar input {
      background: transparent;
      border: none;
      outline: none;
      color: #000;
      width: calc(100% - 25px); /* Ajustar ancho para el icono de búsqueda y X */
      font-size: 0.9rem;
      padding-right: 5px; /* Reducir padding si el icono X está separado */
    }
    .search-bar .clear-search-btn {
      position: absolute;
      right: 5px; /* Más cerca del borde */
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #777; /* Color del ícono */
      cursor: pointer;
      padding: 2px; /* Ligero padding alrededor del ícono */
      display: none; /* Oculto por defecto */
      line-height: 1; /* Para alinear bien el ícono */
      /* El font-size del span del ícono ya está inline, pero podemos asegurar aquí */
    }
    .search-bar .clear-search-btn:hover {
      color: #000;
    }
    .search-bar .clear-search-btn .material-icons {
      font-size: 18px; /* Asegurar tamaño del icono X */
      display: block; /* Para centrado correcto */
    }

    /* SELECTOR DE COMPAÑÍA */
    .company-selector {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 8px 0;
      position: relative; /* Clave para el posicionamiento del popup */
    }
    .company-selector img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #000;
    }
    .company-popup {
      position: absolute;
      top: calc(100% + 8px); /* Debajo del botón activador + pequeño espacio */
      left: 0; /* Alineado a la izquierda del botón activador */
      background: #fff;
      border: 1px solid #ddd; /* Borde más sutil */
      border-radius: 12px; /* Esquinas más redondeadas */
      width: 230px; /* Ancho ligeramente ajustado */
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15); /* Sombra más suave y moderna */
      display: none;
      animation: fadeInScale 0.25s ease-out; /* Añadida animación */
      z-index: 2000;
      transform-origin: top left; /* Origen de la animación para el popup izquierdo */
    }
    /* Triángulo/Flecha para unir visualmente */
    .company-popup::before {
      content: '';
      position: absolute;
      bottom: 100%; /* Lo coloca encima del popup */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #fff; /* Color del borde del popup */
      /* Efecto para que el borde del triángulo también se vea */
      filter: drop-shadow(0 -1px 0px #ddd); /* Simula el borde superior del triángulo */
    }

    .company-popup.show { display: block; }
    .company-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      cursor: pointer;
      color: #000;
    }
    .company-item img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      object-fit: cover;
    }
    .company-item:hover { background: #f0f0f0; }
    @keyframes fadeInScale {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* CONTENIDO PRINCIPAL */
    .content {
      max-width: 1200px;
      margin: 0 auto; /* margin-top se controlará con JS */
      padding: 10px 15px 80px;
    }
    /* Ocultar listas inicialmente y añadir transición */
    #pedidoList, #ordenList, #inventarioList {
      opacity: 0;
      transition: opacity 0.15s ease-in-out; /* Transición rápida para la aparición */
    }
    .grid-1col {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      justify-items: center;
    }
    .grid-2col {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      justify-items: center;
    }
    .grid-pc {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 6px; /* Reducido de 8px a 6px */
      justify-items: center;
    }

    /* ITEMS */
    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .item {
      background: #fff;
      padding: 10px; /* Reducido de 12px */
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeUp 0.4s ease both;
      transition: background-color 0.2s ease;
      width: 100%;
      max-width: 200px;
    }
    .grid-1col .item { max-width: 350px; }
    .grid-pc .item { max-width: 220px; } /* Reducido de 250px a 220px */
    .item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .item.highlight { border: 2px solid #000 !important; }
    .img-space {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 6px; /* Reducido de 8px */
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
    }
    .img-space img { 
      display: block; /* Asegura que se comporte como bloque */
      max-width: 100%; 
      max-height: 100%;
      width: auto; /* Deja que el navegador determine el ancho */
      height: auto; /* Deja que el navegador determine el alto */
      object-fit: contain; /* Asegura que quepa sin recortar */
    }
    .edit-icon-btn {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(255,255,255,0.8);
      border: none;
      cursor: pointer;
      outline: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .edit-icon-btn .material-icons { font-size: 14px; color: #555; }
    
    .credit-icon-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255,255,255,0.8);
      border: none;
      cursor: pointer;
      outline: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .credit-icon-btn .material-icons { font-size: 14px; color: #c00; }
    .item-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 4px; /* Reducido de 6px */
    }
    .product-name {
      height: 2.6em; /* Aumentado de 2.4em para más espacio vertical */
      line-height: 1.2;
      overflow: hidden;
      font-weight: 500;
      color: #111;
      font-size: 0.9rem; /* Reducido de 0.95rem */
    }
    .product-number {
      font-size: 0.65rem;
      color: #999;
      margin-top: 2px;
    }

    /* CAMPOS DE CANTIDAD */
    .quantity-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px; /* Reducido de 4px */
      font-size: 0.85rem;
      width: 100%;
    }
    .quantity-input-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      width: 100%;
      max-width: 120px;
    }
    .quantity-btn {
      width: 28px;
      height: 28px;
      min-width: 28px;
      min-height: 28px;
      padding: 0;
      border-radius: 50%;
      font-size: 16px;
      font-weight: bold;
      color: white;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease;
      border: none;
      outline: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      z-index: 10;
      line-height: 1;
      text-align: center;
    }
    .quantity-btn:hover {
      background: #000;
    }
    .quantity-btn:active {
      transform: scale(0.95);
    }
    .quantity-row input {
      width: 60px;
      padding: 6px;
      border: none;
      border-radius: 8px;
      background: #f8f8f8;
      color: #333;
      text-align: center;
      outline: none;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      margin: 0 2px; /* Reducido de 0 4px */
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .quantity-row input:focus { border: 2px solid #000; }
    .quantity-row input::-webkit-inner-spin-button,
    .quantity-row input::-webkit-outer-spin-button { -webkit-appearance: none; }

    /* BOTONES FIJOS (ABAJO) */
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      padding: 12px;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      animation: fadeInUp 0.5s ease;
      animation-delay: 0.3s;
      z-index: 900;
    }
    button {
      padding: 10px;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      text-transform: uppercase;
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      transition: transform 0.1s ease;
    }
    button:hover { opacity: 0.9; }
    button:active { background: #111; }
    
    /* Ajuste para asegurar que el material-icons dentro de botones esté centrado */
    button .material-icons {
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* MODALES */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
      backdrop-filter: blur(5px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal.show { display: flex; opacity: 1; pointer-events: auto; }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      transform: translateY(-30px);
      animation: slideInModal 0.3s forwards ease;
    }
    @keyframes slideInModal {
      0% { transform: translateY(-30px); }
      100% { transform: translateY(0); }
    }
    .modal-buttons {
      display: flex;
      justify-content: space-around;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .modal-buttons button {
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      color: #fff;
      min-width: 100px;
      width: auto;
      height: auto;
      transition: 0.2s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-buttons button:hover { opacity: 0.9; }
    .delete-btn { 
      background: #c00;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .cancel-btn { background: #777; }
    .save-btn, .download-btn { background: #000; }
    .modern-modal {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 0.85rem;
    }
    .form-group input, .form-group select {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      font-size: 0.9rem;
      color: #333;
      outline: none;
      appearance: auto;
      -webkit-appearance: menulist;
      -moz-appearance: menulist;
    }
    .form-group input:focus, .form-group select:focus { border-color: #888; }
    .form-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    @media (max-width: 480px) {
      .modal-content { max-width: 90%; padding: 16px; }
      .modern-modal { gap: 0.75rem; }
      .form-group label { font-size: 0.8rem; }
      .form-group input, .form-group select { font-size: 0.85rem; padding: 8px; }
      .modal-buttons button { font-size: 0.9rem; padding: 10px 20px; min-width: 100px; }

      /* Ajustes para los .form-row en móviles para asegurar apilamiento */
      #editModal .form-row,
      #newProductModal .form-row {
        flex-direction: column; /* Apilar los grupos de formularios */
        gap: 0; /* Eliminar el gap horizontal, el margen de los form-group se encargará */
      }
      #editModal .form-row .form-group,
      #newProductModal .form-row .form-group {
        width: 100%; /* Cada grupo de formulario ocupa todo el ancho */
        margin-bottom: 0.75rem; /* Espacio entre grupos apilados, igual que .modern-modal gap */
      }
      /* Eliminar margen inferior del último grupo en un form-row si no se necesita */
      #editModal .form-row .form-group:last-child,
      #newProductModal .form-row .form-group:last-child {
        margin-bottom: 0;
      }

      /* Ajustes responsivos para la sección de precios en el modal de edición */
      #priceContainer .price-row {
        flex-direction: row; /* Apilar elementos verticalmente */
        align-items: center; /* Estirar elementos al ancho completo */
        gap: 6px; /* Reducir el espacio entre elementos */
        padding: 0; /* Añadir un poco de padding */
        margin-bottom: 8px; /* Reducir margen inferior */
      }
      #priceContainer .price-row select.price-company,
      #priceContainer .price-row input.price-value {
        width: auto; /* Ocupar todo el ancho disponible */
        padding: 8px 6px; /* Reducir padding interno */
        font-size: 0.85rem; /* Texto más pequeño */
        height: 38px; /* Misma altura que el botón */
      }
      #priceContainer .price-row select.price-company {
        flex: 3; /* Más espacio al select */
      }
      #priceContainer .price-row input.price-value {
        flex: 2; /* Espacio para el input */
        text-align: right;
      }

      #priceContainer .price-row button { /* Botón "Eliminar" */
        align-self: auto; /* Alinear el botón de eliminar a la derecha */
        width: 38px;
        height: 38px;
      }
      /* Estilo para el icono dentro del botón si es necesario ajustar específicamente para 480px */
      #priceContainer .price-row button .material-icons {
        font-size: 20px; /* Ajustar si es necesario */
      }

      #priceSection button[type="button"] { /* Botón "Agregar Precio" */
        width: 100%; /* Hacerlo de ancho completo */
        margin-top: 0.75rem;
      }
    }

    /* ESTILOS PARA CAMPO DE MARGEN PERSONALIZADO */
    .margin-field {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .margin-field label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    .margin-field input {
      width: 70px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: right;
    }
    .margin-field .percent {
      font-size: 0.9rem;
    }
    
    /* PANEL DE AJUSTES MEJORADO */
    #settingsOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      display: none;
      opacity: 0;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(2px);
    }
    #settingsOverlay.show { display: block; opacity: 1; }
    #settingsTab {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: 100%; 
      background: #fff;
      z-index: 3001;
      display: none;
      flex-direction: column;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #settingsTab.show { 
      display: flex;
      opacity: 1;
    }
    .settings-header {
      background: #000;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .settings-header .back-button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      padding: 0;
    }
    .settings-header .back-button:active {
      background: rgba(255,255,255,0.2);
    }
    .settings-header h2 { 
      margin: 0; 
      font-size: 1.2rem; 
      font-weight: 600;
    }
    .settings-content {
      padding: 15px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1;
      width: 100%;
      box-sizing: border-box;
    }
    .settings-content p {
      margin-top: 0;
      color: #666;
      margin-bottom: 1rem;
      text-align: center;
      font-size: 0.9rem;
    }
    .settings-section { 
      margin-bottom: 1.5rem;
      background: #f8f8f8;
      padding: 12px;
      border-radius: 12px;
      width: 100%;
      box-sizing: border-box;
    }
    .settings-section h4 {
      margin: 0 0 0.8rem;
      font-size: 1rem;
      font-weight: 600;
      color: #333;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
    }
    .settings-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
      color: #333;
    }
    .settings-list-item:last-child { border-bottom: none; }
    .settings-actions { 
      display: flex; 
      gap: 5px; 
      align-items: center; 
    }
    .settings-actions button {
      min-width: 36px;
      min-height: 36px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      color: #555;
      padding: 0;
    }
    .rename-btn .material-icons { font-size: 18px; color: #555; }
    .remove-btn .material-icons { font-size: 18px; color: #c00; }
    .add-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .add-row input {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.9rem;
      outline: none;
      box-sizing: border-box;
    }
    .add-row input:focus {
      border-color: #000;
    }
    .icon-button {
      background: #000;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      align-self: flex-end;
      margin-top: 5px;
    }
    .icon-button .material-icons { font-size: 18px; }
    
    /* Company add row needs special handling */
    .company-add-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .company-add-row input {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.9rem;
      outline: none;
      box-sizing: border-box;
    }
    .company-add-row .icon-button {
      align-self: flex-end;
    }

    /* MODAL INFO DE PRODUCTO (Diseño Moderno y Mejorado) */
    .info-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 4000;
      backdrop-filter: blur(5px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .info-modal.show {
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }

    /* Nueva tarjeta de producto con diseño moderno */
    .product-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 400px;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Encabezado con logo y nombre del producto */
    .product-header {
      display: flex;
      align-items: center;
      padding: 18px;
      background: #f8f8f8;
      border-bottom: 1px solid #eee;
    }

    .product-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-right: 15px;
    }

    .header-text {
      flex: 1;
    }

    .product-header .product-name {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      height: auto;
    }

    .product-code {
      margin: 0;
      font-size: 0.8rem;
      color: #888;
    }

    /* Detalles del producto */
    .product-details {
      padding: 15px 18px;
      border-bottom: 1px solid #eee;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .detail-label {
      color: #666;
      font-size: 0.9rem;
    }

    .detail-value {
      font-weight: 500;
      color: #333;
      font-size: 0.9rem;
    }

    /* Lista de precios */
    .price-list {
      padding: 15px 18px;
    }

    .section-title {
      margin: 0 0 15px 0;
      font-size: 1rem;
      font-weight: 600;
      color: #333;
    }

    .prices-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .price-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: #f8f8f8;
      border-radius: 12px;
      transition: transform 0.2s ease;
    }

    .price-row:hover {
      transform: translateX(5px);
      background: #f0f0f0;
    }

    .price-company {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .company-logo {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }

    .company-name {
      font-size: 0.9rem;
      color: #444;
    }

    .price-value {
      font-weight: 700;
      font-size: 1.1rem;
      color: #333;
    }

    /* Precio sugerido */
    .suggested-price {
      margin-top: 15px;
      padding: 15px;
      background: #333;
      color: white;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .suggested-label {
      font-size: 0.85rem;
    }

    .suggested-value {
      font-weight: 700;
      font-size: 1.2rem;
    }

    .no-prices {
      text-align: center;
      color: #888;
      padding: 20px 0;
      font-style: italic;
    }

    /* Estilos adicionales para el PDF mejorado */
    .company-name-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .company-name-header img {
      height: 30px;
      width: 30px;
      object-fit: contain;
      border-radius: 50%;
    }
    
    .company-name-text {
      font-size: 1.2rem;
      font-weight: bold;
    }

    /* MODAL ZOOM IMAGEN ESTILOS */
    #imageZoomModal .modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden; /* Importante para el futuro zoom/paneo dentro del recuadro */
      
      /* Tamaño del recuadro del modal */
      width: 70vw; /* 70% del ancho del viewport */
      height: 80vh; /* 80% del alto del viewport */
      max-width: 800px; /* Límite máximo de ancho */
      max-height: 600px; /* Límite máximo de alto */
      
      padding: 15px; /* Un pequeño padding interno */
      background: #fff; /* Fondo blanco para el recuadro */
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Sombra estándar de modal */
      border-radius: 8px; /* Esquinas redondeadas */
    }
    #zoomedImage {
      display: block; /* Comportamiento de bloque */
      max-width: 100%; /* Máximo ancho del contenedor padre (.modal-content) */
      max-height: 100%; /* Máximo alto del contenedor padre (.modal-content) */
      width: auto; /* Ancho basado en contenido, respetando max-width */
      height: auto; /* Alto basado en contenido, respetando max-height */
      object-fit: contain; /* Escalar para caber manteniendo aspecto */
      cursor: zoom-in; /* Indica que se puede hacer zoom */
      transition: transform 0.2s ease; /* Para futuras interacciones de zoom con JS */
    }

    /* Ajustes responsivos para la sección de precios en el modal de edición */
    #priceContainer .price-row {
      flex-direction: column; /* Apilar elementos verticalmente */
      align-items: stretch; /* Estirar elementos al ancho completo */
      gap: 0.5rem; /* Reducir el espacio entre elementos */
      padding: 10px; /* Añadir un poco de padding */
    }
    #priceContainer .price-row select.price-company,
    #priceContainer .price-row input.price-value {
      width: 100%; /* Ocupar todo el ancho disponible */
    }
    #priceContainer .price-row button { /* Botón "Eliminar" */
      align-self: flex-end; /* Alinear el botón de eliminar a la derecha */
      padding: 12px 15px; /* Ajustado padding vertical a 12px */
      font-size: 0.85rem;
    }
    #priceSection button[type="button"] { /* Botón "Agregar Precio" */
      width: 100%; /* Hacerlo de ancho completo */
      margin-top: 0.75rem;
    }

    /* Estilo específico para cuando el select está enfocado, si es necesario */
    #editModal .form-group select:focus,
    #newProductModal .form-group select:focus {
      border-color: #007bff; /* Color de borde al enfocar */
      outline: none; /* Quitar outline por defecto */
    }
    
    /* Para asegurar que la flecha nativa se muestre si no se usa una personalizada */
    #editModal .form-group select:not([multiple]):not([size]),
    #newProductModal .form-group select:not([multiple]):not([size]) {
        background-image: linear-gradient(45deg, transparent 50%, gray 50%), linear-gradient(135deg, gray 50%, transparent 50%), linear-gradient(to right, #ccc, #ccc);
        background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px), calc(100% - 2.5em) 0.5em;
        background-size: 5px 5px, 5px 5px, 1px 1.5em;
        background-repeat: no-repeat;
    }
    

    #editModal .form-group textarea, #newProductModal .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.9rem;
      background-color: #fff;
      color: #333;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      margin-bottom: 15px; /* Más espacio entre grupos */
    }

    #editModal .form-group label, #newProductModal .form-group label {
      display: block;
      margin-bottom: 8px; /* Más espacio entre etiqueta y campo */
      color: #333;
      font-weight: bold;
      font-size: 0.9rem;
    }

    /* Estilos base para todos los campos de formulario en los modales */
    #editModal .form-group input,
    #editModal .form-group select,
    #editModal .form-group textarea,
    #newProductModal .form-group input,
    #newProductModal .form-group select,
    #newProductModal .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.9rem;
      background-color: #fff;
      color: #333;
      margin-bottom: 10px; /* Espacio general debajo de cada campo */
    }

    /* Quitar margen inferior extra si es el último elemento del grupo, o si se maneja diferente */
    #editModal .form-group > *:last-child,
    #newProductModal .form-group > *:last-child {
        margin-bottom: 0;
    }
    
    /* Estilos específicos para select para darles un look moderno con flecha personalizada */
    #editModal .form-group select,
    #newProductModal .form-group select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"%3E%3Cpath fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"%2F%3E%3C/svg%3E');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px; /* Espacio para la flecha */
    }

    /* Estilos de focus para los campos */
    #editModal .form-group input:focus,
    #editModal .form-group select:focus,
    #editModal .form-group textarea:focus,
    #newProductModal .form-group input:focus,
    #newProductModal .form-group select:focus,
    #newProductModal .form-group textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); /* Opcional: un brillo al enfocar */
    }

    /* Estilos por defecto para precios por compañía (escritorio) */
    #priceContainer .price-row {
      display: flex;
      flex-direction: row; /* Alineación horizontal */
      align-items: center; /* Centrar verticalmente - volvemos a esta estrategia */
      gap: 10px; /* Espacio entre elementos */
      margin-bottom: 10px; /* Espacio debajo de cada fila de precio */
    }

    #priceContainer .price-row select.price-company,
    #priceContainer .price-row input.price-value,
    #priceContainer .price-row button {
      height: 42px; /* Altura fija explícita para todos los elementos */
      box-sizing: border-box; /* Asegurar que padding y borde estén dentro */
    }

    #priceContainer .price-row select.price-company {
      flex: 2; /* Selector de compañía más ancho */
      /* Estilos generales de select ya aplicados (padding, borde, etc.) */
    }

    #priceContainer .price-row input.price-value {
      flex: 1; /* Campo de precio más estrecho */
      text-align: right; /* Alinear precio a la derecha */
      /* Estilos generales de input ya aplicados */
    }

    #priceContainer .price-row button { /* Botón "Eliminar" */
      padding: 0 15px; /* Solo padding horizontal, la altura es fija */
      flex-shrink: 0; /* Evitar que se encoja */
      background: #000; /* Asegurar el fondo negro consistente con otros botones */
      color: #fff; /* Asegurar texto blanco */
      border: none; /* Eliminar borde que pueda estar causando desplazamiento */
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative; /* Permitir ajuste de posición */
      top: -3px; /* Aumentar el desplazamiento hacia arriba */
    }

    /* Ajustes responsivos para la sección de precios en el modal de edición */
    @media (max-width: 768px) {
      #priceContainer .price-row {
        flex-direction: row; /* Cambiado a fila */
        align-items: center; /* Alinear verticalmente al centro */
        gap: 8px; /* Espacio entre elementos */
        padding: 0;
        margin-bottom: 10px; /* Reducir un poco el margen inferior */
      }
      #priceContainer .price-row select.price-company {
        width: auto; /* Quitar width 100% */
        flex: 3; /* Dar más espacio al select */
      }
      #priceContainer .price-row input.price-value {
        width: auto; /* Quitar width 100% */
        flex: 2; /* Dar espacio al input de precio */
        margin-bottom: 0; /* Quitar margen inferior ya que no está apilado */
        text-align: right;
      }
      #priceContainer .price-row button { /* Botón "Eliminar" con icono en móviles */
        align-self: auto; /* Quitar align-self */
        /* Los estilos de icono (tamaño, padding=0) vienen de la regla base del botón */
        width: 38px; /* Un poco más pequeño en móvil */
        height: 38px;
      }
      /* Estilo para el icono dentro del botón si es necesario ajustar específicamente para 768px */
      #priceContainer .price-row button .material-icons {
        font-size: 20px; /* Icono un poco más pequeño en móvil */
      }
    }
    /* El botón "Agregar Precio" (#priceSection button[type="button"]) sigue igual, ancho completo */
    #priceSection button[type="button"] { /* Botón "Agregar Precio" */
      width: 100%; /* Hacerlo de ancho completo */
      margin-top: 0.75rem;
    }

    /* New animation for view-options popup */
    @keyframes viewOptionsAppear {
      0% {
        opacity: 0;
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Estilos para el menú de opciones de vista */
    .view-options {
      position: absolute;
      top: 48px;
      right: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      width: 200px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      padding: 10px 0;
      z-index: 1500;
      display: none;
    }
    
    .view-options.show {
      display: block !important;
    }
    
    .view-options .view-option {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .view-options .view-option:hover {
      background-color: #f5f5f5;
    }
    
    .view-options hr {
      margin: 10px 0;
      border: none;
      border-top: 1px solid #eee;
    }

    /* Estilos para el menú de colecciones */
    .collections-menu {
      position: absolute;
      top: 48px;
      right: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      width: 280px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.18);
      display: none;
      z-index: 2000;
      padding: 10px 0;
    }
    
    .collections-menu.show {
      display: block;
    }
    
    /* Estilos para los elementos dentro del menú de colecciones */
    .collection-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: all 0.15s ease;
    }
    
    .collection-item:last-child {
      border-bottom: none;
    }
    
    .collection-item:hover {
      background: #f5f5f5;
    }
    
    .collection-item.active {
      background: #f0f0f0;
      font-weight: 600;
      box-shadow: inset 3px 0 0 #000;
    }
    
    .collection-item-name {
      flex-grow: 1;
      margin-right: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 0.95rem;
    }
    
    .collection-actions {
      display: flex;
      gap: 5px;
      opacity: 0.6;
      transition: opacity 0.2s ease;
    }
    
    .collection-item:hover .collection-actions {
      opacity: 1;
    }
    
    .collection-action-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 5px;
      color: #555;
      border-radius: 6px;
      transition: all 0.2s ease;
    }
    
    .collection-action-btn:hover {
      background: #e0e0e0;
      color: #000;
    }
    
    .new-collection-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      background: #f8f8f8;
      border-top: 1px solid #eee;
      cursor: pointer;
      font-weight: 500;
      color: #333;
      transition: all 0.2s ease;
    }
    
    .new-collection-btn:hover {
      background: #e9e9e9;
      color: #000;
    }

    /* Media query para ajustar el modal de imagen en pantallas pequeñas */
    @media (max-width: 600px) {
      #imageZoomModal .modal-content {
      justify-content: center;
      gap: 8px;
      padding: 14px;
      background: #f8f8f8;
      border-top: 1px solid #eee;
      cursor: pointer;
      font-weight: 500;
      color: #333;
      transition: all 0.2s ease;
    }
    .new-collection-btn:hover {
      background: #e9e9e9;
      color: #000;
    }
  } /* ESTA ES LA LLAVE DE CIERRE FALTANTE PARA @media (max-width: 600px) */
  </style>
</head>
<body>
  <!-- SPLASH -->
  <div id="splash" class="splash">
    <img class="logo" src="https://i.postimg.cc/DzmFHHq2/Beige-and-Black-Simple-Circle-Organic-Produce-Brand-Logo.png" alt="Logo Splash" />
  </div>

  <!-- CABECERA -->
  <div class="header">
    <div class="header-content">

      <!-- Nueva Fila Superior -->
      <div class="header-top-row">
        <div class="header-icon-group-left">
          <button class="header-icon-btn" onclick="openSettingsTab()" title="Ajustes">
            <span class="material-icons">settings</span> <!-- Cambiado de menu a settings -->
      </button>
          <button class="header-icon-btn store-icon-btn" title="Seleccionar Compañía" onclick="toggleCompanyPopup(event)">
            <span id="storeButtonIconContainer">
              <span class="material-icons">storefront</span>
            </span>
          </button>
        </div>

      <div class="search-bar">
        <span class="material-icons">search</span>
        <input type="text" id="searchInput" placeholder="Buscar producto..." oninput="updateSearch(this.value)" />
        <button class="clear-search-btn" onclick="clearSearch()" title="Limpiar búsqueda">
            <span class="material-icons">close</span>
        </button>
        </div>

        <div class="header-icon-group-right">
          <button class="header-icon-btn cart-icon-btn collections-menu-btn" onclick="toggleCollectionsMenu(event)" title="Seleccionar Colección">
            <span id="currentCollectionLogo"></span>
          </button>
          <div id="collectionsMenu" class="collections-menu"></div>
          <button class="header-icon-btn cart-icon-btn" id="infoBadgeBtn" onclick="openInfoBadgeModal(event)" type="button" title="Carrito">
          <span id="infoBadgeIcon" class="material-icons">shopping_cart</span>
          <span id="infoBadgeCount" class="info-badge-count">0</span>
        </button>
          <button class="header-icon-btn" onclick="toggleViewOptions()" title="Filtrar">
            <span class="material-icons">filter_list</span> <!-- Cambiado de settings a filter_list -->
        </button>
      </div>
      </div>

      <!-- El div.company-selector original se elimina. El popup se asocia al botón de tienda. -->
      <div id="companyPopup" class="company-popup"></div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="showTab('pedido')">Pedido</div>
        <div class="tab" onclick="showTab('orden')">Orden</div>
        <div class="tab" onclick="showTab('inventario')">Inventario</div>
      </div>
      
      <!-- Popup de opciones de vista (HTML se mantiene, el botón que lo activa cambió) -->
      <div id="viewOptions" class="view-options">
        <div class="view-option" onclick="setColumns(1)">
          <span class="material-icons">filter_1</span> 1 Columna
        </div>
        <div class="view-option" onclick="setColumns(2)">
          <span class="material-icons">filter_2</span> 2 Columnas
        </div>
        <div class="view-option" onclick="setColumns('pc')">
          <span class="material-icons">desktop_windows</span> PC/TABLETA
        </div>
        <hr/>
        <div class="view-option" onclick="setSortMode('byNumberAsc')">Código ↑</div>
        <div class="view-option" onclick="setSortMode('byNumberDesc')">Código ↓</div>
        <div class="view-option" onclick="setSortMode('byNameAsc')">Nombre A-Z</div>
        <div class="view-option" onclick="setSortMode('byNameDesc')">Nombre Z-A</div>
        <div class="view-option" onclick="setSortMode('byCustomOrder')">Orden Personalizado</div>
      </div>

      <!-- Chip de información de conteo (si se usa este ID en JS) -->
      <div class="info-chip-header-bottom">
        <div id="itemCountDisplay" class="info-chip"></div> <!-- Asegurarse que este ID es el usado en JS -->
      </div>

    </div>
  </div>

  <!-- CONTENIDO: Pestañas Pedido e Inventario -->
  <div class="content" id="pedidoTab">
    <div id="pedidoList" class="grid-pc"></div>
  </div>
  <div class="content" id="ordenTab" style="display:none;">
    <div id="ordenList" class="grid-pc"></div>
  </div>
  <div class="content" id="inventarioTab" style="display:none;">
    <div id="inventarioList" class="grid-pc"></div>
  </div>

  <!-- BOTONES FIJOS (ABAJO) -->
  <div class="buttons">
    <button onclick="openShareModal()" title="Compartir o Descargar Orden">
      <span class="material-icons">picture_as_pdf</span>
    </button>
    <button id="btnSendMessage" style="display:none;" onclick="openSendMessageModal()" title="Enviar Orden por Mensaje">
      <span class="material-icons">chat</span>
    </button>
    <button id="btnBorrarPedido" style="display:none;" onclick="openDeletePedidoModal()" title="Borrar Pedido">
      <span class="material-icons">delete</span>
    </button>
    <button id="btnBorrarInventario" style="display:none;" onclick="openDeleteInventarioModal()" title="Borrar Inventario">
      <span class="material-icons">delete</span>
    </button>
    <button onclick="addNewProduct()" title="Nuevo Producto">
      <span class="material-icons">add</span>
    </button>
    <button onclick="openExportModal()" title="Exportar Inventario">
      <span class="material-icons">save_alt</span>
    </button>
    <button onclick="triggerImport()" title="Importar Inventario">
      <span class="material-icons">file_open</span>
    </button>
    <input type="file" id="importFile" accept="application/json" style="display:none;" onchange="importInventoryFile(this.files[0])" />
  </div>

  <!-- PANEL DE AJUSTES MEJORADO -->
  <div id="settingsOverlay" onclick="closeSettingsTab()"></div>
  <div id="settingsTab">
    <div class="settings-header">
      <button class="back-button" onclick="closeSettingsTab()">
        <span class="material-icons">arrow_back</span>
      </button>
      <h2>Ajustes</h2>
    </div>
    <div class="settings-content">
      <p>Aquí puedes editar, eliminar o agregar opciones de la app.</p>
      <!-- Sección Unidades -->
      <div class="settings-section">
        <h4>Unidades</h4>
        <div id="unitsList"></div>
        <div class="add-row">
          <input type="text" id="newUnitInput" placeholder="Nueva unidad..." />
          <button class="icon-button" onclick="addUnit()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
      <!-- Sección Presentaciones -->
      <div class="settings-section">
        <h4>Presentaciones</h4>
        <div id="presentationsList"></div>
        <div class="add-row">
          <input type="text" id="newPresentationInput" placeholder="Nueva presentación..." />
          <button class="icon-button" onclick="addPresentation()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
      <!-- Sección Categorías -->
      <div class="settings-section">
        <h4>Categorías</h4>
        <div id="categoriesList"></div>
        <div class="add-row">
          <input type="text" id="newCategoryInput" placeholder="Nueva categoría..." />
          <button class="icon-button" onclick="addCategory()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
      <!-- Sección Margen de Ganancia -->
      <div class="settings-section">
        <h4>Margen de Ganancia</h4>
        <p style="text-align:left; margin-top:0; font-size:0.85rem; color:#555;">Define el porcentaje de margen para calcular el precio sugerido de venta.</p>
        <div class="margin-field">
          <label for="defaultMarginPercent">Porcentaje de margen:</label>
          <input type="number" id="defaultMarginPercent" min="0" max="999" step="0.1" value="45" onchange="saveDefaultMargin()" />
          <span class="percent">%</span>
        </div>
      </div>
      
      <!-- Sección Compañías -->
      <div class="settings-section">
        <h4>Compañías</h4>
        <div id="companiesList"></div>
        <div class="company-add-row">
          <input type="text" id="newCompanyName" placeholder="Nombre de la compañía..." />
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyLogoFile">Logo de la compañía (archivo):</label>
            <input type="file" id="newCompanyLogoFile" accept="image/*" />
          </div>
          <div style="margin-top: 8px;">
            <label>O</label>
          </div>
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyLogoUrl">URL del logo (alternativa):</label>
            <input type="text" id="newCompanyLogoUrl" placeholder="URL del logo" />
          </div>
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyPhone">Número de Teléfono (WhatsApp/SMS):</label>
            <input type="tel" id="newCompanyPhone" placeholder="Ej. +1234567890" />
          </div>
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyMessage">Mensaje Predeterminado (para órdenes):</label>
            <textarea id="newCompanyMessage" placeholder="Ej. Hola, te envío la orden de productos..." rows="3"></textarea>
          </div>
          <button class="icon-button" style="margin-top: 8px;" onclick="addCompany()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL Compartir/Descargar PDF -->
  <div id="shareModal" class="modal">
    <div class="modal-content">
      <h3>¿Qué deseas hacer?</h3>
      <div class="modal-buttons">
        <button onclick="sharePDF()" class="save-btn">COMPARTIR</button>
        <button onclick="downloadPDF()" class="save-btn">DESCARGAR</button>
        <button onclick="closeShareModal()" class="cancel-btn">CANCELAR</button>
      </div>
    </div>
  </div>

  <!-- MODAL AGREGAR/EDITAR PRODUCTO -->
  <div id="editModal" class="modal">
    <div class="modal-content modern-modal" style="max-height: calc(100vh - 40px); overflow-y: auto; position: relative; cursor: move;">
      <h3 id="editModalTitle" style="margin-bottom:0.5rem;">Nuevo Producto</h3>
      <div class="form-group">
        <label for="editName">Nombre del producto</label>
        <input type="text" id="editName" placeholder="Ej. CAMISETA" oninput="this.value=this.value.toUpperCase();" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="editNumber">Código/Referencia (opcional)</label>
          <input type="text" id="editNumber" placeholder="Ej. 101" />
        </div>
        <div class="form-group" style="position: relative; z-index: 500;">
          <label for="editUnit">Unidad</label>
          <select id="editUnit" style="position: relative; z-index: 500;"></select>
        </div>
      </div>
      <div class="form-group" style="position: relative; z-index: 450;">
        <label for="editPresentation">Etiqueta de Cantidad (Pedido)</label>
        <select id="editPresentation" style="position: relative; z-index: 450;"></select>
      </div>
      <div class="form-group">
        <label for="editCategory">Departamento / Categoría</label>
        <input type="text" id="editCategory" placeholder="Ej. Electrónica, Ropa, Alimentos..." />
      </div>
      <div class="form-group">
        <label for="editTags">Palabras Clave / Tags (separadas por comas)</label>
        <input type="text" id="editTags" placeholder="Ej. aluminio, desechable, cocina" />
      </div>
      <div class="form-group" style="position: relative; z-index: 400;">
        <label for="editCompany">Compañía</label>
        <select id="editCompany" style="position: relative; z-index: 400;"></select>
      </div>
      <div class="form-group">
        <label for="editStock">Stock</label>
        <input type="text" id="editStock" placeholder="Cantidad en stock" />
      </div>
      <div class="form-group">
        <label for="editCustomMargin">Margen personalizado</label>
        <div class="margin-type-selector">
          <div class="margin-type-option" style="flex: 1;"> <!-- Ajustar flex si es necesario -->
            <input type="radio" id="marginTypePercent" name="marginType" value="percent" checked>
            <label for="marginTypePercent">%</label>
          </div>
          <div class="margin-type-option" style="flex: 2;"> <!-- Ajustar flex si es necesario -->
            <input type="radio" id="marginTypeFixed" name="marginType" value="fixed">
            <label for="marginTypeFixed">Monto Fijo ($)</label>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <input type="number" id="editCustomMargin" placeholder="Usar margen general" style="flex:1;" step="0.01" />
          <button type="button" id="resetMarginBtn" style="background:transparent; color:#666; box-shadow:none; width:auto; height:auto; min-width:auto; padding:0 8px;" onclick="resetCustomMargin()">
            <span class="material-icons" style="font-size:18px;">refresh</span>
          </button>
        </div>
        <small style="color:#666; font-size:0.8rem; margin-top:3px; display:block;">Dejar vacío para usar el margen general</small>
      </div>
      <!-- Nueva sección para Orden Personalizado -->
      <div class="form-group" id="customOrderSection" style="position: relative; z-index: 350;">
        <label for="editCustomSortPosition">Posición en Orden Personalizado</label>
        <select id="editCustomSortPosition" style="position: relative; z-index: 350;">
          {/* Opciones se llenarán dinámicamente con JavaScript */}
        </select>
      </div>
      {/* Fin Nueva sección */}
      <!-- Información de la Caja -->
      <div class="form-group">
        <label>Información de la Caja</label>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="editUnidadesPorCaja">Unidades por caja</label>
            <input type="number" id="editUnidadesPorCaja" placeholder="Ej. 24" min="0" step="1" />
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="editPaquetesPorCaja">Paquetes por caja</label>
            <input type="number" id="editPaquetesPorCaja" placeholder="Ej. 4" min="0" step="1" />
          </div>
        </div>
      </div>
      
      <!-- Sección de Precios -->
      <div class="form-group" id="priceSection">
        <label>Precios por Compañía</label>
        <div id="priceContainer"></div>
        <button type="button" onclick="addPriceRow()" style="width: auto; height: auto; border-radius: 6px; padding: 8px 12px; margin-top: 10px; background: #333; color: white; text-align: center;">Agregar Precio</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="editImageFile">Seleccionar archivo</label>
          <input type="file" id="editImageFile" accept="image/*" />
        </div>
        <div class="form-group">
          <label for="editImageUrl">URL de la imagen</label>
          <input type="text" id="editImageUrl" placeholder="https://..." />
        </div>
      </div>
      <div class="modal-buttons">
        <button id="deleteProductBtn" onclick="deleteItem()" class="delete-btn" style="display:none; width: auto; height: auto;">Eliminar</button>
        <button onclick="closeModal()" class="cancel-btn">Cancelar</button>
        <button onclick="saveChanges()" class="save-btn">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFO DE PRODUCTO -->
  <div id="infoModal" class="info-modal">
    <div class="modal-content" style="padding:0; max-width:400px; overflow:hidden;">
      <div id="infoContent"></div>
      <div class="modal-buttons" style="margin:15px;">
        <button onclick="closeInfoModal()" class="cancel-btn">Cerrar</button>
      </div>
    </div>
  </div>
  
  <!-- MODAL CRÉDITOS -->
  <div id="creditModal" class="modal">
    <div class="modal-content modern-modal" style="max-width: 350px;">
      <h3>Agregar Crédito</h3>
      <div class="form-group" style="position: relative; z-index: 450;">
        <label for="creditPresentation">Etiqueta de Cantidad</label>
        <select id="creditPresentation" style="position: relative; z-index: 450;"></select>
      </div>
      <div class="form-group">
        <label for="creditQty">Cantidad</label>
        <input type="text" id="creditQty" inputmode="decimal" placeholder="Ej. 1, 1/2, 2.5" />
      </div>
      <div class="modal-buttons">
        <button onclick="closeCreditModal()" class="cancel-btn">Cancelar</button>
        <button onclick="saveCreditInfo()" class="save-btn">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL BORRAR PEDIDO -->
  <div id="deletePedidoModal" class="modal">
    <div class="modal-content" style="max-width:300px;">
      <h3>¿Borrar Cantidades de Pedido?</h3>
      <p>¿Estás seguro de que quieres borrar las cantidades de la sección Pedido?</p>
      <div class="modal-buttons">
        <button onclick="confirmDeletePedido()" class="delete-btn">Borrar</button>
        <button onclick="closeDeletePedidoModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL BORRAR INVENTARIO -->
  <div id="deleteInventarioModal" class="modal">
    <div class="modal-content" style="max-width:300px;">
      <h3>¿Borrar Cantidades de Inventario?</h3>
      <p>¿Estás seguro de que quieres borrar las cantidades de la sección Inventario?</p>
      <div class="modal-buttons">
        <button onclick="confirmDeleteInventario()" class="delete-btn">Borrar</button>
        <button onclick="closeDeleteInventarioModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL EXPORTAR JSON -->
  <div id="exportModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
      <h3>Exportar Inventario</h3>
      <p>¿Quieres exportar todo el inventario, imágenes y contenido de la app para usarla en otro dispositivo?</p>
      <div class="modal-buttons">
        <button onclick="confirmExport()" class="download-btn">Descargar</button>
        <button onclick="closeExportModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- DATALIST para cantidades rápidas -->
  <datalist id="numbers">
    <option value="1/2"></option>
    <option value="1"></option>
    <option value="2"></option>
    <option value="3"></option>
    <option value="4"></option>
    <option value="5"></option>
    <option value="6"></option>
    <option value="7"></option>
    <option value="8"></option>
    <option value="9"></option>
    <option value="10"></option>
  </datalist>

  <!-- MODAL ZOOM IMAGEN -->
  <div id="imageZoomModal" class="modal">
    <div class="modal-content">
      <img id="zoomedImage" src="" alt="Imagen Ampliada">
      <button onclick="closeImageZoomModal()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; border-radius:50%; width:30px; height:30px; font-size:18px; line-height:1; padding:0;">&times;</button>
    </div>
  </div>

  <!-- MODAL ENVIAR MENSAJE -->
  <div id="sendMessageModal" class="modal">
    <div class="modal-content modern-modal" style="max-width: 450px;">
      <h3 id="sendMessageModalTitle">Enviar Orden</h3>
      <div class="form-group">
        <label for="sendMessageText">Mensaje a enviar:</label>
        <textarea id="sendMessageText" rows="8" style="width:100%; font-size:0.9rem; padding:8px; border:1px solid #ccc; border-radius:6px;"></textarea>
      </div>
      <p id="sendOrderToInfo" style="font-size:0.85rem; color:#555; text-align:center; margin-bottom:10px;"></p>
      <div class="modal-buttons">
        <button onclick="sendViaSMS()" class="save-btn" style="background-color:#007bff;">SMS</button>
        <button onclick="sendViaWhatsApp()" class="save-btn" style="background-color:#25D366;">WhatsApp</button>
        <button onclick="closeSendMessageModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFO BADGE -->
  <div id="infoBadgeModal" class="modal">
    <div class="modal-content info-badge-modal-content">
      <div class="info-badge-modal-header">
        <span id="infoBadgeModalIcon" class="material-icons">shopping_cart</span>
        <!-- Botón de cierre eliminado -->
      </div>
      <div id="infoBadgeModalText" class="info-badge-modal-text-content">
        <!-- El texto se inyectará aquí vía JavaScript -->
      </div>
    </div>
  </div>

  <script>
    /* ===== FUNCIONES BÁSICAS ===== */

    // Función para parsear cantidades (puede manejar fracciones como "1/2" y decimales)
    function parseQuantity(value) {
      if (typeof value === 'number') {
        return value;
      }
      if (typeof value === 'string') {
        if (value.includes('/')) {
          const parts = value.split('/');
          if (parts.length === 2) {
            const num = parseFloat(parts[0]);
            const den = parseFloat(parts[1]);
            if (!isNaN(num) && !isNaN(den) && den !== 0) {
              return num / den;
            }
          }
        } else {
          const num = parseFloat(value);
          if (!isNaN(num)) {
            return num;
          }
        }
      }
      return 0; // Retornar 0 si no se puede parsear
    }

    // Función para formatear cantidades para visualización
    function formatQuantity(value) {
      if (typeof value !== 'number') {
        value = parseFloat(value) || 0;
      }
      // Si es un número entero, devolver como string
      if (Number.isInteger(value)) {
        return String(value);
      }
      // Si es .5, convertir a fracción X/2
      if (value % 1 === 0.5) {
        if (value === 0.5) return '1/2';
        const integerPart = Math.floor(value);
        if (integerPart === 0) return '1/2'; // Para 0.5 específicamente
        return `${integerPart * 2 + 1}/2`; // Ej: 1.5 -> 3/2, 2.5 -> 5/2
      }
      // Para otros decimales, redondear a 2 decimales (o ajustar según necesidad)
      return value.toFixed(2).replace(/\.?0+$/, ""); // Eliminar ceros innecesarios al final
    }

    // Deshabilitar la restauración de scroll automática del navegador
    if (history.scrollRestoration) {
      history.scrollRestoration = 'manual';
    }

    const APP_DEFAULT_LOGO = "https://i.postimg.cc/DzmFHHq2/Beige-and-Black-Simple-Circle-Organic-Produce-Brand-Logo.png";
    const UNITS_KEY = "allUnits_v2";
    const PRESENTATIONS_KEY = "allPresentations_v2";
    const CATEGORIES_KEY = "allCategories_v2";
    const COMPANIES_KEY = "allCompanies_v2";
    const ORDER_SYSTEM_MIGRATED_KEY = "orderSystemMigrated_v1"; // Nueva clave para la migración
    const COLLECTIONS_KEY = "productCollections"; // Nueva clave para las colecciones
    
    // Variables globales
    let allItems = {};
    let searchTerm = '';
    let currentCompanyFilter = '';
    let currentColumns = localStorage.getItem('currentColumns') || 'pc';
    let currentSortMode = localStorage.getItem('currentSortMode') || 'byNameAsc';
    let currentCollection = localStorage.getItem('currentCollection') || 'default'; // Colección actual
    let sortMode = currentSortMode; // Para mantener compatibilidad con código existente
    let currentEdit = null;
    let lastScrollPosition = 0;
    let currentOrderPDFFile = null; // Para almacenar el PDF generado para compartir

    // Inicialización
    function initApp() {
      try {
        console.log("Iniciando aplicación...");
        
        // Mostrar indicador de carga
        showLoadingIndicator();
        
        // Verificar si hay datos de recuperación de emergencia, pero no mostrar el mensaje automáticamente
        // Solo se cargará desde el botón de recuperación cuando sea necesario
        const emergencyData = localStorage.getItem('emergency_backup');
        // Dejamos el código comentado para referencia, pero no lo ejecutamos para evitar el mensaje constante
        /*
        if (emergencyData) {
          console.log("Datos de recuperación de emergencia encontrados, pero no se mostrarán automáticamente");
        }
        */
        
        // Si hay un error grave en la carga de datos, se mostrará el botón de recuperación más adelante
        
        // Migrar datos antiguos si es necesario
        const isOrderSystemMigrated = localStorage.getItem(ORDER_SYSTEM_MIGRATED_KEY);
        if (!isOrderSystemMigrated) {
          migrateOrderSystem();
        }
        
        // Inicializar sistema de colecciones si es necesario
        initCollectionsSystem();
        
        // Comprobar si hay datos en allItems
        if (!allItems || Object.keys(allItems).length === 0) {
          console.log("Variable allItems vacía, intentando cargar datos...");
          
          // Restaurar la colección actual
          currentCollection = localStorage.getItem('currentCollection') || 'default';
          
          // Cargar datos de la colección actual
          const collection = getCurrentCollection();
          if (collection && collection.items) {
            try {
              console.log("Cargando desde colección actual:", currentCollection);
              allItems = JSON.parse(collection.items);
              console.log("Datos cargados:", Object.keys(allItems).length, "elementos");
              
              // Solo crear copia de seguridad de emergencia si hay productos
              if (Object.keys(allItems).length > 0) {
                // Usar una clave temporal que se borrará después de cada sesión
                sessionStorage.setItem('temp_backup', collection.items);
                console.log("Copia de seguridad temporal creada:", Object.keys(allItems).length, "elementos");
              }
            } catch (e) {
              console.error("Error al cargar los datos de la colección:", e);
              allItems = {};
            }
          } else {
            console.warn("No se encontró una colección válida");
          }
      }

      // Restaurar filtros guardados
      restoreFiltersAndState();
      
      // *** Nueva: Migración del sistema de ordenamiento ***
      migrateOrderSystem();
      // *** Fin Nueva Migración ***

        // Verificar si hay elementos cargados
        console.log("Inventario actual:", Object.keys(allItems).length, "elementos");
        
        // Cargar inventario en la UI
      renderTabs(); // Renderiza el contenido, pero las listas están opacity 0 debido a showTab y CSS
      updateDeleteButtons();
        
        // Actualizar visualización de la compañía y colección actual
        updateCurrentCompanyLogo(); 
        updateCurrentCollectionDisplay();
      
      // Restaurar posición de desplazamiento después de renderizar
        setTimeout(function() {
          const scrollPos = localStorage.getItem('scrollPos') || 0;
          window.scrollTo(0, scrollPos);
          
          // Ocultar indicador de carga
          hideLoadingIndicator();
          
          // Mostrar notificación de bienvenida con el nombre de la colección
          const collection = getCurrentCollection();
          if (collection) {
            showNotification(`Colección "${collection.name}" cargada correctamente`);
          }
          
          // Verificar si se ha podido cargar el inventario
          if (!allItems || Object.keys(allItems).length === 0) {
            // Mostrar botón especial para ayudar a recuperar datos
            showRecoveryButton();
          }
          adjustContentMargin(); // <--- LLAMAR A LA FUNCIÓN AQUÍ
        }, 300);
        
        // Cargar el contenido de la pestaña activa por defecto (Pedido)
        showTab('pedido');
      } catch (error) {
        console.error("Error durante la inicialización:", error);
        hideLoadingIndicator();
        alert("Hubo un problema al iniciar la aplicación. Por favor, recarga la página.");
        
        // Mostrar botón de recuperación
        showRecoveryButton();
      }
    }
    
    // Función para mostrar un botón de recuperación de datos
    function showRecoveryButton() {
      // Si ya existe, no crear otro
      if (document.getElementById('recovery-button')) return;
      
      // Crear el botón
      const button = document.createElement('button');
      button.id = 'recovery-button';
      button.innerHTML = '🔄 Recuperar datos';
      button.style.position = 'fixed';
      button.style.top = '10px';
      button.style.right = '10px';
      button.style.zIndex = '9999';
      button.style.backgroundColor = '#ff3b30';
      button.style.color = 'white';
      button.style.border = 'none';
      button.style.borderRadius = '8px';
      button.style.padding = '8px 15px';
      button.style.fontWeight = 'bold';
      button.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
      button.style.cursor = 'pointer';
      
      // Añadir evento de clic
      button.onclick = function() {
        // Método de recuperación 0: Usar datos de emergencia si existen
        const emergencyData = localStorage.getItem('emergency_backup');
        if (emergencyData && emergencyData !== '{}' && emergencyData !== 'null') {
          try {
            const parsed = JSON.parse(emergencyData);
            if (Object.keys(parsed).length > 0) {
              const confirmEmergency = confirm(`Se encontraron ${Object.keys(parsed).length} elementos en la copia de seguridad de emergencia. ¿Deseas restaurarlos?`);
              
              if (confirmEmergency) {
                allItems = parsed;
                
                // Guardar en colección actual
                currentCollection = localStorage.getItem('currentCollection') || 'default';
                const collections = getCollections();
                
                if (collections[currentCollection]) {
                  collections[currentCollection].items = emergencyData;
                  collections[currentCollection].lastModified = new Date().toISOString();
                  collections[currentCollection].recoveredFromEmergency = true;
                  saveCollections(collections);
                  
                  // Limpiar la copia de emergencia para evitar solicitudes futuras
                  localStorage.removeItem('emergency_backup');
                  
                  // Actualizar UI
                  renderTabs();
                  
                  alert('Datos restaurados correctamente desde la copia de emergencia');
                  button.style.display = 'none';
                  return;
                }
              }
            }
          } catch (e) {
            console.error("Error al restaurar datos de emergencia:", e);
          }
        }
        
        // Método de recuperación 1: Importar desde el almacenamiento local antiguo
        const oldInventory = localStorage.getItem('inventory_v2_moderno');
        if (oldInventory && oldInventory !== '{}' && oldInventory !== 'null') {
          try {
            const parsed = JSON.parse(oldInventory);
            if (Object.keys(parsed).length > 0) {
              const confirm1 = confirm(`Se encontraron ${Object.keys(parsed).length} elementos en el almacenamiento antiguo. ¿Deseas recuperarlos?`);
              
              if (confirm1) {
                allItems = parsed;
                
                // Guardar en la colección actual
                saveCurrentItemsToCollection(parsed);
                
                // Actualizar UI
                renderTabs();
                
                alert('Datos recuperados correctamente');
                button.style.display = 'none';
                return;
              }
            }
          } catch (e) {
            console.error("Error al recuperar desde almacenamiento antiguo:", e);
          }
        }
        
        // Método de recuperación 2: Crear una nueva colección
        const confirm2 = confirm("¿Deseas crear una nueva colección vacía? Esto puede ayudar si la colección actual está dañada.");
        
        if (confirm2) {
          createNewCollection();
          button.style.display = 'none';
        }
      };
      
      // Añadir al documento
      document.body.appendChild(button);
    }

    // Inicialización del sistema de colecciones
    function initCollectionsSystem() {
      // Comprobar si ya existe estructura de colecciones
      let collections = localStorage.getItem(COLLECTIONS_KEY);
      
      if (!collections) {
        try {
          console.log("Creando estructura de colecciones inicial...");
          
          // Intentar migrar datos existentes de varias fuentes posibles
          let initialData = '{}';
          
          // Intentar cargar desde 'allItems' (formato antiguo)
          const allItemsOld = localStorage.getItem('allItems');
          if (allItemsOld && allItemsOld !== '{}' && allItemsOld !== 'null') {
            console.log("Usando datos de 'allItems'");
            initialData = allItemsOld;
          } 
          // Si no hay datos en 'allItems', intentar con 'inventory_v2_moderno'
          else {
            const inventoryData = localStorage.getItem('inventory_v2_moderno');
            if (inventoryData && inventoryData !== '{}' && inventoryData !== 'null') {
              console.log("Usando datos de 'inventory_v2_moderno'");
              initialData = inventoryData;
            }
          }
          
          // Crear colección por defecto con los datos obtenidos
          const defaultCollection = {
            name: 'Principal',
            items: initialData,
            created: new Date().toISOString(),
            lastModified: new Date().toISOString()
          };
          
          const collectionsObj = {
            default: defaultCollection
          };
          
          // Guardar la estructura de colecciones y establecer 'default' como actual
          localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collectionsObj));
          localStorage.setItem('currentCollection', 'default');
          
          // Cargar explícitamente los datos de la colección predeterminada en allItems
          try {
            allItems = JSON.parse(initialData);
            console.log("Datos cargados en allItems", Object.keys(allItems).length, "elementos");
          } catch (e) {
            console.error("Error al parsear datos iniciales:", e);
            allItems = {};
          }
        } catch (e) {
          console.error("Error al inicializar sistema de colecciones:", e);
          // Crear una colección vacía como fallback
          const emptyCollection = {
            default: {
              name: 'Principal',
              items: '{}',
              created: new Date().toISOString(),
              lastModified: new Date().toISOString()
            }
          };
          localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(emptyCollection));
          localStorage.setItem('currentCollection', 'default');
          allItems = {};
        }
      } else {
        // Cargar la colección actual
        const currentId = localStorage.getItem('currentCollection') || 'default';
        try {
          const parsed = JSON.parse(collections);
          if (parsed[currentId] && parsed[currentId].items) {
            allItems = JSON.parse(parsed[currentId].items);
            console.log("Cargada colección existente:", currentId, "con", Object.keys(allItems).length, "elementos");
          }
        } catch (e) {
          console.error("Error al cargar colección existente:", e);
        }
      }
      
      // Construir el menú de colecciones
      buildCollectionsMenu();
    }

    // Construir el menú desplegable de colecciones
    function buildCollectionsMenu() {
      const menu = document.getElementById('collectionsMenu');
      if (!menu) {
        console.error('Error: No se encontró el menú de colecciones');
        return;
      }
      
      menu.innerHTML = '';
      console.log('Construyendo menú de colecciones...');
      
      // Añadir el nombre de la colección actual al inicio del menú
      const currentCollection = getCurrentCollection();
      if (currentCollection) {
        const currentCollectionHeader = document.createElement('div');
        currentCollectionHeader.className = 'current-collection-header';
        currentCollectionHeader.style.padding = '12px 15px';
        currentCollectionHeader.style.borderBottom = '1px solid #eee';
        currentCollectionHeader.style.fontWeight = 'bold';
        currentCollectionHeader.style.display = 'flex';
        currentCollectionHeader.style.alignItems = 'center';
        currentCollectionHeader.style.gap = '8px';
        
        // Añadir logo si existe
        if (currentCollection.logoUrl) {
          const logoImg = document.createElement('img');
          logoImg.src = currentCollection.logoUrl;
          logoImg.alt = currentCollection.name;
          logoImg.style.width = '24px';
          logoImg.style.height = '24px';
          logoImg.style.borderRadius = '4px';
          logoImg.style.objectFit = 'contain';
          currentCollectionHeader.appendChild(logoImg);
        }
        
        const nameText = document.createTextNode(currentCollection.name);
        currentCollectionHeader.appendChild(nameText);
        
        menu.appendChild(currentCollectionHeader);
      }
      
      const collections = getCollections();
      const currentCollectionId = localStorage.getItem('currentCollection') || 'default';
      
      // Añadir cada colección al menú
      Object.entries(collections).forEach(([id, collection]) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'collection-item';
        if (id === currentCollectionId) {
          itemDiv.classList.add('active');
        }
        
        // Contenedor para logo y nombre
        const infoContainer = document.createElement('div');
        infoContainer.className = 'collection-info';
        infoContainer.style.display = 'flex';
        infoContainer.style.alignItems = 'center';
        infoContainer.style.gap = '8px';
        infoContainer.style.cursor = 'pointer';
        infoContainer.onclick = (e) => {
          e.stopPropagation();
          selectCollection(id);
        };
        
        // Logo de la colección (si existe)
        if (collection.logoUrl) {
          const logoImg = document.createElement('img');
          logoImg.src = collection.logoUrl;
          logoImg.alt = collection.name;
          logoImg.style.width = '24px';
          logoImg.style.height = '24px';
          logoImg.style.borderRadius = '4px';
          logoImg.style.objectFit = 'contain';
          infoContainer.appendChild(logoImg);
        }
        
        // Nombre de la colección
        const nameSpan = document.createElement('span');
        nameSpan.className = 'collection-item-name';
        nameSpan.textContent = collection.name;
        
        infoContainer.appendChild(nameSpan);
        
        // Acciones (renombrar, duplicar, eliminar)
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'collection-actions';
        
        // Botón renombrar
        const renameBtn = document.createElement('button');
        renameBtn.className = 'collection-action-btn';
        renameBtn.innerHTML = '<span class="material-icons" style="font-size:18px;">edit</span>';
        renameBtn.title = 'Editar';
        renameBtn.onclick = (e) => {
          e.stopPropagation();
          renameCollection(id);
        };
        
        // Botón duplicar
        const duplicateBtn = document.createElement('button');
        duplicateBtn.className = 'collection-action-btn';
        duplicateBtn.innerHTML = '<span class="material-icons" style="font-size:18px;">content_copy</span>';
        duplicateBtn.title = 'Duplicar';
        duplicateBtn.onclick = (e) => {
          e.stopPropagation();
          duplicateCollection(id);
        };
        
        // Botón eliminar (solo si hay más de una colección)
        if (Object.keys(collections).length > 1) {
          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'collection-action-btn';
          deleteBtn.innerHTML = '<span class="material-icons" style="font-size:18px;">delete</span>';
          deleteBtn.title = 'Eliminar';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deleteCollection(id);
          };
          actionsDiv.appendChild(deleteBtn);
        }
        
        // Añadir botones a div de acciones
        actionsDiv.appendChild(renameBtn);
        actionsDiv.appendChild(duplicateBtn);
        
        // Añadir elementos al item
        itemDiv.appendChild(infoContainer);
        itemDiv.appendChild(actionsDiv);
        
        // Añadir item al menú
        menu.appendChild(itemDiv);
      });
      
      // Añadir botón Nueva Colección
      const newCollectionBtn = document.createElement('div');
      newCollectionBtn.className = 'new-collection-btn';
      newCollectionBtn.innerHTML = '<span class="material-icons" style="font-size:18px;">add</span> Nueva Colección';
      newCollectionBtn.onclick = (e) => {
        e.stopPropagation();
        createNewCollection();
      };
      
      menu.appendChild(newCollectionBtn);
    }

    // Mostrar/ocultar menú de colecciones
    function toggleCollectionsMenu(event) {
      if (event) {
        event.stopPropagation();
      }
      
      const menu = document.getElementById('collectionsMenu');
      if (!menu) {
        console.error('Error: No se encontró el elemento collectionsMenu');
        return;
      }
      
      menu.classList.toggle('show');
      
      // Registrar el estado para debugging
      console.log('Estado del menú de colecciones:', menu.classList.contains('show') ? 'visible' : 'oculto');
      
      if (menu.classList.contains('show')) {
        try {
          buildCollectionsMenu();
          
          // Agregar event listener para cerrar el menú al hacer clic en cualquier otro lugar
          document.addEventListener('click', closeCollectionsMenuOutside);
        } catch (e) {
          console.error('Error al construir el menú de colecciones:', e);
        }
      } else {
        // Quitar el event listener cuando se cierra el menú
        document.removeEventListener('click', closeCollectionsMenuOutside);
      }
    }
    
    // Función para cerrar el menú al hacer clic fuera de él
    function closeCollectionsMenuOutside(event) {
      const menu = document.getElementById('collectionsMenu');
      const button = document.querySelector('.collections-menu-btn');
      
      // Si se hace clic fuera del menú y fuera del botón, cerrar el menú
      if (menu && !menu.contains(event.target) && !button.contains(event.target)) {
        menu.classList.remove('show');
        document.removeEventListener('click', closeCollectionsMenuOutside);
        console.log('Menú de colecciones cerrado por clic externo');
      }
    }

    // Obtener todas las colecciones
    function getCollections() {
      const collectionsStr = localStorage.getItem(COLLECTIONS_KEY);
      return collectionsStr ? JSON.parse(collectionsStr) : {};
    }

    // Obtener la colección actual
    function getCurrentCollection() {
      const collectionId = localStorage.getItem('currentCollection') || 'default';
      const collections = getCollections();
      return collections[collectionId] || null;
    }

    // Guardar colecciones en localStorage
    function saveCollections(collections) {
      localStorage.setItem(COLLECTIONS_KEY, JSON.stringify(collections));
    }

    // Seleccionar una colección
    function selectCollection(id) {
      const collections = getCollections();
      if (!collections[id]) return;
      
      try {
        // Mostrar un indicador de carga
        showLoadingIndicator();
        
        // Guardar los datos actuales en la colección actual antes de cambiar
        saveCurrentItemsToCollection();
        
        // Cambiar a la nueva colección
        localStorage.setItem('currentCollection', id);
        
        // Cargar datos de la nueva colección
        const newCollectionData = collections[id].items || '{}';
        allItems = JSON.parse(newCollectionData);
        
        // Actualizar la interfaz de usuario
        toggleCollectionsMenu();
        updateCurrentCollectionDisplay();
        
        // Cambiar a la pestaña "Pedido" por defecto para mantener la coherencia
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.tab:first-child').classList.add('active');
        
        // Renderizar las pestañas con la nueva colección
        renderTabs();
        
        // Actualizar contadores y badges
        updateInfoBadge();
        
        // Notificar el cambio
        showNotification(`Colección "${collections[id].name}" cargada correctamente`);
      } catch (error) {
        console.error("Error al cambiar de colección:", error); // IMPRIMIR EL ERROR ESPECÍFICO
        alert("Hubo un problema al cargar la colección. Por favor, intente nuevamente.");
      } finally {
        // Ocultar el indicador de carga
        hideLoadingIndicator();
      }
    }
    
    // Función para mostrar notificación temporal
    function showNotification(message, duration = 2000) {
      // Eliminar notificación anterior si existe
      const existingNotification = document.getElementById('temp-notification');
      if (existingNotification) {
        document.body.removeChild(existingNotification);
      }
      
      // Crear nueva notificación
      const notification = document.createElement('div');
      notification.id = 'temp-notification';
      notification.style.position = 'fixed';
      notification.style.bottom = '20px';
      notification.style.left = '50%';
      notification.style.transform = 'translateX(-50%)';
      notification.style.backgroundColor = 'rgba(0,0,0,0.8)';
      notification.style.color = 'white';
      notification.style.padding = '10px 20px';
      notification.style.borderRadius = '20px';
      notification.style.zIndex = '9999';
      notification.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      notification.style.animation = 'fadeInOut 2s ease-in-out';
      notification.textContent = message;
      
      // Añadir a la página
      document.body.appendChild(notification);
      
      // Eliminar después de la duración
      setTimeout(() => {
        if (notification.parentNode) {
          document.body.removeChild(notification);
        }
      }, duration);
    }
    
    // Indicador de carga
    function showLoadingIndicator() {
      const loader = document.createElement('div');
      loader.id = 'app-loader';
      loader.style.position = 'fixed';
      loader.style.top = '0';
      loader.style.left = '0';
      loader.style.width = '100%';
      loader.style.height = '100%';
      loader.style.backgroundColor = 'rgba(255,255,255,0.7)';
      loader.style.display = 'flex';
      loader.style.justifyContent = 'center';
      loader.style.alignItems = 'center';
      loader.style.zIndex = '9999';
      
      const spinnerContainer = document.createElement('div');
      spinnerContainer.style.width = '80px';
      spinnerContainer.style.height = '80px';
      spinnerContainer.style.borderRadius = '50%';
      spinnerContainer.style.background = 'white';
      spinnerContainer.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
      spinnerContainer.style.display = 'flex';
      spinnerContainer.style.justifyContent = 'center';
      spinnerContainer.style.alignItems = 'center';
      
      const spinner = document.createElement('div');
      spinner.style.width = '40px';
      spinner.style.height = '40px';
      spinner.style.border = '3px solid #f3f3f3';
      spinner.style.borderTop = '3px solid #000';
      spinner.style.borderRadius = '50%';
      spinner.style.animation = 'spin 1s linear infinite';
      
      // Añadir la regla de animación si no existe
      if (!document.getElementById('loader-animation')) {
        const style = document.createElement('style');
        style.id = 'loader-animation';
        style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
        document.head.appendChild(style);
      }
      
      spinnerContainer.appendChild(spinner);
      loader.appendChild(spinnerContainer);
      document.body.appendChild(loader);
    }
    
    function hideLoadingIndicator() {
      const loader = document.getElementById('app-loader');
      if (loader) {
        document.body.removeChild(loader);
      }
    }

    // Guardar los items actuales en la colección actual
    function saveCurrentItemsToCollection(itemsToSave) {
      const collectionId = localStorage.getItem('currentCollection') || 'default';
      const collections = getCollections();
      
      if (collections[collectionId]) {
        try {
          // Si se pasaron items específicos, guardar esos, sino usar allItems global
          const itemsData = itemsToSave || allItems;
          const jsonData = JSON.stringify(itemsData);
          
          collections[collectionId].items = jsonData;
          collections[collectionId].lastModified = new Date().toISOString();
          saveCollections(collections);
          
          // En caso de error, guardar una copia de seguridad solo en sessionStorage
          // Esto evita que aparezca el mensaje molesto en cada carga
          if (Object.keys(itemsData).length > 0) {
            sessionStorage.setItem('temp_backup', jsonData);
          }
          
          // Eliminar cualquier respaldo de emergencia si el guardado fue exitoso
          if (localStorage.getItem('emergency_backup')) {
            localStorage.removeItem('emergency_backup');
          }
        } catch (e) {
          console.error("Error al guardar la colección:", e);
          // Solo en caso de error grave, crear una copia de emergencia real
          localStorage.setItem('emergency_backup', JSON.stringify(itemsToSave || allItems));
        }
      }
    }

    // Actualizar el logo mostrado de la colección actual
    function updateCurrentCollectionDisplay() {
      // Obtenemos el botón de colecciones y el contenedor del logo
      const collectionBtn = document.querySelector('.collections-menu-btn');
      const logoContainer = document.getElementById('currentCollectionLogo');
      if (!collectionBtn || !logoContainer) return;
      
      // Limpiar el contenedor del logo
      logoContainer.innerHTML = '';
      
      const collection = getCurrentCollection();
      if (collection) {
        // Actualizar el título del botón con el nombre de la colección
        collectionBtn.title = `Colección: ${collection.name}`;
        
        // Mostrar el logo o un icono por defecto
        if (collection.logoUrl) {
          // Si hay un logo, lo mostramos
          const logoImg = document.createElement('img');
          logoImg.src = collection.logoUrl;
          logoImg.alt = collection.name;
          logoImg.style.width = '26px';
          logoImg.style.height = '26px';
          logoImg.style.borderRadius = '4px';
          logoImg.style.objectFit = 'contain';
          logoContainer.appendChild(logoImg);
        } else {
          // Si no hay logo, mostramos un icono de carpeta
          const folderIcon = document.createElement('span');
          folderIcon.className = 'material-icons';
          folderIcon.textContent = 'folder';
          logoContainer.appendChild(folderIcon);
        }
      }
    }

    // Crear una nueva colección
    function createNewCollection() {
      // Crear un modal personalizado para crear la colección
      const modal = document.createElement('div');
      modal.className = 'modern-modal';
      modal.id = 'newCollectionModal';
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      
      // Contenido del modal
      const content = document.createElement('div');
      content.className = 'modal-content';
      content.style.backgroundColor = '#fff';
      content.style.borderRadius = '12px';
      content.style.padding = '20px';
      content.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
      content.style.width = '90%';
      content.style.maxWidth = '400px';
      
      // Título
      const title = document.createElement('h3');
      title.textContent = 'Nueva Colección';
      title.style.marginTop = '0';
      title.style.marginBottom = '15px';
      
      // Campo de nombre
      const nameGroup = document.createElement('div');
      nameGroup.className = 'form-group';
      nameGroup.style.marginBottom = '15px';
      
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'Nombre:';
      nameLabel.style.display = 'block';
      nameLabel.style.marginBottom = '5px';
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = 'Nueva Colección';
      nameInput.style.width = '100%';
      nameInput.style.padding = '8px';
      nameInput.style.border = '1px solid #ddd';
      nameInput.style.borderRadius = '8px';
      
      nameGroup.appendChild(nameLabel);
      nameGroup.appendChild(nameInput);
      
      // Campo de logo URL
      const logoGroup = document.createElement('div');
      logoGroup.className = 'form-group';
      logoGroup.style.marginBottom = '15px';
      
      const logoLabel = document.createElement('label');
      logoLabel.textContent = 'URL del Logo (opcional):';
      logoLabel.style.display = 'block';
      logoLabel.style.marginBottom = '5px';
      
      const logoInput = document.createElement('input');
      logoInput.type = 'text';
      logoInput.placeholder = 'https://ejemplo.com/imagen.png';
      logoInput.style.width = '100%';
      logoInput.style.padding = '8px';
      logoInput.style.border = '1px solid #ddd';
      logoInput.style.borderRadius = '8px';
      
      logoGroup.appendChild(logoLabel);
      logoGroup.appendChild(logoInput);
      
      // Opción para copiar datos
      const copyGroup = document.createElement('div');
      copyGroup.className = 'form-group';
      copyGroup.style.marginBottom = '15px';
      
      const copyCheckbox = document.createElement('input');
      copyCheckbox.type = 'checkbox';
      copyCheckbox.id = 'copyDataCheckbox';
      copyCheckbox.style.marginRight = '8px';
      
      const copyLabel = document.createElement('label');
      copyLabel.htmlFor = 'copyDataCheckbox';
      copyLabel.textContent = 'Copiar datos de la colección actual';
      
      copyGroup.appendChild(copyCheckbox);
      copyGroup.appendChild(copyLabel);
      
      // Botones
      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'modal-buttons';
      buttonsDiv.style.display = 'flex';
      buttonsDiv.style.justifyContent = 'flex-end';
      buttonsDiv.style.gap = '10px';
      buttonsDiv.style.marginTop = '20px';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancelar';
      cancelBtn.style.padding = '8px 15px';
      cancelBtn.style.background = '#f5f5f5';
      cancelBtn.style.border = 'none';
      cancelBtn.style.borderRadius = '8px';
      cancelBtn.style.cursor = 'pointer';
      
      const createBtn = document.createElement('button');
      createBtn.textContent = 'Crear';
      createBtn.style.padding = '8px 15px';
      createBtn.style.background = '#000';
      createBtn.style.color = '#fff';
      createBtn.style.border = 'none';
      createBtn.style.borderRadius = '8px';
      createBtn.style.cursor = 'pointer';
      
      buttonsDiv.appendChild(cancelBtn);
      buttonsDiv.appendChild(createBtn);
      
      // Agregar todo al modal
      content.appendChild(title);
      content.appendChild(nameGroup);
      content.appendChild(logoGroup);
      content.appendChild(copyGroup);
      content.appendChild(buttonsDiv);
      modal.appendChild(content);
      
      // Agregar modal al body
      document.body.appendChild(modal);
      document.body.classList.add('body-modal-open');
      
      // Eventos
      cancelBtn.onclick = function() {
        document.body.removeChild(modal);
        document.body.classList.remove('body-modal-open');
      };
      
      createBtn.onclick = function() {
        const name = nameInput.value.trim();
        const logoUrl = logoInput.value.trim();
        const shouldCopyItems = copyCheckbox.checked;
        
        if (!name) {
          alert('Por favor ingresa un nombre válido.');
          return;
        }
        
        // Guardar el inventario actual primero
        saveCurrentItemsToCollection();
        
        const collections = getCollections();
        const newId = 'col_' + Date.now();
        
        let initialItems = '{}';
        if (shouldCopyItems) {
          // Copiar los datos actuales
          initialItems = JSON.stringify(getAllItems());
        }
        
        collections[newId] = {
          name: name,
          logoUrl: logoUrl || null,
          items: initialItems,
          created: new Date().toISOString(),
          lastModified: new Date().toISOString()
        };
        
        saveCollections(collections);
        
        selectCollection(newId);
        
        document.body.removeChild(modal);
        document.body.classList.remove('body-modal-open');
        
        // Notificar creación exitosa
        showNotification(`Colección "${name}" creada exitosamente.`);
      };
    }

    // Renombrar una colección y configurar su logo
    function renameCollection(id) {
      const collections = getCollections();
      if (!collections[id]) return;
      
      // Crear un modal personalizado para editar la colección
      const modal = document.createElement('div');
      modal.className = 'modern-modal';
      modal.id = 'editCollectionModal';
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
      modal.style.display = 'flex';
      modal.style.justifyContent = 'center';
      modal.style.alignItems = 'center';
      modal.style.zIndex = '9999';
      
      // Contenido del modal
      const content = document.createElement('div');
      content.className = 'modal-content';
      content.style.backgroundColor = '#fff';
      content.style.borderRadius = '12px';
      content.style.padding = '20px';
      content.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
      content.style.width = '90%';
      content.style.maxWidth = '400px';
      
      // Título
      const title = document.createElement('h3');
      title.textContent = 'Editar Colección';
      title.style.marginTop = '0';
      title.style.marginBottom = '15px';
      
      // Campo de nombre
      const nameGroup = document.createElement('div');
      nameGroup.className = 'form-group';
      nameGroup.style.marginBottom = '15px';
      
      const nameLabel = document.createElement('label');
      nameLabel.textContent = 'Nombre:';
      nameLabel.style.display = 'block';
      nameLabel.style.marginBottom = '5px';
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = collections[id].name;
      nameInput.style.width = '100%';
      nameInput.style.padding = '8px';
      nameInput.style.border = '1px solid #ddd';
      nameInput.style.borderRadius = '8px';
      
      nameGroup.appendChild(nameLabel);
      nameGroup.appendChild(nameInput);
      
      // Campo de logo URL
      const logoGroup = document.createElement('div');
      logoGroup.className = 'form-group';
      logoGroup.style.marginBottom = '15px';
      
      const logoLabel = document.createElement('label');
      logoLabel.textContent = 'URL del Logo (opcional):';
      logoLabel.style.display = 'block';
      logoLabel.style.marginBottom = '5px';
      
      const logoInput = document.createElement('input');
      logoInput.type = 'text';
      logoInput.value = collections[id].logoUrl || '';
      logoInput.placeholder = 'https://ejemplo.com/imagen.png';
      logoInput.style.width = '100%';
      logoInput.style.padding = '8px';
      logoInput.style.border = '1px solid #ddd';
      logoInput.style.borderRadius = '8px';
      
      logoGroup.appendChild(logoLabel);
      logoGroup.appendChild(logoInput);
      
      // Botones
      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'modal-buttons';
      buttonsDiv.style.display = 'flex';
      buttonsDiv.style.justifyContent = 'flex-end';
      buttonsDiv.style.gap = '10px';
      buttonsDiv.style.marginTop = '20px';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = 'Cancelar';
      cancelBtn.style.padding = '8px 15px';
      cancelBtn.style.background = '#f5f5f5';
      cancelBtn.style.border = 'none';
      cancelBtn.style.borderRadius = '8px';
      cancelBtn.style.cursor = 'pointer';
      
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'Guardar';
      saveBtn.style.padding = '8px 15px';
      saveBtn.style.background = '#000';
      saveBtn.style.color = '#fff';
      saveBtn.style.border = 'none';
      saveBtn.style.borderRadius = '8px';
      saveBtn.style.cursor = 'pointer';
      
      buttonsDiv.appendChild(cancelBtn);
      buttonsDiv.appendChild(saveBtn);
      
      // Agregar todo al modal
      content.appendChild(title);
      content.appendChild(nameGroup);
      content.appendChild(logoGroup);
      content.appendChild(buttonsDiv);
      modal.appendChild(content);
      
      // Agregar modal al body
      document.body.appendChild(modal);
      document.body.classList.add('body-modal-open');
      
      // Eventos
      cancelBtn.onclick = function() {
        document.body.removeChild(modal);
        document.body.classList.remove('body-modal-open');
      };
      
      saveBtn.onclick = function() {
        const newName = nameInput.value.trim();
        const logoUrl = logoInput.value.trim();
        
        if (!newName) {
          alert('Por favor ingresa un nombre válido.');
          return;
        }
        
        collections[id].name = newName;
        collections[id].logoUrl = logoUrl || null;
        collections[id].lastModified = new Date().toISOString();
        
        saveCollections(collections);
        
        // Si es la colección actual, actualizar el display
        if (id === (localStorage.getItem('currentCollection') || 'default')) {
          updateCurrentCollectionDisplay();
        }
        
        buildCollectionsMenu();
        
        document.body.removeChild(modal);
        document.body.classList.remove('body-modal-open');
      };
    }

    // Duplicar una colección
    function duplicateCollection(id) {
      const collections = getCollections();
      if (!collections[id]) return;
      
      const newId = 'col_' + Date.now();
      // Crear un nuevo objeto con todas las propiedades de la colección original
      collections[newId] = {
        ...collections[id],
        name: collections[id].name + ' (Copia)',
        // Conservar el logoUrl si existe
        logoUrl: collections[id].logoUrl,
        created: new Date().toISOString(),
        lastModified: new Date().toISOString()
      };
      
      saveCollections(collections);
      selectCollection(newId);
      
      // Mostrar notificación de éxito
      showNotification(`Colección "${collections[newId].name}" creada como copia.`);
    }

    // Eliminar una colección
    function deleteCollection(id) {
      const collections = getCollections();
      if (!collections[id] || Object.keys(collections).length <= 1) return;
      
      if (!confirm(`¿Estás seguro de eliminar la colección "${collections[id].name}"?`)) {
        return;
      }
      
      // Si la colección a eliminar es la actual, cambiar a otra
      const currentId = localStorage.getItem('currentCollection') || 'default';
      if (id === currentId) {
        // Encontrar otra colección para seleccionar
        const otherIds = Object.keys(collections).filter(k => k !== id);
        if (otherIds.length > 0) {
          selectCollection(otherIds[0]);
        }
      }
      
      // Eliminar la colección
      delete collections[id];
      saveCollections(collections);
      
      // Actualizar menú
      buildCollectionsMenu();
    }

    /* ===== FUNCIONES DE INVENTARIO ===== */
    function getAllItems() {
      try {
        // Si ya tenemos datos cargados en la variable global, usarlos
        if (allItems && Object.keys(allItems).length > 0) {
          return allItems;
        }
        
        // Usar la estructura de colecciones para cargar los datos
        const collection = getCurrentCollection();
        if (collection && collection.items) {
          try {
            // Parsear los datos de la colección
            const parsed = JSON.parse(collection.items);
            
            // Actualizar la variable global
            allItems = parsed;
            
            console.log("Inventario cargado de colección actual:", Object.keys(parsed).length, "elementos");
            return parsed;
          } catch (parseError) {
            console.error("Error al parsear datos de colección:", parseError);
          }
        }
        
        // Si no hay colección o hubo error, intentar cargar del almacenamiento antiguo
        const raw = localStorage.getItem('inventory_v2_moderno');
        if (raw && raw !== '{}' && raw !== 'null') {
          try {
            const parsed = JSON.parse(raw);
            console.log("Inventario cargado de almacenamiento antiguo:", Object.keys(parsed).length, "elementos");
            return parsed;
          } catch (parseError) {
            console.error("Error al parsear datos antiguos:", parseError);
          }
        }
        
        // Si todo lo anterior falla, devolver un objeto vacío
        console.warn("No se encontraron datos de inventario. Devolviendo objeto vacío.");
        return {};
      } catch (e) {
        console.error("Error al cargar inventario:", e);
        return {};
      }
    }

    function setAllItems(obj) {
      try {
        // Guardar en la estructura de colecciones
        saveCurrentItemsToCollection(obj);
        
        // También guardar en almacenamiento antiguo por compatibilidad
        localStorage.setItem('inventory_v2_moderno', JSON.stringify(obj));
      } catch (e) {
        console.error("Error al guardar inventario:", e);
      }
    }

    // Función getCompanies para obtener compañías desde localStorage
    function getCompanies() {
      try {
        const companiesStr = localStorage.getItem(COMPANIES_KEY);
        return companiesStr ? JSON.parse(companiesStr) : [];
      } catch (e) {
        console.error("Error al cargar compañías:", e);
        return [];
      }
    }
    
    // Función para escapar caracteres HTML en texto, previene inyección de código
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, m => map[m]);
    }
    
    // Función para obtener unidades desde localStorage
    function getUnits() {
      try {
        const unitsStr = localStorage.getItem(UNITS_KEY);
        return unitsStr ? JSON.parse(unitsStr) : ['pz', 'caja', 'kg', 'lb', 'galón'];
      } catch (e) {
        console.error("Error al cargar unidades:", e);
        return ['pz', 'caja', 'kg', 'lb', 'galón']; // Unidades por defecto
      }
    }

    // Función para obtener presentaciones desde localStorage
    function getPresentations() {
      try {
        const presentationsStr = localStorage.getItem(PRESENTATIONS_KEY);
        return presentationsStr ? JSON.parse(presentationsStr) : ['caja', 'pieza', 'paquete', 'bolsa'];
      } catch (e) {
        console.error("Error al cargar presentaciones:", e);
        return ['caja', 'pieza', 'paquete', 'bolsa']; // Presentaciones por defecto
      }
    }

    // Función para obtener categorías desde localStorage
    function getCategories() {
      try {
        const categoriesStr = localStorage.getItem(CATEGORIES_KEY);
        return categoriesStr ? JSON.parse(categoriesStr) : ['General', 'Alimentos', 'Bebidas', 'Limpieza'];
      } catch (e) {
        console.error("Error al cargar categorías:", e);
        return ['General', 'Alimentos', 'Bebidas', 'Limpieza']; // Categorías por defecto
      }
    }

    // Variables globales ya declaradas en la parte superior
    // No necesitamos redeclararlas
    window.longPressTimer = null; // Para el temporizador de pulsación larga

    // Función para guardar los filtros y el estado actual
    function saveFiltersAndState() {
      localStorage.setItem('searchTerm', searchTerm || '');
      localStorage.setItem('currentCompanyFilter', currentCompanyFilter || '');
      localStorage.setItem('currentColumns', currentColumns || 'pc');
      localStorage.setItem('currentSortMode', currentSortMode || 'byNameAsc');
      localStorage.setItem('scrollPos', window.scrollY || 0);
      
      // Guardar también la colección actual
      localStorage.setItem('currentCollection', currentCollection || 'default');
    }

    // Función para restaurar los filtros y el estado guardados
    function restoreFiltersAndState() {
      // Restaurar términos de búsqueda
      searchTerm = localStorage.getItem('searchTerm') || '';
      document.getElementById('searchInput').value = searchTerm;

      // Restaurar filtro de compañía
      currentCompanyFilter = localStorage.getItem('currentCompanyFilter') || '';
      
      // Restaurar columnas y modo de ordenamiento
      currentColumns = localStorage.getItem('currentColumns') || 'pc';
      currentSortMode = localStorage.getItem('currentSortMode') || 'byNameAsc';
      sortMode = currentSortMode; // Mantener compatibilidad con código existente

      // Aplicar configuración en la UI
      updateSearchTerm(searchTerm);
      updateCompanyFilter(currentCompanyFilter);
    }

    // Función auxiliar para actualizar el término de búsqueda
    function updateSearchTerm(term) {
      if (!term) return;
      searchTerm = term;
      // Actualizar input si existe
      const searchInput = document.getElementById('searchInput');
      if (searchInput && searchInput.value !== term) {
        searchInput.value = term;
      }
    }

    // Función auxiliar para actualizar el filtro de compañía
    function updateCompanyFilter(companyName) {
      if (companyName === currentCompanyFilter) return;
      currentCompanyFilter = companyName || '';
      // Actualizar UI si hay cambios
      updateCurrentCompanyLogo();
    }

    // Funciones para la interfaz
    function showTab(tabName, shouldRender = true) {
      // saveFiltersAndState(); // <--- Eliminada esta línea
      
      const pedidoTabContent = document.getElementById('pedidoTab');
      const ordenTabContent = document.getElementById('ordenTab');
      const inventarioTabContent = document.getElementById('inventarioTab');

      const pedidoList = document.getElementById('pedidoList');
      const ordenList = document.getElementById('ordenList');
      const inventarioList = document.getElementById('inventarioList');

      // Ocultar todas las pestañas y poner sus listas a opacidad 0
      pedidoTabContent.style.display = 'none';
      pedidoList.style.opacity = '0';

      ordenTabContent.style.display = 'none';
      ordenList.style.opacity = '0';

      inventarioTabContent.style.display = 'none';
      inventarioList.style.opacity = '0';
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const clickedTab = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
      if (clickedTab) clickedTab.classList.add('active');
      
      // Mostrar la pestaña correcta (el div contenedor del tab)
      document.getElementById(tabName + 'Tab').style.display = 'block';
      
      if (shouldRender) { // Cambio manual de pestaña
        renderTabs(); // Renderiza el contenido dentro de los divs de lista (que aún están opacity 0)
        updateDeleteButtons();
        
        // Hacer visible el contenido de la lista de la pestaña actual inmediatamente
        document.getElementById(tabName + 'List').style.opacity = '1';
        
        // localStorage.setItem('activeTab', tabName); // <--- Eliminada esta línea
        saveFiltersAndState(); // <--- Añadida esta línea al final del bloque if
      }
      // Si !shouldRender (es decir, durante la carga inicial), initApp se encargará de la opacidad DESPUÉS del scroll.
    
      // Ajustar el margen del contenido después de mostrar la pestaña y renderizar
      adjustContentMargin();
    }

    function updateDeleteButtons() {
      const btnPedido = document.getElementById('btnBorrarPedido');
      const btnInventario = document.getElementById('btnBorrarInventario');
      const btnSendMessage = document.getElementById('btnSendMessage'); // Nuevo botón

      const pedidoTabActive = document.getElementById('pedidoTab').style.display !== 'none';
      const ordenTabActive = document.getElementById('ordenTab').style.display !== 'none';
      const inventarioTabActive = document.getElementById('inventarioTab').style.display !== 'none';

      if (pedidoTabActive) {
        btnPedido.style.display = 'inline-block';
        btnInventario.style.display = 'none';
        btnSendMessage.style.display = 'none'; 
      } else if (ordenTabActive) {
        btnPedido.style.display = 'none';
        btnInventario.style.display = 'none';
        btnSendMessage.style.display = 'inline-block'; 
      } else if (inventarioTabActive) {
        btnPedido.style.display = 'none';
        btnInventario.style.display = 'inline-block';
        btnSendMessage.style.display = 'none'; 
      } else {
        btnPedido.style.display = 'none';
        btnInventario.style.display = 'none';
        btnSendMessage.style.display = 'none';
      }
    }

    function renderTabs() {
      renderPedidoTab();
      renderOrdenTab();
      renderInventarioTab();
    }

    // Función para renderizar la pestaña Orden (solo productos con cantidades de pedido > 0)
    function renderOrdenTab() {
      const container = document.getElementById('ordenList');
      container.innerHTML = ''; // Limpiar el contenedor
      container.className = (currentColumns === 1) ? 'grid-1col' : (currentColumns === 2 ? 'grid-2col' : 'grid-pc');
      const itemCountElement = document.getElementById('itemCountDisplay');
      const currentTabType = 'orden'; // Definir tipo de pestaña
      
      const items = getAllItems();
      let entries = Object.entries(items);
      
      // Filtrar solo productos con cantidades de pedido
      entries = entries.filter(([, data]) => {
        return data && (
          (data.pedidoQty && data.pedidoQty !== 0 && data.pedidoQty !== '0') || 
          (data.creditQty && data.creditQty !== 0 && data.creditQty !== '0')
        );
      });
      
      // Aplicar filtros adicionales (búsqueda y compañía)
      if (searchTerm) {
        const lowerSearchTerm = searchTerm.toLowerCase();
        entries = entries.filter(([key, data]) => {
          const lowerKey = key.toLowerCase();
          const productTags = data.tags || []; // Asegurarse de que tags exista
          return lowerKey.includes(lowerSearchTerm) || 
                 productTags.some(tag => tag.toLowerCase().includes(lowerSearchTerm));
        });
      } 
      if (currentCompanyFilter) {
        entries = entries.filter(([, data]) => data && data.company && data.company.toLowerCase() === currentCompanyFilter.toLowerCase());
    }
    
      // Ordenar entradas usando la función de ordenación
      entries = sortEntriesByCurrentMode(entries);
      
      // Actualizar contador de ítems para la pestaña ORDEN
      let distinctItemCountInOrder = entries.length;
      let totalQuantitySumInOrder = 0;

      if (distinctItemCountInOrder > 0) {
        entries.forEach(([, data]) => {
          totalQuantitySumInOrder += parseQuantity(data.pedidoQty || 0);
          totalQuantitySumInOrder += parseQuantity(data.creditQty || 0);
        });
      }

      if (itemCountElement) {
        if (document.getElementById('ordenTab').style.display !== 'none') { // Comprobar si la pestaña está activa
          if (distinctItemCountInOrder === 0) {
            // Anular la visualización de la cuadrícula para centrar el mensaje
            container.className = ''; // Limpiar clases de cuadrícula
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.justifyContent = 'center';
            container.style.alignItems = 'center';
            container.style.height = 'calc(100vh - 280px)'; // Ajustar según la altura de la cabecera/botones
            container.style.gap = '0'; // Asegurar que no haya espacio de la cuadrícula

            const emptyMessage = document.createElement('div');
            emptyMessage.style.textAlign = 'center';
            emptyMessage.style.padding = '20px';
            emptyMessage.style.color = '#666';
            emptyMessage.innerHTML = '<span class="material-icons" style="font-size:48px; margin-bottom:10px; display:block;">shopping_cart</span>No hay productos en tu orden.<br>Añade cantidades en la pestaña "Pedido".';
            container.appendChild(emptyMessage);

            if (itemCountElement && document.getElementById('ordenTab').style.display !== 'none') {
                itemCountElement.textContent = "Orden vacía";
            }
            return;
      } else {
            let countText = `Orden: ${distinctItemCountInOrder} ítem(s)`;
            if (totalQuantitySumInOrder > 0) {
              countText += ` / Total: ${formatQuantity(totalQuantitySumInOrder)} unidades`; // Usamos formatQuantity por si da 0.5
            }
            itemCountElement.textContent = countText;
          }
        }
      }
      
      // Si no hay productos con cantidad, mostrar mensaje
      if (entries.length === 0) {
        // Anular la visualización de la cuadrícula para centrar el mensaje
        container.className = ''; // Limpiar clases de cuadrícula
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';
        container.style.height = 'calc(100vh - 280px)'; // Ajustar según la altura de la cabecera/botones
        container.style.gap = '0'; // Asegurar que no haya espacio de la cuadrícula

        const emptyMessage = document.createElement('div');
        emptyMessage.style.textAlign = 'center';
        emptyMessage.style.padding = '20px';
        emptyMessage.style.color = '#666';
        emptyMessage.innerHTML = '<span class="material-icons" style="font-size:48px; margin-bottom:10px; display:block;">shopping_cart</span>No hay productos en tu orden.<br>Añade cantidades en la pestaña "Pedido".';
        container.appendChild(emptyMessage);

        if (itemCountElement && document.getElementById('ordenTab').style.display !== 'none') {
            itemCountElement.textContent = "Orden vacía";
        }
        return;
      }
      
      // Si no está vacío, asegurar que los estilos flex se eliminen y la cuadrícula esté activa
      // La clase de cuadrícula ya se estableció arriba, solo limpiar los estilos en línea.
      container.style.display = ''; 
      container.style.flexDirection = '';
      container.style.justifyContent = '';
      container.style.alignItems = '';
      container.style.height = '';
      container.style.gap = '';
      
      // Renderizar cada producto (igual que en renderPedidoTab pero solo productos con cantidad)
      entries.forEach(([name, data]) => {
        if (!data) return; // Skip invalid items
        
        // Crear el elemento de producto
        const item = document.createElement('div');
        item.className = 'item highlight'; // Siempre highlight porque siempre tienen cantidad
        
        // Espacio de imagen
        const imgSpace = document.createElement('div');
        imgSpace.className = 'img-space';
        imgSpace.onclick = () => showImageZoomModal(data.image, name);
        
        // Botón de edición
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-icon-btn';
        editBtn.innerHTML = '<span class="material-icons">edit</span>';
        editBtn.onclick = function(e) { 
          e.stopPropagation();
          editItem(name);
          return false;
        };
        
        // Botón de créditos
        const creditBtn = document.createElement('button');
        creditBtn.className = 'credit-icon-btn';
        creditBtn.innerHTML = '<span class="material-icons">loyalty</span>';
        creditBtn.onclick = function(e) { 
          e.stopPropagation();
          openCreditModal(name);
          return false;
        };
        
        imgSpace.appendChild(editBtn);
        imgSpace.appendChild(creditBtn);
        
        // Imagen del producto (si existe)
        if (data.image) {
          const img = document.createElement('img');
          img.src = data.image;
          imgSpace.appendChild(img);
        }
        
        // Información del producto
        const header = document.createElement('div');
        header.className = 'item-header';
        
        const productName = document.createElement('div');
        productName.className = 'product-name';
        productName.textContent = name;
        productName.onclick = () => showProductInfo(name);
        productName.style.cursor = 'pointer';
        
        const productNumber = document.createElement('div');
        productNumber.className = 'product-number';
        productNumber.textContent = '#' + (data.numero || '');
        
        header.appendChild(productName);
        header.appendChild(productNumber);
      
        // Fila de cantidad
        const quantityRow = document.createElement('div');
        quantityRow.className = 'quantity-row';
        
        const label = document.createElement('span');
        label.textContent = data.presentation || 'caja';
        
        const inputContainer = document.createElement('div');
        inputContainer.className = 'quantity-input-container';
        
        // Botón de decrementar siempre está presente porque siempre hay cantidad
        const decrementBtn = createQuantityButton('decrease', name, currentTabType);
        inputContainer.appendChild(decrementBtn);
        
        const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.value = data.pedidoQty && data.pedidoQty !== '0' ? data.pedidoQty : '';
        input.setAttribute('list', 'numbers');
        input.style.textAlign = 'center';
        input.style.display = 'inline-block';
        input.style.alignItems = 'center';
        input.style.justifyContent = 'center';
        input.onfocus = function() { this.select(); };
        input.onblur = function() { 
      const items = getAllItems();
          if (items[name]) {
            // Si el valor es 0 o vacío, establecer a 0 (que se interpretará como sin cantidad)
            const newValue = this.value && this.value !== '0' ? this.value : 0;
            items[name].pedidoQty = newValue;
      setAllItems(items);
      
            // Si el valor es 0, establecer el valor visible a vacío
            if (newValue === 0 || newValue === '0') {
              this.value = '';
            }
            
            // Actualizar todas las pestañas para reflejar el cambio
            renderTabs();
          }
        };
        input.onkeydown = function(e) {
          if (e.key === 'Enter') this.blur();
        };
        
        inputContainer.appendChild(input);
        
        // Botón de incrementar
        const incrementBtn = createQuantityButton('increase', name, currentTabType);
        inputContainer.appendChild(incrementBtn);
        
        quantityRow.appendChild(label);
        quantityRow.appendChild(inputContainer);
        
        // Agregar todos los elementos al ítem
        item.appendChild(imgSpace);
        item.appendChild(header);
        item.appendChild(quantityRow);
        
        // Agregar el ítem al contenedor
        container.appendChild(item);
        
        // Verificar si hay créditos para este producto y crear un elemento adicional si es necesario
        if (data.creditQty && data.creditQty !== 0) {
          // Crear el elemento de crédito (casi idéntico pero con indicadores visuales de crédito)
          const creditItem = document.createElement('div');
          creditItem.className = 'item highlight';
          creditItem.style.borderColor = '#c00';
      
          // Espacio de imagen (igual al original)
          const creditImgSpace = document.createElement('div');
          creditImgSpace.className = 'img-space';
          creditImgSpace.onclick = () => showImageZoomModal(data.image, name);
          
          if (data.image) {
            const creditImg = document.createElement('img');
            creditImg.src = data.image;
            creditImgSpace.appendChild(creditImg);
          }
          
          // Overlay para indicar crédito
          const creditOverlay = document.createElement('div');
          creditOverlay.style.position = 'absolute';
          creditOverlay.style.top = '0';
          creditOverlay.style.right = '0';
          creditOverlay.style.background = '#c00';
          creditOverlay.style.color = 'white';
          creditOverlay.style.padding = '2px 6px';
          creditOverlay.style.fontSize = '0.7rem';
          creditOverlay.style.borderRadius = '0 0 0 8px';
          creditOverlay.textContent = 'CRÉDITO';
          
          creditImgSpace.appendChild(creditOverlay);
          
          // Información del producto (igual al original)
          const creditHeader = document.createElement('div');
          creditHeader.className = 'item-header';
          
          const creditProductName = document.createElement('div');
          creditProductName.className = 'product-name';
          creditProductName.textContent = name;
          creditProductName.onclick = () => showProductInfo(name);
          creditProductName.style.cursor = 'pointer';
      
          const creditProductNumber = document.createElement('div');
          creditProductNumber.className = 'product-number';
          creditProductNumber.textContent = '#' + (data.numero || '');
          
          creditHeader.appendChild(creditProductName);
          creditHeader.appendChild(creditProductNumber);
          
          // Fila de cantidad (con etiqueta de crédito)
          const creditQuantityRow = document.createElement('div');
          creditQuantityRow.className = 'quantity-row';
          
          const creditLabel = document.createElement('span');
          creditLabel.textContent = (data.creditPresentation || data.presentation || 'caja') + ' (CRÉDITO)';
          creditLabel.style.color = '#c00';
          
          const creditInputContainer = document.createElement('div');
          creditInputContainer.className = 'quantity-input-container';
          
          const creditInput = document.createElement('input');
          creditInput.type = 'text';
          creditInput.inputMode = 'decimal';
          creditInput.value = data.creditQty && data.creditQty !== '0' ? data.creditQty : '';
          creditInput.setAttribute('list', 'numbers');
          creditInput.style.borderColor = '#c00';
          creditInput.style.color = '#c00';
          creditInput.style.textAlign = 'center';
          creditInput.style.display = 'inline-block';
          creditInput.style.alignItems = 'center';
          creditInput.style.justifyContent = 'center';
          creditInput.onfocus = function() { this.select(); };
          creditInput.onblur = function() { 
      const items = getAllItems();
            if (items[name]) {
              // Si el valor es 0 o vacío, se considera como sin crédito
              const newValue = this.value && this.value !== '0' ? this.value : 0;
              items[name].creditQty = newValue;
              items[name].creditPresentation = data.creditPresentation;
      setAllItems(items);
      
              // Si el valor es 0, establecer el valor visible a vacío
              if (newValue === 0 || newValue === '0') {
                this.value = '';
              }
              
              // Actualizar todas las pestañas porque hay cambios en créditos
              renderTabs();
            }
          };
          creditInput.onkeydown = function(e) {
            if (e.key === 'Enter') this.blur();
          };
          
          creditInputContainer.appendChild(creditInput);
          
          // Botón para eliminar crédito
          const removeCreditBtn = document.createElement('button');
          removeCreditBtn.type = "button";
          removeCreditBtn.className = 'quantity-btn';
          removeCreditBtn.style.background = '#c00';
          removeCreditBtn.innerHTML = 'x';
          removeCreditBtn.setAttribute('data-product', name);
          removeCreditBtn.onclick = function(event) { // Añadir event
            event.stopPropagation(); // Evitar que se propague a otros listeners del item
            removeCredit(this.getAttribute('data-product'));
            return false;
          };
          creditInputContainer.appendChild(removeCreditBtn);
          
          creditQuantityRow.appendChild(creditLabel);
          creditQuantityRow.appendChild(creditInputContainer);
          
          // Agregar todos los elementos al ítem de crédito
          creditItem.appendChild(creditImgSpace);
          creditItem.appendChild(creditHeader);
          creditItem.appendChild(creditQuantityRow);
          
          // Agregar el ítem de crédito al contenedor
          container.appendChild(creditItem);
        }
      });
    }

    function renderPedidoTab() {
      const container = document.getElementById('pedidoList');
      container.innerHTML = ''; // Limpiar el contenedor
      container.className = (currentColumns === 1) ? 'grid-1col' : (currentColumns === 2 ? 'grid-2col' : 'grid-pc');
      const itemCountElement = document.getElementById('itemCountDisplay');
      const currentTabType = 'pedido'; // Definir tipo de pestaña
      
      const items = getAllItems();
      let entries = Object.entries(items);
      
      // Aplicar filtros
      if (searchTerm) {
        const lowerSearchTerm = searchTerm.toLowerCase();
        entries = entries.filter(([key, data]) => {
          const lowerKey = key.toLowerCase();
          const productTags = data.tags || []; // Asegurarse de que tags exista
          return lowerKey.includes(lowerSearchTerm) || 
                 productTags.some(tag => tag.toLowerCase().includes(lowerSearchTerm));
        });
      }
      if (currentCompanyFilter) {
        entries = entries.filter(([, data]) => data && data.company && data.company.toLowerCase() === currentCompanyFilter.toLowerCase());
      }
      
      // Ordenar entradas usando la nueva función de ordenación
      entries = sortEntriesByCurrentMode(entries);
      
      // Actualizar contador de ítems para la pestaña PEDIDO
      // Contar solo productos con cantidad de pedido > 0
      const pedidoConCantidad = entries.filter(([, data]) => data && data.pedidoQty && parseQuantity(data.pedidoQty) > 0);
      if (itemCountElement) {
        if (document.getElementById('pedidoTab').style.display !== 'none') { // Comprobar si la pestaña está activa
          if (pedidoConCantidad.length === 0) {
            itemCountElement.textContent = "Nada en pedido";
          } else if (pedidoConCantidad.length === 1) {
            itemCountElement.textContent = `1 producto en pedido`;
          } else {
            itemCountElement.textContent = `${pedidoConCantidad.length} productos en pedido`;
          }
        }
      }
      
      // Renderizar cada producto
      entries.forEach(([name, data]) => {
        if (!data) return; // Skip invalid items
        
        // Crear el elemento de producto
        const item = document.createElement('div');
        item.className = 'item' + ((data.pedidoQty && data.pedidoQty !== 0 && data.pedidoQty !== '0') ? ' highlight' : '');
        
        // Espacio de imagen
        const imgSpace = document.createElement('div');
        imgSpace.className = 'img-space';
        imgSpace.onclick = () => showImageZoomModal(data.image, name);
        
        // Botón de edición
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-icon-btn';
        editBtn.innerHTML = '<span class="material-icons">edit</span>';
        editBtn.onclick = function(e) { 
          e.stopPropagation();
          editItem(name);
          return false;
        };
        
        // Botón de créditos
        const creditBtn = document.createElement('button');
        creditBtn.className = 'credit-icon-btn';
        creditBtn.innerHTML = '<span class="material-icons">loyalty</span>';
        creditBtn.onclick = function(e) { 
          e.stopPropagation();
          openCreditModal(name);
          return false;
        };
        
        imgSpace.appendChild(editBtn);
        imgSpace.appendChild(creditBtn);
        
        // Imagen del producto (si existe)
        if (data.image) {
          const img = document.createElement('img');
          img.src = data.image;
          imgSpace.appendChild(img);
        }
        
        // Información del producto
        const header = document.createElement('div');
        header.className = 'item-header';
        
        const productName = document.createElement('div');
        productName.className = 'product-name';
        productName.textContent = name;
        productName.onclick = () => showProductInfo(name);
        productName.style.cursor = 'pointer';
        
        const productNumber = document.createElement('div');
        productNumber.className = 'product-number';
        productNumber.textContent = '#' + (data.numero || '');
        
        header.appendChild(productName);
        header.appendChild(productNumber);
        
        // Fila de cantidad
        const quantityRow = document.createElement('div');
        quantityRow.className = 'quantity-row';
        
        const label = document.createElement('span');
        label.textContent = data.presentation || 'caja';
        
        const inputContainer = document.createElement('div');
        inputContainer.className = 'quantity-input-container';
        
        // Botón de decrementar (solo se muestra si hay cantidad mayor que cero)
        const hasQuantity = data.pedidoQty && data.pedidoQty !== 0 && data.pedidoQty !== '0';
        
        if (hasQuantity) {
          const decrementBtn = createQuantityButton('decrease', name, currentTabType);
          inputContainer.appendChild(decrementBtn);
        }
        
                  const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.value = data.pedidoQty && data.pedidoQty !== '0' ? data.pedidoQty : '';
        input.setAttribute('list', 'numbers');
        input.style.textAlign = 'center';
        input.style.display = 'inline-block';
        input.style.alignItems = 'center';
        input.style.justifyContent = 'center';
        input.onfocus = function() { this.select(); };
        input.onblur = function() { 
          const items = getAllItems();
          if (items[name]) {
            // Si el valor es 0 o vacío, establecer a 0 (que se interpretará como sin cantidad)
            const newValue = this.value && this.value !== '0' ? this.value : 0;
            items[name].pedidoQty = newValue;
            setAllItems(items);
            
            // Si el valor es 0, establecer el valor visible a vacío
            if (newValue === 0 || newValue === '0') {
              this.value = '';
            }
            
            // Update just this product without reloading the entire tab
            updateProductQuantityUI(name, newValue, 'pedido');
          }
        };
        input.onkeydown = function(e) {
          if (e.key === 'Enter') this.blur();
        };
        
        inputContainer.appendChild(input);
        
        // Botón de incrementar
        const incrementBtn = createQuantityButton('increase', name, currentTabType);
        inputContainer.appendChild(incrementBtn);
        
        quantityRow.appendChild(label);
        quantityRow.appendChild(inputContainer);
        
        // Agregar todos los elementos al ítem
        item.appendChild(imgSpace);
        item.appendChild(header);
        item.appendChild(quantityRow);
        
        // Agregar el ítem al contenedor
        container.appendChild(item);
        
        // Verificar si hay créditos para este producto y crear un elemento adicional si es necesario
        if (data.creditQty && data.creditQty !== 0) {
          // Crear el elemento de crédito (casi idéntico pero con indicadores visuales de crédito)
          const creditItem = document.createElement('div');
          creditItem.className = 'item highlight';
          creditItem.style.borderColor = '#c00';
          
          // Espacio de imagen (igual al original)
          const creditImgSpace = document.createElement('div');
          creditImgSpace.className = 'img-space';
          creditImgSpace.onclick = () => showImageZoomModal(data.image, name);
          
          if (data.image) {
            const creditImg = document.createElement('img');
            creditImg.src = data.image;
            creditImgSpace.appendChild(creditImg);
          }
          
          // Overlay para indicar crédito
          const creditOverlay = document.createElement('div');
          creditOverlay.style.position = 'absolute';
          creditOverlay.style.top = '0';
          creditOverlay.style.right = '0';
          creditOverlay.style.background = '#c00';
          creditOverlay.style.color = 'white';
          creditOverlay.style.padding = '2px 6px';
          creditOverlay.style.fontSize = '0.7rem';
          creditOverlay.style.borderRadius = '0 0 0 8px';
          creditOverlay.textContent = 'CRÉDITO';
          
          creditImgSpace.appendChild(creditOverlay);
          
          // Información del producto (igual al original)
          const creditHeader = document.createElement('div');
          creditHeader.className = 'item-header';
          
          const creditProductName = document.createElement('div');
          creditProductName.className = 'product-name';
          creditProductName.textContent = name;
          creditProductName.onclick = () => showProductInfo(name);
          creditProductName.style.cursor = 'pointer';
      
          const creditProductNumber = document.createElement('div');
          creditProductNumber.className = 'product-number';
          creditProductNumber.textContent = '#' + (data.numero || '');
          
          creditHeader.appendChild(creditProductName);
          creditHeader.appendChild(creditProductNumber);
          
          // Fila de cantidad (con etiqueta de crédito)
          const creditQuantityRow = document.createElement('div');
          creditQuantityRow.className = 'quantity-row';
          
          const creditLabel = document.createElement('span');
          creditLabel.textContent = (data.creditPresentation || data.presentation || 'caja') + ' (CRÉDITO)';
          creditLabel.style.color = '#c00';
          
          const creditInputContainer = document.createElement('div');
          creditInputContainer.className = 'quantity-input-container';
          
          const creditInput = document.createElement('input');
          creditInput.type = 'text';
          creditInput.inputMode = 'decimal';
          creditInput.value = data.creditQty && data.creditQty !== '0' ? data.creditQty : '';
          creditInput.setAttribute('list', 'numbers');
          creditInput.style.borderColor = '#c00';
          creditInput.style.color = '#c00';
          creditInput.style.textAlign = 'center';
          creditInput.style.display = 'inline-block';
          creditInput.style.alignItems = 'center';
          creditInput.style.justifyContent = 'center';
          creditInput.onfocus = function() { this.select(); };
          creditInput.onblur = function() { 
            const items = getAllItems();
            if (items[name]) {
              // Si el valor es 0 o vacío, se considera como sin crédito
              const newValue = this.value && this.value !== '0' ? this.value : 0;
              items[name].creditQty = newValue;
              items[name].creditPresentation = data.creditPresentation;
              setAllItems(items);
              
              // Si el valor es 0, establecer el valor visible a vacío
              if (newValue === 0 || newValue === '0') {
                this.value = '';
              }
              
              // Actualizar todas las pestañas porque hay cambios en créditos
              renderTabs();
            }
          };
          creditInput.onkeydown = function(e) {
            if (e.key === 'Enter') this.blur();
          };
          
          creditInputContainer.appendChild(creditInput);
          
          // Botón para eliminar crédito
          const removeCreditBtn = document.createElement('button');
          removeCreditBtn.type = "button";
          removeCreditBtn.className = 'quantity-btn';
          removeCreditBtn.style.background = '#c00';
          removeCreditBtn.innerHTML = 'x';
          removeCreditBtn.setAttribute('data-product', name);
          removeCreditBtn.onclick = function(event) { // Añadir event
            event.stopPropagation(); // Evitar que se propague a otros listeners del item
            removeCredit(this.getAttribute('data-product'));
            return false;
          };
          creditInputContainer.appendChild(removeCreditBtn);
          
          creditQuantityRow.appendChild(creditLabel);
          creditQuantityRow.appendChild(creditInputContainer);
          
          // Agregar todos los elementos al ítem de crédito
          creditItem.appendChild(creditImgSpace);
          creditItem.appendChild(creditHeader);
          creditItem.appendChild(creditQuantityRow);
          
          // Agregar el ítem de crédito al contenedor
          container.appendChild(creditItem);
        }
      });
    }

    function renderInventarioTab() {
      const container = document.getElementById('inventarioList');
      container.innerHTML = ''; // Limpiar el contenedor
      container.className = (currentColumns === 1) ? 'grid-1col' : (currentColumns === 2 ? 'grid-2col' : 'grid-pc');
      const itemCountElement = document.getElementById('itemCountDisplay');
      const currentTabType = 'inventario'; // Definir tipo de pestaña
      
      const items = getAllItems();
      let entries = Object.entries(items);
      
      // Aplicar filtros
      if (searchTerm) {
        const lowerSearchTerm = searchTerm.toLowerCase();
        entries = entries.filter(([key, data]) => {
          const lowerKey = key.toLowerCase();
          const productTags = data.tags || []; // Asegurarse de que tags exista
          return lowerKey.includes(lowerSearchTerm) || 
                 productTags.some(tag => tag.toLowerCase().includes(lowerSearchTerm));
        });
      }
      if (currentCompanyFilter) {
        entries = entries.filter(([, data]) => data && data.company && data.company.toLowerCase() === currentCompanyFilter.toLowerCase());
      }
      
      // Ordenar entradas usando la nueva función de ordenación
      entries = sortEntriesByCurrentMode(entries);
      
      // Actualizar contador de ítems para la pestaña INVENTARIO
      // Cuenta todos los productos que coinciden con los filtros, tengan o no cantidad.
      if (itemCountElement) {
        if (document.getElementById('inventarioTab').style.display !== 'none') { // Comprobar si la pestaña está activa
          if (entries.length === 0) {
            itemCountElement.textContent = "Inventario vacío";
          } else if (entries.length === 1) {
            itemCountElement.textContent = `1 producto en inventario`;
          } else {
            itemCountElement.textContent = `${entries.length} productos en inventario`;
          }
        }
      }
      
      // Renderizar cada producto
      entries.forEach(([name, data]) => {
        if (!data) return; // Skip invalid items
        
        // Crear el elemento de producto
        const item = document.createElement('div');
        item.className = 'item' + ((data.inventarioQty && data.inventarioQty !== 0 && data.inventarioQty !== '0') ? ' highlight' : '');
        
        // Espacio de imagen
        const imgSpace = document.createElement('div');
        imgSpace.className = 'img-space';
        imgSpace.onclick = () => showImageZoomModal(data.image, name);
        
        // Botón de edición
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-icon-btn';
        editBtn.innerHTML = '<span class="material-icons">edit</span>';
        editBtn.onclick = function(e) { 
          e.stopPropagation();
          editItem(name);
          return false;
        };
        
        imgSpace.appendChild(editBtn);
        
        // Imagen del producto (si existe)
        if (data.image) {
          const img = document.createElement('img');
          img.src = data.image;
          imgSpace.appendChild(img);
        }
        
        // Información del producto
        const header = document.createElement('div');
        header.className = 'item-header';
        
        const productName = document.createElement('div');
        productName.className = 'product-name';
        productName.textContent = name;
        productName.onclick = () => showProductInfo(name);
        productName.style.cursor = 'pointer';
        
        const productNumber = document.createElement('div');
        productNumber.className = 'product-number';
        productNumber.textContent = '#' + (data.numero || '');
        
        header.appendChild(productName);
        header.appendChild(productNumber);
        
        // Fila de cantidad
        const quantityRow = document.createElement('div');
        quantityRow.className = 'quantity-row';
        
        const inputContainer = document.createElement('div');
        inputContainer.className = 'quantity-input-container';
        
        // Botón de decrementar (solo se muestra si hay cantidad mayor que cero)
        const hasQuantity = data.inventarioQty && data.inventarioQty !== 0 && data.inventarioQty !== '0';
        
        if (hasQuantity) {
          const decrementBtn = createQuantityButton('decrease', name, currentTabType);
          inputContainer.appendChild(decrementBtn);
        }
        
                  const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.value = data.inventarioQty && data.inventarioQty !== '0' ? data.inventarioQty : '';
        input.setAttribute('list', 'numbers');
        input.onfocus = function() { this.select(); };
        input.onblur = function() { 
          const items = getAllItems();
          if (items[name]) {
            // Si el valor es 0 o vacío, establecer a 0 (que se interpretará como sin cantidad)
            const newValue = this.value && this.value !== '0' ? this.value : 0;
            items[name].inventarioQty = newValue;
            setAllItems(items);
            
            // Si el valor es 0, establecer el valor visible a vacío
            if (newValue === 0 || newValue === '0') {
              this.value = '';
            }
            
            // Update just this product without reloading the entire tab
            updateProductQuantityUI(name, newValue, 'inventario');
          }
        };
        input.onkeydown = function(e) {
          if (e.key === 'Enter') this.blur();
        };
        
        inputContainer.appendChild(input);
        
        // Botón de incrementar
        const incrementBtn = createQuantityButton('increase', name, currentTabType);
        inputContainer.appendChild(incrementBtn);
        
        const unit = document.createElement('span');
        unit.textContent = data.unit || 'pz';
        
        quantityRow.appendChild(inputContainer);
        quantityRow.appendChild(unit);
        
        // Agregar todos los elementos al ítem
        item.appendChild(imgSpace);
        item.appendChild(header);
        item.appendChild(quantityRow);
        
        // Agregar el ítem al contenedor
        container.appendChild(item);
      });
    }

    function updateSearch(val) {
      searchTerm = val.trim();
      const clearBtn = document.querySelector('.search-bar .clear-search-btn');
      if (clearBtn) {
        clearBtn.style.display = searchTerm ? 'inline-block' : 'none';
      }
      saveFiltersAndState();
      renderTabs();
    }

    function setColumns(mode) {
      currentColumns = mode;
      document.getElementById('viewOptions').style.display = 'none';
      saveFiltersAndState();
      renderTabs();
    }

    function setSortMode(mode) {
      sortMode = mode;
      document.getElementById('viewOptions').style.display = 'none';
      saveFiltersAndState();
      renderTabs();
    }

    function toggleViewOptions() {
      const menu = document.getElementById('viewOptions');
      menu.classList.toggle('show');
    }

    /* ===== EDICIÓN DE PRODUCTOS ===== */
    function addNewProduct() {
      currentEdit = null;
      document.getElementById('editModalTitle').textContent = 'Nuevo Producto';
      document.getElementById('deleteProductBtn').style.display = 'none';
      
      // Limpiar campos
      document.getElementById('editName').value = '';
      document.getElementById('editNumber').value = '';
      document.getElementById('editCategory').value = '';
      document.getElementById('editStock').value = '';
      document.getElementById('editCustomMargin').value = '';
      // Por defecto, el tipo de margen es porcentaje para nuevos productos
      document.getElementById('marginTypePercent').checked = true;
      document.getElementById('editImageUrl').value = '';
      document.getElementById('editImageFile').value = '';
      document.getElementById('editTags').value = ''; // Limpiar campo de tags para nuevo producto
      
      // Limpiar campos de información de caja
      document.getElementById('editUnidadesPorCaja').value = '';
      document.getElementById('editPaquetesPorCaja').value = '';
      
      try {
      // Llenar selects
      fillSelectOptions('editUnit', getUnits());
      fillSelectOptions('editPresentation', getPresentations());
      fillSelectOptions('editCompany', getCompanies().map(c => c.name));
        
        // Arreglo: pasar null en lugar de nombre (que no está definido)
        fillCustomSortPositionSelect(null);
      } catch (e) {
        console.error('Error al llenar campos del modal:', e);
      }
      
      // Limpiar precios
      document.getElementById('priceContainer').innerHTML = '';
      
      // Mostrar modal
      const modal = document.getElementById('editModal');
      if (modal) {
        modal.classList.add('show');
        // Asegurar que sea visible
        modal.style.display = 'flex';
      document.body.classList.add('body-modal-open'); // Bloquear scroll
        console.log('Modal de nuevo producto abierto');
      } else {
        console.error('No se encontró el modal de edición');
      }
    }

    function editItem(name) {
      const items = getAllItems();
      if (!items[name]) return;
      
      currentEdit = name;
      document.getElementById('editModalTitle').textContent = 'Editar Producto';
      document.getElementById('deleteProductBtn').style.display = 'inline-block';
      
      // Llenar campos
      document.getElementById('editName').value = name;
      document.getElementById('editNumber').value = items[name].numero || '';
      document.getElementById('editCategory').value = items[name].category || '';
      document.getElementById('editStock').value = items[name].stock || '';
      document.getElementById('editCustomMargin').value = items[name].customMargin || '';
      // Cargar el tipo de margen guardado, o por defecto a 'percent'
      if (items[name].marginType === 'fixed') {
        document.getElementById('marginTypeFixed').checked = true;
      } else {
        document.getElementById('marginTypePercent').checked = true;
      }
      document.getElementById('editImageUrl').value = items[name].image || '';
      document.getElementById('editImageFile').value = '';
      document.getElementById('editTags').value = items[name].tags ? items[name].tags.join(', ') : ''; // Cargar tags
      
      // Llenar campos de información de caja
      document.getElementById('editUnidadesPorCaja').value = items[name].unidadesPorCaja || '';
      document.getElementById('editPaquetesPorCaja').value = items[name].paquetesPorCaja || '';
      
      // Llenar selects
      fillSelectOptions('editUnit', getUnits(), items[name].unit);
      fillSelectOptions('editPresentation', getPresentations(), items[name].presentation);
      fillSelectOptions('editCompany', getCompanies().map(c => c.name), items[name].company);
      fillCustomSortPositionSelect(name, items[name].customSortOrder); // Llenar select de orden personalizado
      
      // Llenar precios
      document.getElementById('priceContainer').innerHTML = '';
      if (items[name].prices && items[name].prices.length) {
        items[name].prices.forEach(p => {
          addPriceRow(p.company, p.price);
        });
      }
      
      // Mostrar modal
      const modal = document.getElementById('editModal');
      if (modal) {
        modal.classList.add('show');
        // Asegurar que sea visible según los estilos CSS (.modal.show)
        modal.style.display = 'flex';
        modal.style.opacity = '1';
        modal.style.pointerEvents = 'auto';
      document.body.classList.add('body-modal-open'); // Bloquear scroll
        console.log('Modal de edición mostrado');
      } else {
        console.error('No se encontró el modal de edición');
      }
    }

    function fillSelectOptions(selectId, options, selectedValue = null) {
      const select = document.getElementById(selectId);
      select.innerHTML = '';
      
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
      });
      
      if (selectedValue !== null) {
        select.value = selectedValue;
      }
    }

    function saveChanges() {
      const name = document.getElementById('editName').value.trim().toUpperCase();
      if (!name) {
        alert('El nombre del producto no puede estar vacío');
        return;
      }
      
      const items = getAllItems();
      
      // Verificar si el nuevo nombre ya existe (solo si estamos renombrando)
      if (currentEdit && currentEdit !== name && items[name]) {
        alert('Ya existe un producto con ese nombre');
        return;
      }
      
      // Obtener valores de los campos
      const numero = document.getElementById('editNumber').value.trim();
      const unit = document.getElementById('editUnit').value;
      const presentation = document.getElementById('editPresentation').value;
      const category = document.getElementById('editCategory').value;
      const company = document.getElementById('editCompany').value;
      const stock = document.getElementById('editStock').value;
      const customMargin = document.getElementById('editCustomMargin').value.trim();
      const imageUrl = document.getElementById('editImageUrl').value.trim();
      const tagsInput = document.getElementById('editTags').value.trim();
      const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : []; // Convertir a array, limpiar y a minúsculas
      const marginType = document.querySelector('input[name="marginType"]:checked').value;
      
      // Obtener información de la caja
      const unidadesPorCaja = document.getElementById('editUnidadesPorCaja').value.trim();
      const paquetesPorCaja = document.getElementById('editPaquetesPorCaja').value.trim();
      
      // Obtener precios
      const prices = [];
      document.querySelectorAll('#priceContainer .price-row').forEach(row => {
        const companySelect = row.querySelector('select');
        const priceInput = row.querySelector('input');
        
        if (companySelect && priceInput && companySelect.value && priceInput.value) {
          prices.push({
            company: companySelect.value,
            price: priceInput.value
          });
        }
      });
      
      // Si hay una imagen de archivo, procesarla
      const imageFile = document.getElementById('editImageFile').files[0];
      if (imageFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          saveItemData(name, {
            numero,
            unit,
            presentation,
            category,
            tags, // Guardar tags
            company,
            stock,
            customMargin: customMargin || null, // Guardar valor del margen
            marginType: customMargin ? marginType : 'percent', // Guardar tipo, si no hay customMargin, default a percent
            unidadesPorCaja: unidadesPorCaja || null,
            paquetesPorCaja: paquetesPorCaja || null,
            prices,
            image: e.target.result,
            pedidoQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].pedidoQty || 0) : 0,
            inventarioQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].inventarioQty || 0) : 0
          });
        };
        reader.readAsDataURL(imageFile);
      } else {
        // Usar la URL de imagen
        saveItemData(name, {
          numero,
          unit,
          presentation,
          category,
          tags, // Guardar tags
          company,
          stock,
          customMargin: customMargin || null, // Guardar valor del margen
          marginType: customMargin ? marginType : 'percent', // Guardar tipo, si no hay customMargin, default a percent
          unidadesPorCaja: unidadesPorCaja || null,
          paquetesPorCaja: paquetesPorCaja || null,
          prices,
          image: imageUrl,
          pedidoQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].pedidoQty || 0) : 0,
          inventarioQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].inventarioQty || 0) : 0
        });
      }
    }

    function saveItemData(name, data) {
      const items = getAllItems();
      
      // Si estamos renombrando, eliminar el item original
      if (currentEdit && currentEdit !== name) {
        delete items[currentEdit];
      }
      
      // Guardar el nuevo item
      items[name] = data;
      setAllItems(items);
      
      // Cerrar modal y actualizar vista
      closeModal();
      renderTabs();
    }

    function deleteItem() {
      if (!currentEdit) return;
      
      if (confirm(`¿Seguro que quieres eliminar "${currentEdit}"?`)) {
        const items = getAllItems();
        delete items[currentEdit];
        setAllItems(items);
        closeModal();
        renderTabs();
      }
    }

    function closeModal() {
      const modal = document.getElementById('editModal');
      if (modal) {
        modal.classList.remove('show');
        // Restaurar propiedades originales
        modal.style.display = '';
        modal.style.opacity = '';
        modal.style.pointerEvents = '';
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
        console.log('Modal de edición cerrado');
      }
      currentEdit = null;
    }

    /* ===== FUNCIONES DE PRECIOS ===== */
    function addPriceRow(company = '', price = '') {
      const container = document.getElementById('priceContainer');
      
      const row = document.createElement('div');
      row.className = 'price-row';
      
      // Select de compañía
      const select = document.createElement('select');
      select.className = 'price-company';
      
      getCompanies().forEach(c => {
        const option = document.createElement('option');
        option.value = c.name;
        option.textContent = c.name;
        if (c.name === company) option.selected = true;
        select.appendChild(option);
      });
      
      // Input de precio
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'price-value';
      input.value = price;
      input.placeholder = 'Precio';
      input.style.width = '80px';
      input.inputMode = 'decimal'; // Mejorar experiencia en móviles para precios
      
      // Botón de eliminar
      const button = document.createElement('button');
      button.type = 'button';
      // button.textContent = 'Eliminar'; // Modificado para usar icono
      button.innerHTML = '<span class="material-icons" style="font-size: 20px; vertical-align: middle;">delete_outline</span>';
      button.style.width = 'auto';
      button.style.height = 'auto';
      button.style.borderRadius = '6px'; // Este estilo se moverá a CSS
      // button.style.padding = '8px 12px'; // Este estilo se manejará por CSS
      button.onclick = function() {
        row.remove();
      };
      
      row.appendChild(select);
      row.appendChild(input);
      row.appendChild(button);
      
      container.appendChild(row);
    }

    /* ===== FUNCIONES DE INFORMACIÓN DE PRODUCTO ===== */
    function showProductInfo(name) {
      const items = getAllItems();
      if (!items[name]) return;
      
      const product = items[name];
      
      // Obtener logo de compañía
      let mainLogo = APP_DEFAULT_LOGO;
      if (product.company) {
        const comp = getCompanies().find(c => c.name === product.company);
        if (comp && comp.image) mainLogo = comp.image;
      }
      
      // Calcular precio sugerido
      let lowestPrice = 0;
      if (product.prices && product.prices.length) {
        lowestPrice = Math.min(...product.prices.map(p => parseFloat(p.price) || 0));
      }
      
      const defaultMargin = parseFloat(localStorage.getItem('defaultMarginPercent') || '45');
      const customMarginValue = product.customMargin ? parseFloat(product.customMargin) : null;
      const marginType = product.marginType || 'percent'; // Default a 'percent' si no está definido
      
      let suggestedPriceNum = 0;
      if (lowestPrice > 0) {
        if (customMarginValue !== null && product.customMargin !== '') { // Hay un margen personalizado y no está vacío
          if (marginType === 'fixed') {
            suggestedPriceNum = lowestPrice + customMarginValue;
          } else { // Es 'percent'
            const marginToUse = customMarginValue;
      const marginMultiplier = 1 + (marginToUse / 100);
            suggestedPriceNum = lowestPrice * marginMultiplier;
          }
        } else { // No hay margen personalizado o está vacío, usar el general (que es siempre porcentaje)
          const marginToUse = defaultMargin;
          const marginMultiplier = 1 + (marginToUse / 100);
          suggestedPriceNum = lowestPrice * marginMultiplier;
        }
      }
      
      const suggestedPrice = suggestedPriceNum > 0 ? suggestedPriceNum.toFixed(2) : '0.00';
      
      // Calcular precio individual
      let precioIndividual = '0.00';
      let precioCaja = suggestedPrice;
      
      // Si hay información de unidades por caja, calcular precio individual
      if (product.unidadesPorCaja && parseFloat(product.unidadesPorCaja) > 0 && lowestPrice > 0) {
        // Precio por unidad
        const unidadesPorCaja = parseFloat(product.unidadesPorCaja);
        precioIndividual = (parseFloat(suggestedPrice) / unidadesPorCaja).toFixed(2);
      }
      
      // Construir HTML
      let infoHTML = `
        <div class="product-card">
          <div class="product-header">
            <img src="${mainLogo}" alt="${product.company || 'Logo'}" class="product-logo" />
            <div class="header-text">
              <h2 class="product-name">${escapeHtml(name)}</h2>
              <p class="product-code">${product.numero ? '#' + product.numero : ''}</p>
            </div>
          </div>
          
          <div class="product-details">
            <div class="detail-item">
              <span class="detail-label">Departamento:</span>
              <span class="detail-value">${product.category || 'General'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Stock:</span>
              <span class="detail-value">${product.stock || '0'} ${product.unit || 'pz'}</span>
            </div>`;
      
      // Agregar información de la caja si existe
      if (product.unidadesPorCaja || product.paquetesPorCaja) {
        infoHTML += `
            <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">
            <h4 style="margin: 10px 0 5px; font-size: 0.95rem; color: #333;">Información de la Caja</h4>`;
        
        if (product.unidadesPorCaja) {
          infoHTML += `
            <div class="detail-item">
              <span class="detail-label">Unidades por caja:</span>
              <span class="detail-value">${product.unidadesPorCaja}</span>
            </div>`;
        }
        
        if (product.paquetesPorCaja) {
          infoHTML += `
            <div class="detail-item">
              <span class="detail-label">Paquetes por caja:</span>
              <span class="detail-value">${product.paquetesPorCaja}</span>
            </div>`;
        }
      }
      
      infoHTML += `
          </div>
          
          <div class="price-list">
            <h3 class="section-title">Precios</h3>
            <div class="prices-container">`;
      
      // Agregar precios
      if (product.prices && product.prices.length) {
        product.prices.forEach(p => {
          let compLogo = APP_DEFAULT_LOGO;
          const comp = getCompanies().find(c => c.name === p.company);
          if (comp && comp.image) compLogo = comp.image;
          
          infoHTML += `
            <div class="price-row">
              <div class="price-company">
                <img src="${compLogo}" alt="${p.company}" class="company-logo" />
                <span class="company-name">${p.company}</span>
              </div>
              <div class="price-value">${p.price}</div>
            </div>`;
        });
        
        // Precios sugeridos (caja e individual)
        infoHTML += `
          <div style="margin-top: 15px;">
            <div class="suggested-price" style="margin-bottom: 8px;">
              <div class="suggested-label">Precio sugerido por caja</div>
              <div class="suggested-value">${precioCaja}</div>
            </div>`;
          
        // Mostrar precio individual si hay unidades por caja
        if (product.unidadesPorCaja && parseFloat(product.unidadesPorCaja) > 0) {
          infoHTML += `
            <div class="suggested-price" style="background: #555;">
              <div class="suggested-label">Precio sugerido por unidad</div>
              <div class="suggested-value">${precioIndividual}</div>
            </div>`;
        }
        
        infoHTML += `</div>`;
      } else {
        infoHTML += `<p class="no-prices">No hay precios definidos.</p>`;
      }
      
      infoHTML += `
            </div>
          </div>
        </div>`;
      
      document.getElementById('infoContent').innerHTML = infoHTML;
      document.getElementById('infoModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeInfoModal() {
      document.getElementById('infoModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    /* ===== FUNCIONES DE COMPAÑÍA ===== */
    // Event listener para cerrar el popup al hacer clic en cualquier parte
    document.addEventListener('click', function(event) {
      const target = event.target;

      // 1. Company Popup
      const companyPopup = document.getElementById('companyPopup');
      const companyPopupButton = document.querySelector('.store-icon-btn'); 
      
      if (companyPopup && companyPopup.classList.contains('show')) {
        // Cerrar si el clic NO es en el botón que lo abre Y NO es dentro del popup
        if (companyPopupButton && !companyPopupButton.contains(target) && !companyPopup.contains(target)) {
          companyPopup.classList.remove('show');
        }
      }

      // 2. View Options Popup
      const viewOptionsPopup = document.getElementById('viewOptions');
      // El botón de opciones de vista ahora es el segundo .header-icon-btn en .header-icon-group-right
      const viewOptionsButton = document.querySelector('.header-icon-group-right .header-icon-btn:nth-child(2)'); 

      if (viewOptionsPopup && viewOptionsPopup.style.display === 'flex') {
        // Cerrar si el clic NO es en el botón que lo abre Y NO es dentro del popup
        if (viewOptionsButton && !viewOptionsButton.contains(target) && !viewOptionsPopup.contains(target)) {
          toggleViewOptions(); // Esta función maneja el cierre/apertura
        }
      }

      // 3. Info Badge Modal (Carrito)
      const infoBadgeModal = document.getElementById('infoBadgeModal');
      const infoBadgeButton = document.getElementById('infoBadgeBtn'); // Botón que abre este modal

      if (infoBadgeModal && infoBadgeModal.classList.contains('show')) {
        const modalContent = infoBadgeModal.querySelector('.info-badge-modal-content');
        // Cerrar si el clic es en el backdrop (directamente en infoBadgeModal pero no en su contenido) 
        // O si es fuera del contenido y NO en el botón que lo abre.
        if (target === infoBadgeModal || 
            (modalContent && !modalContent.contains(target) && infoBadgeButton && !infoBadgeButton.contains(target)) ) {
          closeInfoBadgeModal();
        }
      }

      // 4. Collections Menu
      const collectionsMenuButton = document.querySelector('.collections-menu-btn'); // Botón de colecciones
      const collectionsMenu = document.getElementById('collectionsMenu'); // Menú de colecciones

      if (collectionsMenu && collectionsMenu.classList.contains('show')) {
        // Cerrar si el clic NO es en el botón que lo abre Y NO es dentro del popup
        if (collectionsMenuButton && !collectionsMenuButton.contains(target) && !collectionsMenu.contains(target)) {
          collectionsMenu.classList.remove('show');
           document.removeEventListener('click', closeCollectionsMenuOutside); // Asegurar que se remueve el listener si se cierra por aquí
        }
      }
    });
    // --- FIN NUEVAS FUNCIONES --- (Este comentario podría haber sido de una tanda anterior de funciones)

    function toggleCompanyPopup(event) {
      if (event) {
        event.stopPropagation();
      }
      
      const popup = document.getElementById('companyPopup');
      popup.classList.toggle('show');
      
      if (popup.classList.contains('show')) {
        buildCompanyPopup();
      }
    }

    function buildCompanyPopup() {
      const popup = document.getElementById('companyPopup');
      popup.innerHTML = '';
      
      // Opción "Todas"
      const allItem = document.createElement('div');
      allItem.className = 'company-item';
      // No mostrar logo para "Todas" en el popup, solo texto, o un icono genérico si se prefiere.
      allItem.innerHTML = `<span class="material-icons" style="margin-right:10px; font-size:20px; vertical-align:middle;">storefront</span><span>Todas las Compañías</span>`;
      allItem.onclick = function(e) {
        e.stopPropagation(); // Add this line
        selectCompany('');
      };
      popup.appendChild(allItem);
      
      // Opciones de compañías
      getCompanies().forEach(c => {
        const item = document.createElement('div');
        item.className = 'company-item';
        item.innerHTML = `<img src="${c.image || APP_DEFAULT_LOGO}" alt="${c.name}" /><span>${c.name}</span>`;
        item.onclick = function(e) {
          e.stopPropagation(); // Add this line
          selectCompany(c.name);
        };
        popup.appendChild(item);
      });
    }

    function selectCompany(name) {
      console.log("Seleccionando compañía:", name); // Log para depuración
      currentCompanyFilter = name;
      
      toggleCompanyPopup(); // Esto debería cerrar el popup
      saveFiltersAndState();
      renderTabs();
      updateCurrentCompanyLogo();
    }

    function updateCurrentCompanyLogo() {
      const storeButton = document.querySelector('.store-icon-btn');
      if (storeButton) {
        if (!currentCompanyFilter) {
          storeButton.title = "Seleccionar Compañía (Todas)";
        } else {
          storeButton.title = `Compañía: ${currentCompanyFilter}`;
        }
      }
      
      const iconContainer = document.getElementById('storeButtonIconContainer');
      if (!iconContainer) return;

      if (!currentCompanyFilter) {
        // Mostrar icono storefront si "Todas las Compañías" está seleccionado
        iconContainer.innerHTML = '<span class="material-icons">storefront</span>';
      } else {
        const comp = getCompanies().find(c => c.name === currentCompanyFilter);
        if (comp && comp.image) {
          // Mostrar imagen de la compañía si existe
          iconContainer.innerHTML = `<img src="${comp.image}" alt="${escapeHtml(comp.name)}">`;
        } else {
          // Mostrar icono storefront si la compañía no tiene imagen
          iconContainer.innerHTML = '<span class="material-icons">storefront</span>';
        }
      }
    }

    /* ===== FUNCIONES DE CONFIGURACIÓN ===== */
    function openSettingsTab() {
      document.getElementById('settingsOverlay').classList.add('show');
      document.getElementById('settingsTab').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
      
      // Cargar margen predeterminado
      document.getElementById('defaultMarginPercent').value = localStorage.getItem('defaultMarginPercent') || '45';
      
      // Mostrar listas
      renderSettingsLists();
    }

    function closeSettingsTab() {
      document.getElementById('settingsOverlay').classList.remove('show');
      document.getElementById('settingsTab').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function renderSettingsLists() {
      // Unidades
      const unitsList = document.getElementById('unitsList');
      unitsList.innerHTML = '';
      
      getUnits().forEach(unit => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        item.innerHTML = `
          <span>${unit}</span>
          <div class="settings-actions">
            <button class="rename-btn"><span class="material-icons">edit</span></button>
            <button class="remove-btn"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.rename-btn').onclick = function() {
          const newName = prompt('Renombrar unidad:', unit);
          if (newName && newName.trim()) {
            const units = getUnits();
            const index = units.indexOf(unit);
            if (index !== -1) {
              units[index] = newName.trim();
              localStorage.setItem(UNITS_KEY, JSON.stringify(units));
              renderSettingsLists();
            }
          }
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          const units = getUnits();
          const index = units.indexOf(unit);
          if (index !== -1) {
            units.splice(index, 1);
            localStorage.setItem(UNITS_KEY, JSON.stringify(units));
            renderSettingsLists();
          }
        };
        
        unitsList.appendChild(item);
      });
      
      // Presentaciones (similar a unidades)
      const presentationsList = document.getElementById('presentationsList');
      presentationsList.innerHTML = '';
      
      getPresentations().forEach(presentation => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        item.innerHTML = `
          <span>${presentation}</span>
          <div class="settings-actions">
            <button class="rename-btn"><span class="material-icons">edit</span></button>
            <button class="remove-btn"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.rename-btn').onclick = function() {
          const newName = prompt('Renombrar presentación:', presentation);
          if (newName && newName.trim()) {
            const presentations = getPresentations();
            const index = presentations.indexOf(presentation);
            if (index !== -1) {
              presentations[index] = newName.trim();
              localStorage.setItem(PRESENTATIONS_KEY, JSON.stringify(presentations));
              renderSettingsLists();
            }
          }
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          const presentations = getPresentations();
          const index = presentations.indexOf(presentation);
          if (index !== -1) {
            presentations.splice(index, 1);
            localStorage.setItem(PRESENTATIONS_KEY, JSON.stringify(presentations));
            renderSettingsLists();
          }
        };
        
        presentationsList.appendChild(item);
      });
      
      // Categorías (similar a unidades)
      const categoriesList = document.getElementById('categoriesList');
      categoriesList.innerHTML = '';
      
      getCategories().forEach(category => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        item.innerHTML = `
          <span>${category}</span>
          <div class="settings-actions">
            <button class="rename-btn"><span class="material-icons">edit</span></button>
            <button class="remove-btn"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.rename-btn').onclick = function() {
          const newName = prompt('Renombrar categoría:', category);
          if (newName && newName.trim()) {
            const categories = getCategories();
            const index = categories.indexOf(category);
            if (index !== -1) {
              categories[index] = newName.trim();
              localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
              renderSettingsLists();
            }
          }
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          const categories = getCategories();
          const index = categories.indexOf(category);
          if (index !== -1) {
            categories.splice(index, 1);
            localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
            renderSettingsLists();
          }
        };
        
        categoriesList.appendChild(item);
      });
      
      // Compañías
      const companiesList = document.getElementById('companiesList');
      companiesList.innerHTML = '';
      
      getCompanies().forEach((company, index) => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        
        // Mostrar miniatura de logo si existe
        let logoPreview = '';
        if (company.image) {
          logoPreview = `<img src="${company.image}" alt="${company.name}" style="width: 25px; height: 25px; border-radius: 50%; margin-right: 10px; object-fit: cover;">`;
        }
        
        let companyDetails = `<span>${logoPreview}${company.name}`;
        if (company.phone) {
          companyDetails += ` <small style="color: #777;">(${company.phone})</small>`;
        }
        companyDetails += `</span>`;
        
        item.innerHTML = `
          ${companyDetails}
          <div class="settings-actions">
            <button class="edit-btn" title="Editar compañía"><span class="material-icons">edit</span></button>
            <button class="remove-btn" title="Eliminar compañía"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.edit-btn').onclick = function() {
          editCompany(index);
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          if (confirm(`¿Seguro que deseas eliminar la compañía "${company.name}"?`)) {
            const companies = getCompanies();
            companies.splice(index, 1);
            localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
            renderSettingsLists();
            updateCurrentCompanyLogo();
          }
        };
        
        companiesList.appendChild(item);
      });
    }
    
    function editCompany(index) {
      const companies = getCompanies();
      const company = companies[index];
      
      // Crear modal para editar
      const modalHTML = `
        <div id="editCompanyModal" class="modal" style="display: flex; opacity: 1; pointer-events: auto;">
          <div class="modal-content" style="max-width: 400px;">
            <h3>Editar Compañía</h3>
            <div class="form-group">
              <label for="editCompanyName">Nombre:</label>
              <input type="text" id="editCompanyName" value="${company.name}" />
            </div>
            <div class="form-group" style="margin-top: 10px;">
              ${company.image ? `<div style="text-align:center; margin-bottom: 10px;"><img src="${company.image}" style="max-width: 100px; max-height: 100px; margin: 0 auto;"></div>` : ''}
              <label for="editCompanyLogoFile">Actualizar logo (archivo):</label>
              <input type="file" id="editCompanyLogoFile" accept="image/*" />
            </div>
            <div style="margin-top: 8px; text-align: center;">
              <label>O</label>
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label for="editCompanyLogoUrl">URL del logo:</label>
              <input type="text" id="editCompanyLogoUrl" value="${company.image || ''}" placeholder="URL del logo" />
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label for="editCompanyPhone">Número de Teléfono:</label>
              <input type="tel" id="editCompanyPhone" value="${company.phone || ''}" placeholder="Ej. +1234567890" />
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label for="editCompanyMessage">Mensaje Predeterminado:</label>
              <textarea id="editCompanyMessage" placeholder="Ej. Hola, te envío la orden..." rows="3">${company.defaultMessage || ''}</textarea>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
              <button onclick="saveCompanyEdit(${index})" class="save-btn">Guardar</button>
              <button onclick="closeEditCompanyModal()" class="cancel-btn">Cancelar</button>
            </div>
          </div>
        </div>
      `;
      
      // Añadir modal al DOM
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHTML;
      document.body.appendChild(modalContainer);
    }
    
    function closeEditCompanyModal() {
      const modal = document.getElementById('editCompanyModal');
      if (modal) {
        modal.remove();
      }
    }
    
    function saveCompanyEdit(index) {
      const companies = getCompanies();
      const nameInput = document.getElementById('editCompanyName');
      const logoUrlInput = document.getElementById('editCompanyLogoUrl');
      const logoFileInput = document.getElementById('editCompanyLogoFile');
      const phoneInput = document.getElementById('editCompanyPhone');
      const messageInput = document.getElementById('editCompanyMessage');
      
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const defaultMessage = messageInput.value.trim();
      
      if (!name) {
        alert("Por favor ingresa un nombre para la compañía");
        return;
      }
      
      // Verificar si el nombre ya existe (excepto el mismo índice)
      if (companies.some((c, i) => i !== index && c.name === name)) {
        alert("Ya existe una compañía con ese nombre");
        return;
      }
      
      // Verificar si se seleccionó un archivo
      if (logoFileInput.files && logoFileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Actualizar con la imagen base64
          companies[index].name = name;
          companies[index].image = e.target.result;
          companies[index].phone = phone;
          companies[index].defaultMessage = defaultMessage;
          
          localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
          closeEditCompanyModal();
          renderSettingsLists();
          updateCurrentCompanyLogo();
        };
        reader.readAsDataURL(logoFileInput.files[0]);
      } 
      // Si no hay archivo, usar URL si está presente
      else if (logoUrlInput.value.trim()) {
        companies[index].name = name;
        companies[index].image = logoUrlInput.value.trim();
        companies[index].phone = phone;
        companies[index].defaultMessage = defaultMessage;
        
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        closeEditCompanyModal();
        renderSettingsLists();
        updateCurrentCompanyLogo();
      }
      // Solo actualizar nombre
      else {
        companies[index].name = name;
        // Mantener la imagen existente
        companies[index].phone = phone;
        companies[index].defaultMessage = defaultMessage;
        
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        closeEditCompanyModal();
        renderSettingsLists();
        updateCurrentCompanyLogo();
      }
    }

    function addUnit() {
      const input = document.getElementById('newUnitInput');
      const value = input.value.trim();
      
      if (value) {
        const units = getUnits();
        if (!units.includes(value)) {
          units.push(value);
          localStorage.setItem(UNITS_KEY, JSON.stringify(units));
          input.value = '';
          renderSettingsLists();
        }
      }
    }

    function addPresentation() {
      const input = document.getElementById('newPresentationInput');
      const value = input.value.trim();
      
      if (value) {
        const presentations = getPresentations();
        if (!presentations.includes(value)) {
          presentations.push(value);
          localStorage.setItem(PRESENTATIONS_KEY, JSON.stringify(presentations));
          input.value = '';
          renderSettingsLists();
        }
      }
    }

    function addCategory() {
      const input = document.getElementById('newCategoryInput');
      const value = input.value.trim();
      
      if (value) {
        const categories = getCategories();
        if (!categories.includes(value)) {
          categories.push(value);
          localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
          input.value = '';
          renderSettingsLists();
        }
      }
    }

    function addCompany() {
      const nameInput = document.getElementById('newCompanyName');
      const logoUrlInput = document.getElementById('newCompanyLogoUrl');
      const logoFileInput = document.getElementById('newCompanyLogoFile');
      const phoneInput = document.getElementById('newCompanyPhone');
      const messageInput = document.getElementById('newCompanyMessage');
      
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const defaultMessage = messageInput.value.trim();
      
      if (!name) {
        alert("Por favor ingresa un nombre para la compañía");
        return;
      }
      
      const companies = getCompanies();
      if (companies.some(c => c.name === name)) {
        alert("Ya existe una compañía con ese nombre");
        return;
      }
      
      // Verificar si se seleccionó un archivo
      if (logoFileInput.files && logoFileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Guardar la imagen como base64
          companies.push({ 
            name: name, 
            image: e.target.result,
            phone: phone,
            defaultMessage: defaultMessage
          });
          localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
          
          // Limpiar inputs
          nameInput.value = '';
          logoUrlInput.value = '';
          logoFileInput.value = '';
          phoneInput.value = '';
          messageInput.value = '';
          
          renderSettingsLists();
          alert("Compañía agregada correctamente con logo local");
        };
        reader.readAsDataURL(logoFileInput.files[0]);
      } 
      // Si no hay archivo, usar URL si está presente
      else if (logoUrlInput.value.trim()) {
        companies.push({ 
          name: name, 
          image: logoUrlInput.value.trim(),
          phone: phone,
          defaultMessage: defaultMessage
        });
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        
        // Limpiar inputs
        nameInput.value = '';
        logoUrlInput.value = '';
        logoFileInput.value = '';
        phoneInput.value = '';
        messageInput.value = '';
        
        renderSettingsLists();
        alert("Compañía agregada correctamente sin logo");
      }
      // Sin logo
      else {
        companies.push({ 
          name: name, 
          image: '',
          phone: phone,
          defaultMessage: defaultMessage
        });
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        
        // Limpiar inputs
        nameInput.value = '';
        logoUrlInput.value = '';
        logoFileInput.value = '';
        phoneInput.value = '';
        messageInput.value = '';
        
        renderSettingsLists();
        alert("Compañía agregada correctamente sin logo");
      }
    }

    function saveDefaultMargin() {
      const input = document.getElementById('defaultMarginPercent');
      const value = input.value.trim();
      
      if (value && !isNaN(parseFloat(value))) {
        localStorage.setItem('defaultMarginPercent', value);
        alert('Margen actualizado correctamente');
      } else {
        alert('Por favor ingresa un valor numérico válido');
        input.value = localStorage.getItem('defaultMarginPercent') || '45';
      }
    }

    function resetCustomMargin() {
      document.getElementById('editCustomMargin').value = '';
    }

    /* ===== FUNCIONES DE EXPORTAR/IMPORTAR ===== */
    function openExportModal() {
      document.getElementById('exportModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function confirmExport() {
      const items = getAllItems();
      const jsonStr = JSON.stringify(items, null, 2);
      const filename = "inventario_" + new Date().toISOString().split('T')[0] + ".json";
      
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      closeExportModal();
    }

    function triggerImport() {
      document.getElementById('importFile').click();
    }

    function importInventoryFile(file) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedItems = JSON.parse(e.target.result);
          setAllItems(importedItems);
          renderTabs();
          alert("Inventario importado con éxito");
        } catch (err) {
          console.error("Error al importar:", err);
          alert("Error al leer el archivo JSON. Revisa que sea un formato válido.");
        }
      };
      
      reader.readAsText(file);
    }

    /* ===== FUNCIONES DE BORRAR CANTIDADES ===== */
    function openDeletePedidoModal() {
      document.getElementById('deletePedidoModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeDeletePedidoModal() {
      document.getElementById('deletePedidoModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function confirmDeletePedido() {
      const items = getAllItems();
      
      for (const name in items) {
        if (items[name]) {
          items[name].pedidoQty = 0;
          items[name].creditQty = 0; // También borrar créditos
        }
      }
      
      setAllItems(items);
      renderTabs();
      closeDeletePedidoModal();
    }

    function openDeleteInventarioModal() {
      document.getElementById('deleteInventarioModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeDeleteInventarioModal() {
      document.getElementById('deleteInventarioModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function confirmDeleteInventario() {
      const items = getAllItems();
      
      for (const name in items) {
        if (items[name]) {
          items[name].inventarioQty = 0;
        }
      }
      
      setAllItems(items);
      renderTabs();
      closeDeleteInventarioModal();
    }

    /* ===== FUNCIONES PDF MEJORADAS ===== */
    function openShareModal() {
      document.getElementById('shareModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function sharePDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = createPDFDocument();
        
        // Compartir el PDF
        const pdfBlob = doc.output('blob');
        const activeTabName = document.querySelector('.tab.active').textContent;
        const title = activeTabName.toUpperCase();
        const file = new File([pdfBlob], title + ".pdf", { type: "application/pdf" });
        
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          navigator.share({
            files: [file],
            title: title,
            text: "Aquí está tu " + title
          }).catch(err => {
            console.error("Error al compartir:", err);
            downloadPDF();
          });
        } else {
          downloadPDF();
        }
        
        closeShareModal();
      } catch (e) {
        console.error("Error al generar PDF:", e);
        alert("Error al generar el PDF. Descargando en su lugar.");
        downloadPDF();
      }
    }

    function downloadPDF() {
      try {
        const doc = createPDFDocument();
        const activeTabName = document.querySelector('.tab.active').textContent;
        doc.save(activeTabName.toUpperCase() + ".pdf");
        closeShareModal();
      } catch (e) {
        console.error("Error al generar PDF:", e);
        alert("Error al generar el PDF.");
      }
    }

    function createPDFDocument() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Configuración inicial
      doc.setFont('helvetica', 'normal');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15; // Reducir margen para más espacio
      let yPos = margin + 5;

      // Título del Documento
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text("ORDER", pageWidth / 2, yPos, { align: 'center' }); // Título cambiado
      yPos += 10;

      // Fecha actual
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
      doc.text('Fecha: ' + currentDate, pageWidth - margin, yPos, { align: 'right' });
      yPos += 5; // Espacio después de la fecha
      
      // Información de la Compañía (si está filtrada)
      if (currentCompanyFilter) {
        const company = getCompanies().find(c => c.name.toLowerCase() === currentCompanyFilter.toLowerCase());
        if (company) {
          yPos += 5; // Espacio antes de la info de la compañía
          const companyNameForPDF = company.name.toUpperCase();
          if (company.image) {
            try {
              const logoWidth = 20;
              const logoHeight = 20;
              const companyNameWidth = doc.getTextWidth(companyNameForPDF);
              const totalHeaderWidth = logoWidth + 5 + companyNameWidth;
              let logoX = (pageWidth - totalHeaderWidth) / 2;
              let textX = logoX + logoWidth + 5;
              
              doc.addImage(company.image, 'PNG', logoX, yPos - (logoHeight/2) - 2 , logoWidth, logoHeight, undefined, 'FAST');
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text(companyNameForPDF, textX, yPos); // Mostrar nombre solo una vez
          } catch (e) {
            console.error("Error al cargar logo:", e);
              doc.setFontSize(14);
              doc.setFont('helvetica', 'bold');
              doc.text(companyNameForPDF, pageWidth / 2, yPos, { align: 'center' });
          }
        } else {
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(companyNameForPDF, pageWidth / 2, yPos, { align: 'center' });
          }
          yPos += 10; // Espacio después de la info de la compañía
        }
      }
      
      // Línea separadora horizontal (opcional, ya que autoTable tiene sus propias líneas)
      // doc.setDrawColor(180, 180, 180);
      // doc.setLineWidth(0.3);
      // doc.line(margin, yPos, pageWidth - margin, yPos);
      // yPos += 8;
      
      // No dibujar encabezados manualmente, autoTable lo hará.
      // const tableStartY = yPos;
      // doc.setFontSize(11);
      // ... (código de dibujo manual de encabezados eliminado)
      // yPos = tableStartY + 7;
      
      // --- Recopilación de Items y Totales (sin cambios) ---
      const items = getAllItems();
      let entries = Object.entries(items).filter(([, data]) => {
        return data && (
          (data.pedidoQty && parseQuantity(data.pedidoQty) > 0) || 
          (data.creditQty && parseQuantity(data.creditQty) > 0)
        );
      });

      if (currentCompanyFilter) { // Aplicar filtro de compañía a los items del PDF
        entries = entries.filter(([, data]) => data && data.company && data.company.toLowerCase() === currentCompanyFilter.toLowerCase());
      }
      // No aplicamos filtro de búsqueda (searchTerm) al PDF, usualmente se quiere el pedido completo de la compañía.

      entries = sortEntriesByCurrentMode(entries); // Usar el modo de orden actual

      let distinctItemCountForPDF = 0;
      let totalQuantitySumForPDF = 0;
      const bodyData = [];

      entries.forEach(([name, data]) => {
        if (data.pedidoQty && parseQuantity(data.pedidoQty) > 0) {
          distinctItemCountForPDF++; // Contar solo una vez si tiene pedido y crédito
          totalQuantitySumForPDF += parseQuantity(data.pedidoQty);
          bodyData.push([
            name,
            formatQuantity(parseQuantity(data.pedidoQty)),
            data.presentation || 'caja'
          ]);
        }
        if (data.creditQty && parseQuantity(data.creditQty) > 0) {
          if (!(data.pedidoQty && parseQuantity(data.pedidoQty) > 0)) {
             // Solo contar como item distinto si no fue contado por pedidoQty
            distinctItemCountForPDF++; 
          }
          totalQuantitySumForPDF += parseQuantity(data.creditQty);
          bodyData.push([
            name + " (CRÉDITO)",
            formatQuantity(parseQuantity(data.creditQty)),
            data.creditPresentation || data.presentation || 'caja'
          ]);
        }
      });
      // --- Fin Recopilación ---

      doc.autoTable({
        startY: yPos, // autoTable tomará yPos como el inicio
        head: [['PRODUCTO', 'CANT.', 'UNIDAD']], // Definir encabezados para autoTable
        body: bodyData,
        theme: 'grid',
        margin: { left: margin, right: margin },
        styles: { fontSize: 9, cellPadding: 1.5, lineColor: [200,200,200], lineWidth: 0.1 },
        headStyles: { fillColor: [230, 230, 230], textColor: [50,50,50], fontSize: 10, fontStyle: 'bold', cellPadding: 2 },
        columnStyles: {
          0: { cellWidth: pageWidth - margin * 2 - 30 - 25 }, // Producto
          1: { cellWidth: 25, halign: 'center' }, // Cantidad
          2: { cellWidth: 30, halign: 'center' }  // Unidad
        },
        didDrawPage: function (data) {
          // Pie de página
          doc.setFontSize(8);
          doc.setTextColor(150, 150, 150);
          doc.text('Página ' + doc.internal.getNumberOfPages(), pageWidth - margin, pageHeight - 7, { align: 'right' });
          doc.text('Generado el ' + new Date().toLocaleString('es-ES', {dateStyle: 'medium', timeStyle: 'short'}), margin, pageHeight - 7);
        },
        // Usar yPos de la tabla para el resumen
        didParseCell: function(data) {
            if (data.section === 'body' && data.row.raw[0].includes("(CRÉDITO)")) {
                data.cell.styles.textColor = [200, 0, 0]; // Color rojo para créditos
                data.cell.styles.fontStyle = 'italic';
            }
        }
      });

      yPos = doc.lastAutoTable.finalY + 10; // Actualizar yPos después de la tabla

      // Resumen del Pedido
      doc.setFontSize(10);
          doc.setFont('helvetica', 'bold');
      doc.text("RESUMEN DEL PEDIDO:", margin, yPos);
      yPos += 6;
          doc.setFont('helvetica', 'normal');
      doc.text(`Total de Ítems Distintos: ${distinctItemCountForPDF}`, margin + 5, yPos);
      yPos += 5;
      doc.text(`Total de Unidades: ${formatQuantity(totalQuantitySumForPDF)}`, margin + 5, yPos);

      // Restaurar color de texto a negro para el resto del documento (ya no es necesario aquí)
      // doc.setTextColor(0, 0, 0);
      
      return doc;
    }

    // Ocultar splash y cargar la aplicación
    const splash = document.getElementById('splash');
    window.onload = function() {
      try {
        // Ocultar splash después de 2 segundos
        setTimeout(function() {
          splash.style.display = 'none';
          // Inicializar la aplicación
          initApp();
          
          // Limpiar cualquier texto de código que aparezca en la interfaz
          cleanupCodeText();
          
          // Configurar controlador para guardar estado al cerrar/recargar
          window.addEventListener('beforeunload', saveFiltersAndState);
        }, 2000);
      } catch (error) {
        // En caso de error, garantizar que la aplicación al menos se muestre
        console.error("Error al iniciar la aplicación:", error);
        splash.style.display = 'none';
        alert("Hubo un problema al cargar la aplicación. Se realizará una restauración.");
        
        // Intentar recuperar la aplicación con valores por defecto
        try {
          initApp();
        } catch (e) {
          document.body.innerHTML = '<div style="text-align:center; padding:50px; font-family:sans-serif;"><h2>Error al cargar la aplicación</h2><p>Por favor recarga la página o borra los datos de navegación.</p></div>';
        }
      }
    };
    
    // Guardar estado al desplazarse
    window.addEventListener('scroll', function() {
      // Usar debounce para evitar llamadas excesivas
      clearTimeout(window.scrollDebounce);
      window.scrollDebounce = setTimeout(function() {
        lastScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        localStorage.setItem('scrollPosition', lastScrollPosition);
      }, 300);
    });

    function saveCreditInfo() {
      const creditModalElement = document.getElementById('creditModal');
      if (!creditModalElement) {
        console.error("Modal de crédito no encontrado al guardar");
        return;
      }

      const productName = creditModalElement.dataset.editingProduct;
      if (!productName) {
        alert("Error: No se pudo identificar el producto para el crédito.");
        closeCreditModal();
        return;
      }

      const items = getAllItems();
      if (!items[productName]) {
        alert("Error: Producto no encontrado al guardar el crédito.");
        closeCreditModal();
        return;
      }

      const creditQtyValue = document.getElementById('creditQty').value.trim();
      const creditPresentationValue = document.getElementById('creditPresentation').value;
      
      // Validar y formatear la cantidad usando las funciones existentes
      const parsedCreditQty = parseQuantity(creditQtyValue);

      items[productName].creditQty = formatQuantity(parsedCreditQty);
      items[productName].creditPresentation = creditPresentationValue;
      
      // Si la cantidad final es 0, podríamos considerar limpiar creditPresentation
      if (items[productName].creditQty === 0 || items[productName].creditQty === '0') {
        // items[productName].creditPresentation = ''; // Opcional: resetear si no hay cantidad
      }

      setAllItems(items);
      closeCreditModal();
      renderTabs(); 
    }

    function closeCreditModal() {
      const creditModalElement = document.getElementById('creditModal');
      if (!creditModalElement) {
        console.error("Modal de crédito no encontrado al cerrar");
        return;
      }
      creditModalElement.classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
      delete creditModalElement.dataset.editingProduct; // Limpiar el atributo data
    }

    function removeCredit(productName) {
      const items = getAllItems();
      if (items[productName]) {
        items[productName].creditQty = 0; // O null, para ser consistentes con "sin cantidad"
        items[productName].creditPresentation = ''; // O null
        setAllItems(items);
        renderTabs(); // Para refrescar la vista y que el ítem de crédito desaparezca
      } else {
        console.warn("Producto no encontrado al intentar remover crédito:", productName);
      }
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchInput').focus();
      document.querySelector('.clear-search-btn').style.display = 'none';
      updateSearch('');
    }

    function toggleFullScreen() {
      // ... existing code ...
    }

    // ===== FUNCIONES RESTAURADAS =====
    // Función para ordenar entradas según el modo seleccionado
    function sortEntriesByCurrentMode(entries) {
      const sortModeToUse = sortMode; // Usar la variable global sortMode

      if (sortModeToUse === 'byCustomOrder') {
        return entries.sort((a, b) => {
          const orderA = a[1]?.customSortOrder ?? Number.MAX_SAFE_INTEGER;
          const orderB = b[1]?.customSortOrder ?? Number.MAX_SAFE_INTEGER;
          if (orderA === orderB) {
            return a[0].localeCompare(b[0]);
          }
          return orderA - orderB;
        });
      }
      if (sortModeToUse === 'byNumberAsc') {
        return entries.sort((a, b) => {
          const numA = parseInt(a[1]?.numero || "0", 10);
          const numB = parseInt(b[1]?.numero || "0", 10);
          if (numA === numB) {
            return a[0].localeCompare(b[0]);
          }
          return numA - numB;
        });
      }
      else if (sortModeToUse === 'byNumberDesc') {
        return entries.sort((a, b) => {
          const numA = parseInt(a[1]?.numero || "0", 10);
          const numB = parseInt(b[1]?.numero || "0", 10);
          if (numA === numB) {
            return a[0].localeCompare(b[0]);
          }
          return numB - numA;
        });
      }
      else if (sortModeToUse === 'byNameDesc') {
        return entries.sort((a, b) => b[0].localeCompare(a[0]));
      }
      else { // byNameAsc (default)
        return entries.sort((a, b) => a[0].localeCompare(b[0]));
      }
    }

    // Funciones para migración y orden personalizado
    function migrateOrderSystem() {
      const ORDER_SYSTEM_MIGRATED_KEY = 'orderSystemMigrated_v1';
      if (localStorage.getItem(ORDER_SYSTEM_MIGRATED_KEY)) {
        // console.log("El sistema de orden personalizado ya ha sido migrado."); // Comentado para reducir logs
        return;
      }

      console.log("Iniciando migración del sistema de orden personalizado...");
      const items = getAllItems();
      let entries = Object.entries(items);

      const currentEffectiveSortMode = localStorage.getItem('sortMode') || 'byNameAsc';
      
      let sortedEntriesForMigration = [...entries];

      if (currentEffectiveSortMode === 'byCustomOrder') {
         console.warn("Migrando con customOrder como base no es ideal, usando orden por nombre A-Z.");
         sortedEntriesForMigration.sort((a, b) => a[0].localeCompare(b[0]));
      } else {
        const tempSortModeForMigration = sortMode;
        sortMode = currentEffectiveSortMode;
        sortedEntriesForMigration = sortEntriesByCurrentMode(sortedEntriesForMigration);
        sortMode = tempSortModeForMigration;
      }

      let changesMade = false;
      sortedEntriesForMigration.forEach(([name, data], index) => {
        if (items[name] && items[name].customSortOrder === undefined) {
          items[name].customSortOrder = (index + 1) * 1000;
          changesMade = true;
        }
      });

      if (changesMade) {
        setAllItems(items);
        console.log("Migración completada. Se asignaron órdenes personalizadas iniciales.");
      } else {
        // console.log("No se necesitaron cambios en la migración o los ítems ya tenían customSortOrder."); // Comentado
      }
      localStorage.setItem(ORDER_SYSTEM_MIGRATED_KEY, 'true');
    }

    // Función para limpiar texto de código visible en la interfaz
    function cleanupCodeText() {
      const walker = document.createTreeWalker(
        document.body,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );

      const nodesToRemove = [];
      let node;

      while(node = walker.nextNode()) {
        if (node.nodeValue && (
            node.nodeValue.includes('logoFileInput.value') ||
            node.nodeValue.includes('companies.push') ||
            node.nodeValue.includes('localStorage.setItem(COMPANIES_KEY') ||
            node.nodeValue.includes('renderSettingsLists')
           )) {
          nodesToRemove.push(node);
        }
      }

      nodesToRemove.forEach(node => {
        if (node.parentNode) {
          node.parentNode.removeChild(node);
        }
      });

      // console.log("Cleanup ejecutado, programando siguiente en 2s."); // Comentado
      setTimeout(cleanupCodeText, 2000);
    }
    // ===== FIN FUNCIONES RESTAURADAS =====

    // Función para crear botones de incremento/decremento de cantidad
    function createQuantityButton(type, productName, tabType) {
      const btn = document.createElement('button');
      btn.type = "button";
      btn.className = 'quantity-btn';
      
      // Contenido del botón según el tipo
      if (type === 'decrease') {
        btn.innerHTML = '-';
      } else {
        btn.innerHTML = '+';
      }
      
      // Agregar datos y eventos
      btn.setAttribute('data-product', productName);
      btn.setAttribute('data-action', type);
      btn.setAttribute('data-tab', tabType);
      
      btn.onclick = function(event) {
        event.stopPropagation(); // Evitar que se propague a otros listeners
        
        const productName = this.getAttribute('data-product');
        const action = this.getAttribute('data-action');
        const tabType = this.getAttribute('data-tab');
        
      const items = getAllItems();
        if (!items[productName]) return false;
        
        // Determinar qué propiedad modificar según la pestaña actual
        let qtyProperty = '';
        if (tabType === 'pedido') qtyProperty = 'pedidoQty';
        else if (tabType === 'inventario') qtyProperty = 'stock';
        else return false; // No hacer nada en otra pestaña
        
        // Obtener valor actual (o 0 si no existe)
        const currentValue = items[productName][qtyProperty] || 0;
        
        // Convertir a número para operar
        const currentNum = parseQuantity(currentValue);
        
        // Calcular nuevo valor según la acción
        let newValue = currentNum;
        if (action === 'increase') {
          // Para incremento, sumar 1 o 0.5 si el valor actual es decimal
          newValue = currentNum + (Number.isInteger(currentNum) ? 1 : 0.5);
          } else {
          // Para decremento
          if (currentNum > 0) {
            // Si es menor o igual a 1, restar 0.5, sino restar 1
            newValue = currentNum <= 1 ? currentNum - 0.5 : currentNum - 1;
          }
          // Si el nuevo valor es muy cercano a cero, establecerlo a cero
          if (newValue < 0.1) newValue = 0;
        }
        
        // Guardar el nuevo valor
        items[productName][qtyProperty] = formatQuantity(newValue);
        setAllItems(items);
        
        // Actualizar la interfaz
        renderTabs();
        
        return false;
      };
      
      return btn;
    }

    /* ===== NUEVA FUNCIÓN PARA AJUSTAR MARGEN DEL CONTENIDO ===== */
    function adjustContentMargin() {
      const header = document.querySelector('.header');
      const contents = document.querySelectorAll('.content');
      if (header && contents.length > 0) {
        const headerHeight = header.offsetHeight;
        contents.forEach(content => {
          content.style.marginTop = headerHeight + 'px';
        });
        // console.log('Margen superior del contenido ajustado a: ' + headerHeight + 'px');
      }
    }

    // NUEVA FUNCIÓN updateInfoBadge
    function updateInfoBadge() {
      const infoBadgeCount = document.getElementById('infoBadgeCount');
      const infoBadgeIcon = document.getElementById('infoBadgeIcon'); // Para mostrar/ocultar si es necesario

      if (!infoBadgeCount || !infoBadgeIcon) {
        console.warn("Elementos del badge de información no encontrados.");
        return;
      }

      const items = getAllItems(); // Asegúrate que esto obtiene los items de la colección actual
      let itemCount = 0;

      Object.values(items).forEach(item => {
        if (item && item.pedidoQty && parseQuantity(item.pedidoQty) > 0) {
          itemCount++;
        }
      });

      infoBadgeCount.textContent = itemCount;

      // Opcional: Mostrar u ocultar el badge si el conteo es 0
      if (itemCount > 0) {
        infoBadgeCount.style.display = 'inline-block'; // O 'flex' dependiendo de tu CSS para centrar
      } else {
        infoBadgeCount.style.display = 'none';
      }
    }
    // FIN NUEVA FUNCIÓN updateInfoBadge
    
    // Script para Service Worker (Actualizaciones PWA)
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").then(reg => {
        reg.onupdatefound = () => {
          const nuevoSW = reg.installing;
          nuevoSW.onstatechange = () => {
            if (nuevoSW.state === "installed") {
              if (navigator.serviceWorker.controller) {
                if (confirm("Hay una nueva versión disponible. ¿Actualizar ahora?")) {
                  window.location.reload();
                }
              }
            }
          };
        };
      });
    }
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js").then(reg => {
      console.log("SW registrado:", reg.scope); // Mantenemos el log existente
      reg.onupdatefound = () => {
        const nuevoSW = reg.installing;
        nuevoSW.onstatechange = () => {
          if (nuevoSW.state === "installed") {
            if (navigator.serviceWorker.controller) {
              // Mostrar aviso para actualizar
              if (confirm("Hay una nueva versión disponible. ¿Actualizar ahora?")) {
                window.location.reload();
              }
            }
          }
        };
      };
    }).catch(error => {
      console.error("Error en el registro del SW:", error); // Mantenemos el catch existente
    });
  }
  </script>
</body>
</html>
