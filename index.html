<!DOCTYPE html>
<html lang="es">
  <link rel="manifest" href="manifest.json">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Gestión General de Pedidos e Inventario</title>

  <!-- Iconos Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <!-- Librerías jsPDF y jsPDF-AutoTable para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* ====== ESTILOS GENERALES ====== */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      color: #333;
      overflow-x: hidden;
      animation: fadeIn 0.6s ease forwards;
    }
    /* Clase para bloquear el scroll del body cuando un modal está abierto */
    body.body-modal-open {
      overflow-y: hidden;
    }
    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }

    /* ====== SPLASH ====== */
    .splash {
      position: fixed;
      inset: 0;
      background: #fff;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .logo {
      width: 300px;
      height: 300px;
      animation: blurInOut 3s forwards ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }
    @keyframes blurInOut {
      0% { opacity: 0; filter: blur(20px); transform: scale(0.7); }
      30% { opacity: 1; filter: blur(0); transform: scale(1); }
      60% { opacity: 1; filter: blur(0); transform: scale(1); }
      100% { opacity: 0; filter: blur(20px); transform: scale(0.7); }
    }

    /* ====== CABECERA Y TABS ====== */
    @keyframes slideDown {
      0% { transform: translateY(-50px); }
      100% { transform: translateY(0); }
    }
    .header {
      background: #fff;
      color: #000;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      animation: slideDown 0.5s ease;
      padding: 0.5rem; /* Ajustado para dar espacio a la nueva fila */
      border-bottom: 1px solid #ddd;
    }
    .header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      width: 100%; /* Asegurar que ocupe todo el ancho */
    }

    /* Nueva fila superior para iconos y búsqueda */
    .header-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.2rem 0; /* Padding vertical ligero, horizontal se maneja en header o por gap */
      margin-bottom: 0.6rem; /* Espacio antes del selector de compañía y tabs */
      gap: 0.5rem; /* Espacio entre grupos de iconos y barra de búsqueda */
    }

    .header-icon-group-left,
    .header-icon-group-right {
      display: flex;
      align-items: center;
      gap: 0.6rem; /* Espacio entre los iconos dentro de un grupo */
    }
    
    .header-icon-btn {
      background: #f0f0f0; /* Fondo gris claro */
      border: none;
      border-radius: 10px; /* Esquinas redondeadas */
      cursor: pointer;
      outline: none;
      width: 42px; /* Tamaño unificado */
      height: 42px; /* Tamaño unificado */
      display: flex;
      align-items: center;
      justify-content: center;
      padding:0;
      color: #333; /* Iconos oscuros por defecto */
      transition: background-color 0.2s ease;
      position: relative; /* Añadido para que los popups puedan posicionarse relativos a estos botones */
    }
    .header-icon-btn:hover {
      background: #e0e0e0; /* Un poco más oscuro al pasar el mouse */
    }
    .header-icon-btn .material-icons {
      font-size: 24px; /* Tamaño de icono ajustado */
    }

    /* Estilo específico para el botón de tienda */
    .header-icon-btn.store-icon-btn {
      background: #f0f0f0; /* Fondo claro, igual al botón de menú */
      color: #333; /* Color de icono oscuro por defecto */
    }
    .header-icon-btn.store-icon-btn:hover {
      background: #e0e0e0;
    }
    /* Contenedor para el icono/logo dentro del botón de tienda */
    #storeButtonIconContainer img {
      width: 26px; /* Ajustar tamaño del logo de compañía */
      height: 26px;
      border-radius: 4px; /* Ligeras esquinas redondeadas para el logo */
      object-fit: contain; /* Asegurar que el logo se vea completo */
    }

    /* Estilo para el botón de carrito (para el badge) */
    .header-icon-btn.cart-icon-btn {
      position: relative; /* Para posicionar el badge */
    }
    
    .tabs {
      display: flex;
      justify-content: center;
      gap: 1rem;
      width: 100%;
      background: #fff;
    }
    .tab {
      padding: 8px 10px;
      cursor: pointer;
      font-size: 1rem;
      color: #000;
    }
    .tab:hover { opacity: 0.8; }
    .tab.active { border-bottom: 2px solid #000; }

    /* BOTÓN SETTINGS - Ya no se usa posicionado absoluto, se integra en header-top-row */
    /* .settings-button { ... } */
    /* .settings-icon { ... } */

    /* BARRA DE BÚSQUEDA */
    .search-bar {
      display: flex;
      align-items: center;
      background: #f0f0f0; /* Consistente con botones */
      padding: 6px 12px; /* Ajustar padding */
      border-radius: 22px; /* Más redondeado, tipo píldora */
      flex-grow: 1; 
      margin: 0; /* Sin margen extra, el gap de header-top-row lo maneja */
      position: relative; 
      min-width: 150px; /* Para evitar que se colapse demasiado */
    }
    .search-bar .material-icons { font-size: 20px; color: #555; margin-right: 8px; }
    .search-bar input {
      background: transparent;
      border: none;
      outline: none;
      color: #000;
      width: calc(100% - 25px); /* Ajustar ancho para el icono de búsqueda y X */
      font-size: 0.9rem;
      padding-right: 5px; /* Reducir padding si el icono X está separado */
    }
    .search-bar .clear-search-btn {
      position: absolute;
      right: 5px; /* Más cerca del borde */
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #777; /* Color del ícono */
      cursor: pointer;
      padding: 2px; /* Ligero padding alrededor del ícono */
      display: none; /* Oculto por defecto */
      line-height: 1; /* Para alinear bien el ícono */
      /* El font-size del span del ícono ya está inline, pero podemos asegurar aquí */
    }
    .search-bar .clear-search-btn:hover {
      color: #000;
    }
    .search-bar .clear-search-btn .material-icons {
      font-size: 18px; /* Asegurar tamaño del icono X */
      display: block; /* Para centrado correcto */
    }

    /* SELECTOR DE COMPAÑÍA */
    .company-selector {
      display: flex;
      align-items: center;
      cursor: pointer;
      margin: 8px 0;
      position: relative; /* Clave para el posicionamiento del popup */
    }
    .company-selector img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #000;
    }
    .company-popup {
      position: absolute;
      top: calc(100% + 8px); /* Debajo del botón activador + pequeño espacio */
      left: 0; /* Alineado a la izquierda del botón activador */
      /* transform: translateX(-50%); Eliminado, ya no se centra respecto a un elemento central */
      background: #fff;
      border: 1px solid #ddd; /* Borde más sutil */
      border-radius: 12px; /* Esquinas más redondeadas */
      width: 230px; /* Ancho ligeramente ajustado */
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15); /* Sombra más suave y moderna */
      display: none;
      animation: fadeInScale 0.25s ease-out; /* Añadida animación */
      z-index: 2000;
      transform-origin: top left; /* Origen de la animación para el popup izquierdo */
    }
    /* Triángulo/Flecha para unir visualmente */
    .company-popup::before {
      content: '';
      position: absolute;
      bottom: 100%; /* Lo coloca encima del popup */
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #fff; /* Color del borde del popup */
      /* Efecto para que el borde del triángulo también se vea */
      filter: drop-shadow(0 -1px 0px #ddd); /* Simula el borde superior del triángulo */
    }

    .company-popup.show { display: block; }
    .company-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      cursor: pointer;
      color: #000;
    }
    .company-item img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      object-fit: cover;
    }
    .company-item:hover { background: #f0f0f0; }
    @keyframes fadeInScale {
      0% { opacity: 0; transform: scale(0.95); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* BOTÓN VISTAS/ORDENAR - Ya no se usa posicionado absoluto, se integra en header-top-row */
    /* .view-options-button { ... } */
    /* .view-icon { ... } */

    /* Explicitly style the active state to prevent default browser styles for generic buttons if needed */
    /* .view-options-button:active { ... } */

    .view-options {
      display: none;
      position: absolute;
      top: 55px; /* Ajustar basado en la altura del nuevo header-icon-btn */
      right: 10px; /* Ajustar para alinearse con el nuevo botón de la derecha */
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 8px;
      gap: 6px;
      flex-direction: column;
      animation: viewOptionsAppear 0.2s ease-out; /* Updated animation */
      z-index: 2000;
      transform-origin: top right; /* Added transform-origin */
    }
    .view-option {
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: #000;
    }
    .view-option:hover { background: #f0f0f0; }

    /* CONTENIDO PRINCIPAL */
    .content {
      max-width: 1200px;
      margin: 0 auto;
      margin-top: 110px; /* Reducido, ya que el selector de compañía central se eliminó */
      padding: 10px 15px 80px;
    }
    /* Ocultar listas inicialmente y añadir transición */
    #pedidoList, #ordenList, #inventarioList {
      opacity: 0;
      transition: opacity 0.15s ease-in-out; /* Transición rápida para la aparición */
    }
    .grid-1col {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      justify-items: center;
    }
    .grid-2col {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      justify-items: center;
    }
    .grid-pc {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 8px; /* Reducido de 12px a 8px */
      justify-items: center;
    }

    /* ITEMS */
    @keyframes fadeUp {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .item {
      background: #fff;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeUp 0.4s ease both;
      transition: background-color 0.2s ease;
      width: 100%;
      max-width: 200px;
    }
    .grid-1col .item { max-width: 350px; }
    .grid-pc .item { max-width: 220px; } /* Reducido de 250px a 220px */
    .item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    .item.highlight { border: 2px solid #000 !important; }
    .img-space {
      position: relative;
      width: 100%;
      aspect-ratio: 1/1;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      cursor: pointer;
    }
    .img-space img { 
      display: block; /* Asegura que se comporte como bloque */
      max-width: 100%; 
      max-height: 100%;
      width: auto; /* Deja que el navegador determine el ancho */
      height: auto; /* Deja que el navegador determine el alto */
      object-fit: contain; /* Asegura que quepa sin recortar */
    }
    .edit-icon-btn {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(255,255,255,0.8);
      border: none;
      cursor: pointer;
      outline: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .edit-icon-btn .material-icons { font-size: 14px; color: #555; }
    
    .credit-icon-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255,255,255,0.8);
      border: none;
      cursor: pointer;
      outline: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .credit-icon-btn .material-icons { font-size: 14px; color: #c00; }
    .item-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 6px;
    }
    .product-name {
      height: 2.4em;
      line-height: 1.2;
      overflow: hidden;
      font-weight: 500;
      color: #111;
      font-size: 0.95rem;
    }
    .product-number {
      font-size: 0.65rem;
      color: #999;
      margin-top: 2px;
    }

    /* CAMPOS DE CANTIDAD */
    .quantity-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      font-size: 0.85rem;
      width: 100%;
    }
    .quantity-input-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      width: 100%;
      max-width: 120px;
    }
    .quantity-btn {
      width: 28px;
      height: 28px;
      min-width: 28px;
      min-height: 28px;
      padding: 0;
      border-radius: 50%;
      font-size: 16px;
      font-weight: bold;
      color: white;
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s ease;
      border: none;
      outline: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      z-index: 10;
      line-height: 1;
      text-align: center;
    }
    .quantity-btn:hover {
      background: #000;
    }
    .quantity-btn:active {
      transform: scale(0.95);
    }
    .quantity-row input {
      width: 60px;
      padding: 6px;
      border: none;
      border-radius: 8px;
      background: #f8f8f8;
      color: #333;
      text-align: center;
      outline: none;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      margin: 0 4px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .quantity-row input:focus { border: 2px solid #000; }
    .quantity-row input::-webkit-inner-spin-button,
    .quantity-row input::-webkit-outer-spin-button { -webkit-appearance: none; }

    /* BOTONES FIJOS (ABAJO) */
    @keyframes fadeInUp {
      0% { opacity: 0; transform: translateY(15px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .buttons {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
      padding: 12px;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      animation: fadeInUp 0.5s ease;
      animation-delay: 0.3s;
      z-index: 900;
    }
    button {
      padding: 10px;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      text-transform: uppercase;
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
      transition: transform 0.1s ease;
    }
    button:hover { opacity: 0.9; }
    button:active { background: #111; }
    
    /* Ajuste para asegurar que el material-icons dentro de botones esté centrado */
    button .material-icons {
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* MODALES */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
      backdrop-filter: blur(5px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .modal.show { display: flex; opacity: 1; pointer-events: auto; }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      transform: translateY(-30px);
      animation: slideInModal 0.3s forwards ease;
    }
    @keyframes slideInModal {
      0% { transform: translateY(-30px); }
      100% { transform: translateY(0); }
    }
    .modal-buttons {
      display: flex;
      justify-content: space-around;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    .modal-buttons button {
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      color: #fff;
      min-width: 100px;
      width: auto;
      height: auto;
      transition: 0.2s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-buttons button:hover { opacity: 0.9; }
    .delete-btn { 
      background: #c00;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }
    .cancel-btn { background: #777; }
    .save-btn, .download-btn { background: #000; }
    .modern-modal {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 0.85rem;
    }
    .form-group input, .form-group select {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      font-size: 0.9rem;
      color: #333;
      outline: none;
      appearance: auto;
      -webkit-appearance: menulist;
      -moz-appearance: menulist;
    }
    .form-group input:focus, .form-group select:focus { border-color: #888; }
    .form-row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    @media (max-width: 480px) {
      .modal-content { max-width: 90%; padding: 16px; }
      .modern-modal { gap: 0.75rem; }
      .form-group label { font-size: 0.8rem; }
      .form-group input, .form-group select { font-size: 0.85rem; padding: 8px; }
      .modal-buttons button { font-size: 0.9rem; padding: 10px 20px; min-width: 100px; }

      /* Ajustes para los .form-row en móviles para asegurar apilamiento */
      #editModal .form-row,
      #newProductModal .form-row {
        flex-direction: column; /* Apilar los grupos de formularios */
        gap: 0; /* Eliminar el gap horizontal, el margen de los form-group se encargará */
      }
      #editModal .form-row .form-group,
      #newProductModal .form-row .form-group {
        width: 100%; /* Cada grupo de formulario ocupa todo el ancho */
        margin-bottom: 0.75rem; /* Espacio entre grupos apilados, igual que .modern-modal gap */
      }
      /* Eliminar margen inferior del último grupo en un form-row si no se necesita */
      #editModal .form-row .form-group:last-child,
      #newProductModal .form-row .form-group:last-child {
        margin-bottom: 0;
      }

      /* Ajustes responsivos para la sección de precios en el modal de edición */
      #priceContainer .price-row {
        flex-direction: row; /* Apilar elementos verticalmente */
        align-items: center; /* Estirar elementos al ancho completo */
        gap: 6px; /* Reducir el espacio entre elementos */
        padding: 0; /* Añadir un poco de padding */
        margin-bottom: 8px; /* Reducir margen inferior */
      }
      #priceContainer .price-row select.price-company,
      #priceContainer .price-row input.price-value {
        width: auto; /* Ocupar todo el ancho disponible */
        padding: 8px 6px; /* Reducir padding interno */
        font-size: 0.85rem; /* Texto más pequeño */
        height: 38px; /* Misma altura que el botón */
      }
      #priceContainer .price-row select.price-company {
        flex: 3; /* Más espacio al select */
      }
      #priceContainer .price-row input.price-value {
        flex: 2; /* Espacio para el input */
        text-align: right;
      }

      #priceContainer .price-row button { /* Botón "Eliminar" */
        align-self: auto; /* Alinear el botón de eliminar a la derecha */
        /* padding: 12px 15px;  Ya no se usa este padding, se controla por width/height */
        /* font-size: 0.85rem; No aplica directamente al icono */
        /* Estilos de icono (width, height, padding=0) se heredan o se especifican en la regla base */
        width: 38px;
        height: 38px;
        /* background y color se heredan de la regla base */
      }
      /* Estilo para el icono dentro del botón si es necesario ajustar específicamente para 480px */
      #priceContainer .price-row button .material-icons {
        font-size: 20px; /* Ajustar si es necesario */
      }

      #priceSection button[type="button"] { /* Botón "Agregar Precio" */
        width: 100%; /* Hacerlo de ancho completo */
        margin-top: 0.75rem;
      }
    }

    /* ESTILOS PARA CAMPO DE MARGEN PERSONALIZADO */
    .margin-field {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .margin-field label {
      font-size: 0.9rem;
      font-weight: 500;
    }
    .margin-field input {
      width: 70px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      text-align: right;
    }
    .margin-field .percent {
      font-size: 0.9rem;
    }
    
    /* PANEL DE AJUSTES MEJORADO */
    #settingsOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
      display: none;
      opacity: 0;
      transition: opacity 0.4s ease;
      backdrop-filter: blur(2px);
    }
    #settingsOverlay.show { display: block; opacity: 1; }
    #settingsTab {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: 100%; 
      background: #fff;
      z-index: 3001;
      display: none;
      flex-direction: column;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #settingsTab.show { 
      display: flex;
      opacity: 1;
    }
    .settings-header {
      background: #000;
      color: #fff;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .settings-header .back-button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      padding: 0;
    }
    .settings-header .back-button:active {
      background: rgba(255,255,255,0.2);
    }
    .settings-header h2 { 
      margin: 0; 
      font-size: 1.2rem; 
      font-weight: 600;
    }
    .settings-content {
      padding: 15px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1;
      width: 100%;
      box-sizing: border-box;
    }
    .settings-content p {
      margin-top: 0;
      color: #666;
      margin-bottom: 1rem;
      text-align: center;
      font-size: 0.9rem;
    }
    .settings-section { 
      margin-bottom: 1.5rem;
      background: #f8f8f8;
      padding: 12px;
      border-radius: 12px;
      width: 100%;
      box-sizing: border-box;
    }
    .settings-section h4 {
      margin: 0 0 0.8rem;
      font-size: 1rem;
      font-weight: 600;
      color: #333;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
    }
    .settings-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.9rem;
      color: #333;
    }
    .settings-list-item:last-child { border-bottom: none; }
    .settings-actions { 
      display: flex; 
      gap: 5px; 
      align-items: center; 
    }
    .settings-actions button {
      min-width: 36px;
      min-height: 36px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      color: #555;
      padding: 0;
    }
    .rename-btn .material-icons { font-size: 18px; color: #555; }
    .remove-btn .material-icons { font-size: 18px; color: #c00; }
    .add-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .add-row input {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.9rem;
      outline: none;
      box-sizing: border-box;
    }
    .add-row input:focus {
      border-color: #000;
    }
    .icon-button {
      background: #000;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      min-width: 40px;
      min-height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      align-self: flex-end;
      margin-top: 5px;
    }
    .icon-button .material-icons { font-size: 18px; }
    
    /* Company add row needs special handling */
    .company-add-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .company-add-row input {
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      font-size: 0.9rem;
      outline: none;
      box-sizing: border-box;
    }
    .company-add-row .icon-button {
      align-self: flex-end;
    }

    /* MODAL INFO DE PRODUCTO (Diseño Moderno y Mejorado) */
    .info-modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 4000;
      backdrop-filter: blur(5px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .info-modal.show {
      display: flex;
      opacity: 1;
      pointer-events: auto;
    }

    /* Nueva tarjeta de producto con diseño moderno */
    .product-card {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 400px;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* Encabezado con logo y nombre del producto */
    .product-header {
      display: flex;
      align-items: center;
      padding: 18px;
      background: #f8f8f8;
      border-bottom: 1px solid #eee;
    }

    .product-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-right: 15px;
    }

    .header-text {
      flex: 1;
    }

    .product-header .product-name {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      height: auto;
    }

    .product-code {
      margin: 0;
      font-size: 0.8rem;
      color: #888;
    }

    /* Detalles del producto */
    .product-details {
      padding: 15px 18px;
      border-bottom: 1px solid #eee;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .detail-label {
      color: #666;
      font-size: 0.9rem;
    }

    .detail-value {
      font-weight: 500;
      color: #333;
      font-size: 0.9rem;
    }

    /* Lista de precios */
    .price-list {
      padding: 15px 18px;
    }

    .section-title {
      margin: 0 0 15px 0;
      font-size: 1rem;
      font-weight: 600;
      color: #333;
    }

    .prices-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .price-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: #f8f8f8;
      border-radius: 12px;
      transition: transform 0.2s ease;
    }

    .price-row:hover {
      transform: translateX(5px);
      background: #f0f0f0;
    }

    .price-company {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .company-logo {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
    }

    .company-name {
      font-size: 0.9rem;
      color: #444;
    }

    .price-value {
      font-weight: 700;
      font-size: 1.1rem;
      color: #333;
    }

    /* Precio sugerido */
    .suggested-price {
      margin-top: 15px;
      padding: 15px;
      background: #333;
      color: white;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .suggested-label {
      font-size: 0.85rem;
    }

    .suggested-value {
      font-weight: 700;
      font-size: 1.2rem;
    }

    .no-prices {
      text-align: center;
      color: #888;
      padding: 20px 0;
      font-style: italic;
    }

    /* Estilos adicionales para el PDF mejorado */
    .company-name-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .company-name-header img {
      height: 30px;
      width: 30px;
      object-fit: contain;
      border-radius: 50%;
    }
    
    .company-name-text {
      font-size: 1.2rem;
      font-weight: bold;
    }

    /* MODAL ZOOM IMAGEN ESTILOS */
    #imageZoomModal .modal-content {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden; /* Importante para el futuro zoom/paneo dentro del recuadro */
      
      /* Tamaño del recuadro del modal */
      width: 70vw; /* 70% del ancho del viewport */
      height: 80vh; /* 80% del alto del viewport */
      max-width: 800px; /* Límite máximo de ancho */
      max-height: 600px; /* Límite máximo de alto */
      
      padding: 15px; /* Un pequeño padding interno */
      background: #fff; /* Fondo blanco para el recuadro */
      box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Sombra estándar de modal */
      border-radius: 8px; /* Esquinas redondeadas */
    }
    #zoomedImage {
      display: block; /* Comportamiento de bloque */
      max-width: 100%; /* Máximo ancho del contenedor padre (.modal-content) */
      max-height: 100%; /* Máximo alto del contenedor padre (.modal-content) */
      width: auto; /* Ancho basado en contenido, respetando max-width */
      height: auto; /* Alto basado en contenido, respetando max-height */
      object-fit: contain; /* Escalar para caber manteniendo aspecto */
      cursor: zoom-in; /* Indica que se puede hacer zoom */
      transition: transform 0.2s ease; /* Para futuras interacciones de zoom con JS */
    }

    /* Ajustes responsivos para la sección de precios en el modal de edición */
    #priceContainer .price-row {
      flex-direction: column; /* Apilar elementos verticalmente */
      align-items: stretch; /* Estirar elementos al ancho completo */
      gap: 0.5rem; /* Reducir el espacio entre elementos */
      padding: 10px; /* Añadir un poco de padding */
    }
    #priceContainer .price-row select.price-company,
    #priceContainer .price-row input.price-value {
      width: 100%; /* Ocupar todo el ancho disponible */
    }
    #priceContainer .price-row button { /* Botón "Eliminar" */
      align-self: flex-end; /* Alinear el botón de eliminar a la derecha */
      padding: 12px 15px; /* Ajustado padding vertical a 12px */
      font-size: 0.85rem;
    }
    #priceSection button[type="button"] { /* Botón "Agregar Precio" */
      width: 100%; /* Hacerlo de ancho completo */
      margin-top: 0.75rem;
    }

    /* Estilo específico para cuando el select está enfocado, si es necesario */
    #editModal .form-group select:focus,
    #newProductModal .form-group select:focus {
      border-color: #007bff; /* Color de borde al enfocar */
      outline: none; /* Quitar outline por defecto */
    }
    
    /* Para asegurar que la flecha nativa se muestre si no se usa una personalizada */
    #editModal .form-group select:not([multiple]):not([size]),
    #newProductModal .form-group select:not([multiple]):not([size]) {
        background-image: linear-gradient(45deg, transparent 50%, gray 50%), linear-gradient(135deg, gray 50%, transparent 50%), linear-gradient(to right, #ccc, #ccc);
        background-position: calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px), calc(100% - 2.5em) 0.5em;
        background-size: 5px 5px, 5px 5px, 1px 1.5em;
        background-repeat: no-repeat;
    }
    

    #editModal .form-group textarea, #newProductModal .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.9rem;
      background-color: #fff;
      color: #333;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      margin-bottom: 15px; /* Más espacio entre grupos */
    }

    #editModal .form-group label, #newProductModal .form-group label {
      display: block;
      margin-bottom: 8px; /* Más espacio entre etiqueta y campo */
      color: #333;
      font-weight: bold;
      font-size: 0.9rem;
    }

    /* Estilos base para todos los campos de formulario en los modales */
    #editModal .form-group input,
    #editModal .form-group select,
    #editModal .form-group textarea,
    #newProductModal .form-group input,
    #newProductModal .form-group select,
    #newProductModal .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 0.9rem;
      background-color: #fff;
      color: #333;
      margin-bottom: 10px; /* Espacio general debajo de cada campo */
    }

    /* Quitar margen inferior extra si es el último elemento del grupo, o si se maneja diferente */
    #editModal .form-group > *:last-child,
    #newProductModal .form-group > *:last-child {
        margin-bottom: 0;
    }
    
    /* Estilos específicos para select para darles un look moderno con flecha personalizada */
    #editModal .form-group select,
    #newProductModal .form-group select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-down" viewBox="0 0 16 16"%3E%3Cpath fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"%2F%3E%3C/svg%3E');
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px; /* Espacio para la flecha */
    }

    /* Estilos de focus para los campos */
    #editModal .form-group input:focus,
    #editModal .form-group select:focus,
    #editModal .form-group textarea:focus,
    #newProductModal .form-group input:focus,
    #newProductModal .form-group select:focus,
    #newProductModal .form-group textarea:focus {
      border-color: #007bff;
      outline: none;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); /* Opcional: un brillo al enfocar */
    }

    /* Estilos por defecto para precios por compañía (escritorio) */
    #priceContainer .price-row {
      display: flex;
      flex-direction: row; /* Alineación horizontal */
      align-items: center; /* Centrar verticalmente - volvemos a esta estrategia */
      gap: 10px; /* Espacio entre elementos */
      margin-bottom: 10px; /* Espacio debajo de cada fila de precio */
    }

    #priceContainer .price-row select.price-company,
    #priceContainer .price-row input.price-value,
    #priceContainer .price-row button {
      height: 42px; /* Altura fija explícita para todos los elementos */
      box-sizing: border-box; /* Asegurar que padding y borde estén dentro */
    }

    #priceContainer .price-row select.price-company {
      flex: 2; /* Selector de compañía más ancho */
      /* Estilos generales de select ya aplicados (padding, borde, etc.) */
    }

    #priceContainer .price-row input.price-value {
      flex: 1; /* Campo de precio más estrecho */
      text-align: right; /* Alinear precio a la derecha */
      /* Estilos generales de input ya aplicados */
    }

    #priceContainer .price-row button { /* Botón "Eliminar" */
      padding: 0 15px; /* Solo padding horizontal, la altura es fija */
      flex-shrink: 0; /* Evitar que se encoja */
      background: #000; /* Asegurar el fondo negro consistente con otros botones */
      color: #fff; /* Asegurar texto blanco */
      border: none; /* Eliminar borde que pueda estar causando desplazamiento */
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative; /* Permitir ajuste de posición */
      top: -3px; /* Aumentar el desplazamiento hacia arriba */
    }

    /* Ajustes responsivos para la sección de precios en el modal de edición */
    @media (max-width: 768px) {
      #priceContainer .price-row {
        flex-direction: row; /* Cambiado a fila */
        align-items: center; /* Alinear verticalmente al centro */
        gap: 8px; /* Espacio entre elementos */
        padding: 0;
        margin-bottom: 10px; /* Reducir un poco el margen inferior */
      }
      #priceContainer .price-row select.price-company {
        width: auto; /* Quitar width 100% */
        flex: 3; /* Dar más espacio al select */
      }
      #priceContainer .price-row input.price-value {
        width: auto; /* Quitar width 100% */
        flex: 2; /* Dar espacio al input de precio */
        margin-bottom: 0; /* Quitar margen inferior ya que no está apilado */
        text-align: right;
      }
      #priceContainer .price-row button { /* Botón "Eliminar" con icono en móviles */
        align-self: auto; /* Quitar align-self */
        /* Los estilos de icono (tamaño, padding=0) vienen de la regla base del botón */
        width: 38px; /* Un poco más pequeño en móvil */
        height: 38px;
      }
      /* Estilo para el icono dentro del botón si es necesario ajustar específicamente para 768px */
      #priceContainer .price-row button .material-icons {
        font-size: 20px; /* Icono un poco más pequeño en móvil */
      }
    }
    /* El botón "Agregar Precio" (#priceSection button[type="button"]) sigue igual, ancho completo */
    #priceSection button[type="button"] { /* Botón "Agregar Precio" */
      width: 100%; /* Hacerlo de ancho completo */
      margin-top: 0.75rem;
    }

    /* New animation for view-options popup */
    @keyframes viewOptionsAppear {
      0% {
        opacity: 0;
        transform: scale(0.9);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Media query para ajustar el modal de imagen en pantallas pequeñas */
    @media (max-width: 600px) {
      #imageZoomModal .modal-content {
        width: 90vw; /* Más ancho en móviles */
        height: 75vh; /* Un poco menos alto en móviles */
        max-height: 500px; /* Límite de altura más pequeño para móviles */
      }
    }

    /* Estilos para el selector de tipo de margen */
    .margin-type-selector {
      display: flex;
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #ccc; /* Borde alrededor del grupo */
      margin-bottom: 8px;
    }
    .margin-type-option {
      flex: 1; /* Distribución equitativa por defecto */
    }
    .margin-type-option input[type="radio"] {
      display: none; /* Ocultar el radio button real */
    }
    .margin-type-option label {
      display: block;
      text-align: center;
      padding: 8px 5px;
      cursor: pointer;
      background-color: #f0f0f0;
      color: #333; /* Texto oscuro por defecto para no seleccionados */
      font-size: 0.85rem;
      font-weight: normal;
      margin-bottom: 0;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .margin-type-option:first-child label {
      border-right: 1px solid #ccc;
    }
    .margin-type-option input[type="radio"]:checked + label {
      background-color: #333 !important; /* Fondo oscuro */
      color: white !important; /* Texto blanco - con !important */
      font-weight: bold !important;
      border-color: #333 !important;
    }
    .margin-type-option label:hover {
      background-color: #e0e0e0;
      color: #333;
    }
    .margin-type-option input[type="radio"]:checked + label:hover {
      background-color: #000 !important;
      color: white !important; /* Asegurar texto blanco también en hover del seleccionado */
    }

    /* CHIP MODERNO PARA INFO DE CONTADOR EN LA PARTE INFERIOR DERECHA DEL HEADER */
    .info-chip-header-bottom {
      /* Ya no se muestra de forma permanente, la información se integra en el modal del carrito */
      display: none; 
      /* position: absolute; 
      right: 18px;
      bottom: -35px; 
      z-index: 1201;
      display: flex;
      align-items: flex-end;
      pointer-events: none;
      width: auto; */
    }
    .info-chip {
      background: #fff;
      color: #222;
      font-size: 0.95rem;
      font-weight: 600;
      border-radius: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      padding: 7px 18px;
      min-width: 120px;
      text-align: center;
      display: inline-block;
      border: 1px solid #eee;
      letter-spacing: 0.01em;
      pointer-events: auto;
      transition: background 0.2s, color 0.2s;
      user-select: none;
    }
    .info-chip:empty {
      display: none;
    }
    @media (max-width: 600px) {
      .info-chip-header-bottom {
        right: 8px;
        bottom: -30px; /* Ajuste para móviles */
      }
      .info-chip {
        font-size: 0.85rem;
        padding: 6px 12px;
        min-width: 90px;
      }
    }

    /* BOTÓN CARRITO/BADGE DENTRO DE LA BARRA DE BÚSQUEDA - Estilos eliminados/modificados */
    /* .info-badge-btn-inside { ... } */
    /* .info-badge-btn-inside:active { ... } */
    /* .info-badge-btn-inside .material-icons { ... } */

    .info-badge-count {
      position: absolute;
      top: -3px;  /* Ajuste para el nuevo botón */
      right: -3px; /* Ajuste para el nuevo botón */
      background: #e53935; /* Rojo más vibrante */
      color: #fff;
      font-size: 0.7rem; /* Un poco más pequeño */
      font-weight: bold;
      border-radius: 50%;
      min-width: 16px; /* Tamaño mínimo */
      height: 16px;  /* Tamaño mínimo */
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px; /* Padding horizontal */
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      border: 1.5px solid #fff; /* Borde blanco */
      z-index: 3;
      pointer-events: none;
    }
    /* .search-bar { */ /* position: relative; ya está arriba */
    /* } */
    /* Ya no se necesita padding extra en el input de búsqueda para el botón interno */
    /* .search-bar input { ... } */ 

    @media (max-width: 600px) {
      /* .info-badge-btn-inside { ... } */ /* Eliminado */
      .info-badge-count {
        font-size: 0.65rem;
        min-width: 14px;
        height: 14px;
        top: -2px;
        right: -2px;
      }
      /* .search-bar input { ... } */ /* Eliminado */
      .header-icon-btn {
        width: 38px; /* Ligeramente más pequeño en móviles */
        height: 38px;
      }
      .header-icon-btn .material-icons {
        font-size: 20px;
      }
      .search-bar {
        padding: 5px 10px; /* Ajuste para móviles */
      }
      .search-bar .material-icons { font-size: 18px; margin-right: 6px;}
      .search-bar input { font-size: 0.85rem; }

       .header-top-row {
        gap: 0.3rem;
        padding: 0.1rem 0;
        margin-bottom: 0.4rem;
      }
      .header-icon-group-left,
      .header-icon-group-right {
        gap: 0.3rem;
      }
      /* .company-selector img { ... } */ /* Eliminado ya que el selector central no existe */
      .tabs .tab { /* Reducir un poco las tabs en móviles */
        padding: 6px 8px;
        font-size: 0.9rem;
      }
       .content {
        margin-top: 130px; /* Reducir margen superior en móviles */
        margin-top: 100px; /* Ajuste adicional para móviles después de quitar el selector central */
      }
    }

    /* MODAL INFO BADGE */
    .info-badge-modal-content {
      max-width: 320px;
      min-width: 220px;
      border-radius: 18px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.18);
      padding: 28px 18px 22px 18px;
      background: #fff;
      text-align: center;
      position: relative;
    }
    .info-badge-modal-header {
      display: flex;
      justify-content: center; /* Cambiado para centrar el icono del carrito */
      align-items: center;
      width: 100%;
      margin-bottom: 12px;
    }
    #infoBadgeModalIcon {
      font-size: 2rem;
      color: #222;
    }
    .info-badge-modal-close-btn {
      background: none;
      border: none;
      color: #222;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
    }
    .info-badge-modal-text-content {
      margin: 18px 0 0 0;
      text-align: center;
      font-size: 1.1rem;
      color: #222;
      font-weight: 600;
    }
  </style>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
</head>
<body>
  <!-- SPLASH -->
  <div id="splash" class="splash">
    <img class="logo" src="https://i.postimg.cc/DzmFHHq2/Beige-and-Black-Simple-Circle-Organic-Produce-Brand-Logo.png" alt="Logo Splash" />
  </div>

  <!-- CABECERA -->
  <div class="header">
    <div class="header-content">

      <!-- Nueva Fila Superior -->
      <div class="header-top-row">
        <div class="header-icon-group-left">
          <button class="header-icon-btn" onclick="openSettingsTab()" title="Menú">
            <span class="material-icons">settings</span> <!-- Cambiado de menu a settings -->
          </button>
          <button class="header-icon-btn store-icon-btn" title="Seleccionar Compañía" onclick="toggleCompanyPopup(event)">
            <span id="storeButtonIconContainer">
              <span class="material-icons">storefront</span>
            </span>
          </button>
        </div>

        <div class="search-bar">
          <span class="material-icons">search</span>
          <input type="text" id="searchInput" placeholder="Buscar producto..." oninput="updateSearch(this.value)" />
          <button class="clear-search-btn" onclick="clearSearch()" title="Limpiar búsqueda">
            <span class="material-icons">close</span>
          </button>
        </div>

        <div class="header-icon-group-right">
          <button class="header-icon-btn cart-icon-btn" id="infoBadgeBtn" onclick="openInfoBadgeModal(event)" type="button" title="Carrito">
            <span id="infoBadgeIcon" class="material-icons">shopping_cart</span>
            <span id="infoBadgeCount" class="info-badge-count">0</span>
          </button>
          <button class="header-icon-btn" onclick="toggleViewOptions()" title="Opciones de Vista">
            <span class="material-icons">filter_list</span> <!-- Cambiado de settings a filter_list -->
          </button>
        </div>
      </div>

      <!-- El div.company-selector original se elimina. El popup se asocia al botón de tienda. -->
      <div id="companyPopup" class="company-popup"></div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" onclick="showTab('pedido')">Pedido</div>
        <div class="tab" onclick="showTab('orden')">Orden</div>
        <div class="tab" onclick="showTab('inventario')">Inventario</div>
      </div>
      
      <!-- Popup de opciones de vista (HTML se mantiene, el botón que lo activa cambió) -->
      <div id="viewOptions" class="view-options">
        <div class="view-option" onclick="setColumns(1)">
          <span class="material-icons">filter_1</span> 1 Columna
        </div>
        <div class="view-option" onclick="setColumns(2)">
          <span class="material-icons">filter_2</span> 2 Columnas
        </div>
        <div class="view-option" onclick="setColumns('pc')">
          <span class="material-icons">desktop_windows</span> PC/TABLETA
        </div>
        <hr/>
        <div class="view-option" onclick="setSortMode('byNumberAsc')">Código ↑</div>
        <div class="view-option" onclick="setSortMode('byNumberDesc')">Código ↓</div>
        <div class="view-option" onclick="setSortMode('byNameAsc')">Nombre A-Z</div>
        <div class="view-option" onclick="setSortMode('byNameDesc')">Nombre Z-A</div>
        <div class="view-option" onclick="setSortMode('byCustomOrder')">Orden Personalizado</div>
      </div>

      <!-- Chip de información de conteo (si se usa este ID en JS) -->
      <div class="info-chip-header-bottom">
        <div id="itemCountDisplay" class="info-chip"></div> <!-- Asegurarse que este ID es el usado en JS -->
      </div>

    </div>
  </div>

  <!-- CONTENIDO: Pestañas Pedido e Inventario -->
  <div class="content" id="pedidoTab">
    <div id="pedidoList" class="grid-pc"></div>
  </div>
  <div class="content" id="ordenTab" style="display:none;">
    <div id="ordenList" class="grid-pc"></div>
  </div>
  <div class="content" id="inventarioTab" style="display:none;">
    <div id="inventarioList" class="grid-pc"></div>
  </div>

  <!-- BOTONES FIJOS (ABAJO) -->
  <div class="buttons">
    <button onclick="openShareModal()" title="Compartir o Descargar Orden">
      <span class="material-icons">picture_as_pdf</span>
    </button>
    <button id="btnSendMessage" style="display:none;" onclick="openSendMessageModal()" title="Enviar Orden por Mensaje">
      <span class="material-icons">chat</span>
    </button>
    <button id="btnBorrarPedido" style="display:none;" onclick="openDeletePedidoModal()" title="Borrar Pedido">
      <span class="material-icons">delete</span>
    </button>
    <button id="btnBorrarInventario" style="display:none;" onclick="openDeleteInventarioModal()" title="Borrar Inventario">
      <span class="material-icons">delete</span>
    </button>
    <button onclick="addNewProduct()" title="Nuevo Producto">
      <span class="material-icons">add</span>
    </button>
    <button onclick="openExportModal()" title="Exportar Inventario">
      <span class="material-icons">save_alt</span>
    </button>
    <button onclick="triggerImport()" title="Importar Inventario">
      <span class="material-icons">file_open</span>
    </button>
    <button id="btnSetAllInventoryToOne" style="display:none;" onclick="openSetAllInventoryToOneModal()" title="Establecer todo el inventario a 1">
      <span class="material-icons">filter_1</span>
    </button>
    <input type="file" id="importFile" accept="application/json" style="display:none;" onchange="importInventoryFile(this.files[0])" />
  </div>

  <!-- PANEL DE AJUSTES MEJORADO -->
  <div id="settingsOverlay" onclick="closeSettingsTab()"></div>
  <div id="settingsTab">
    <div class="settings-header">
      <button class="back-button" onclick="closeSettingsTab()">
        <span class="material-icons">arrow_back</span>
      </button>
      <h2>Ajustes</h2>
    </div>
    <div class="settings-content">
      <p>Aquí puedes editar, eliminar o agregar opciones de la app.</p>
      <!-- Sección Unidades -->
      <div class="settings-section">
        <h4>Unidades</h4>
        <div id="unitsList"></div>
        <div class="add-row">
          <input type="text" id="newUnitInput" placeholder="Nueva unidad..." />
          <button class="icon-button" onclick="addUnit()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
      <!-- Sección Presentaciones -->
      <div class="settings-section">
        <h4>Presentaciones</h4>
        <div id="presentationsList"></div>
        <div class="add-row">
          <input type="text" id="newPresentationInput" placeholder="Nueva presentación..." />
          <button class="icon-button" onclick="addPresentation()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
      <!-- Sección Categorías -->
      <div class="settings-section">
        <h4>Categorías</h4>
        <div id="categoriesList"></div>
        <div class="add-row">
          <input type="text" id="newCategoryInput" placeholder="Nueva categoría..." />
          <button class="icon-button" onclick="addCategory()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
      <!-- Sección Margen de Ganancia -->
      <div class="settings-section">
        <h4>Margen de Ganancia</h4>
        <p style="text-align:left; margin-top:0; font-size:0.85rem; color:#555;">Define el porcentaje de margen para calcular el precio sugerido de venta.</p>
        <div class="margin-field">
          <label for="defaultMarginPercent">Porcentaje de margen:</label>
          <input type="number" id="defaultMarginPercent" min="0" max="999" step="0.1" value="45" onchange="saveDefaultMargin()" />
          <span class="percent">%</span>
        </div>
      </div>
      
      <!-- Sección Compañías -->
      <div class="settings-section">
        <h4>Compañías</h4>
        <div id="companiesList"></div>
        <div class="company-add-row">
          <input type="text" id="newCompanyName" placeholder="Nombre de la compañía..." />
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyLogoFile">Logo de la compañía (archivo):</label>
            <input type="file" id="newCompanyLogoFile" accept="image/*" />
          </div>
          <div style="margin-top: 8px;">
            <label>O</label>
          </div>
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyLogoUrl">URL del logo (alternativa):</label>
            <input type="text" id="newCompanyLogoUrl" placeholder="URL del logo" />
          </div>
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyPhone">Número de Teléfono (WhatsApp/SMS):</label>
            <input type="tel" id="newCompanyPhone" placeholder="Ej. +1234567890" />
          </div>
          <div class="form-group" style="margin-top: 8px;">
            <label for="newCompanyMessage">Mensaje Predeterminado (para órdenes):</label>
            <textarea id="newCompanyMessage" placeholder="Ej. Hola, te envío la orden de productos..." rows="3"></textarea>
          </div>
          <button class="icon-button" style="margin-top: 8px;" onclick="addCompany()">
            <span class="material-icons">add</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL Compartir/Descargar PDF -->
  <div id="shareModal" class="modal">
    <div class="modal-content">
      <h3>¿Qué deseas hacer?</h3>
      <div class="modal-buttons">
        <button onclick="sharePDF()" class="save-btn">COMPARTIR</button>
        <button onclick="downloadPDF()" class="save-btn">DESCARGAR</button>
        <button onclick="closeShareModal()" class="cancel-btn">CANCELAR</button>
      </div>
    </div>
  </div>

  <!-- MODAL AGREGAR/EDITAR PRODUCTO -->
  <div id="editModal" class="modal">
    <div class="modal-content modern-modal" style="max-height: calc(100vh - 40px); overflow-y: auto; position: relative; cursor: move;">
      <h3 id="editModalTitle" style="margin-bottom:0.5rem;">Nuevo Producto</h3>
      <div class="form-group">
        <label for="editName">Nombre del producto</label>
        <input type="text" id="editName" placeholder="Ej. CAMISETA" oninput="this.value=this.value.toUpperCase();" />
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="editNumber">Código/Referencia (opcional)</label>
          <input type="text" id="editNumber" placeholder="Ej. 101" />
        </div>
        <div class="form-group" style="position: relative; z-index: 500;">
          <label for="editUnit">Unidad</label>
          <select id="editUnit" style="position: relative; z-index: 500;"></select>
        </div>
      </div>
      <div class="form-group" style="position: relative; z-index: 450;">
        <label for="editPresentation">Etiqueta de Cantidad (Pedido)</label>
        <select id="editPresentation" style="position: relative; z-index: 450;"></select>
      </div>
      <div class="form-group">
        <label for="editCategory">Departamento / Categoría</label>
        <input type="text" id="editCategory" placeholder="Ej. Electrónica, Ropa, Alimentos..." />
      </div>
      <div class="form-group">
        <label for="editTags">Palabras Clave / Tags (separadas por comas)</label>
        <input type="text" id="editTags" placeholder="Ej. aluminio, desechable, cocina" />
      </div>
      <div class="form-group" style="position: relative; z-index: 400;">
        <label for="editCompany">Compañía</label>
        <select id="editCompany" style="position: relative; z-index: 400;"></select>
      </div>
      <div class="form-group">
        <label for="editStock">Stock</label>
        <input type="text" id="editStock" placeholder="Cantidad en stock" />
      </div>
      <div class="form-group">
        <label for="editCustomMargin">Margen personalizado</label>
        <div class="margin-type-selector">
          <div class="margin-type-option" style="flex: 1;"> <!-- Ajustar flex si es necesario -->
            <input type="radio" id="marginTypePercent" name="marginType" value="percent" checked>
            <label for="marginTypePercent">%</label>
          </div>
          <div class="margin-type-option" style="flex: 2;"> <!-- Ajustar flex si es necesario -->
            <input type="radio" id="marginTypeFixed" name="marginType" value="fixed">
            <label for="marginTypeFixed">Monto Fijo ($)</label>
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <input type="number" id="editCustomMargin" placeholder="Usar margen general" style="flex:1;" step="0.01" />
          <button type="button" id="resetMarginBtn" style="background:transparent; color:#666; box-shadow:none; width:auto; height:auto; min-width:auto; padding:0 8px;" onclick="resetCustomMargin()">
            <span class="material-icons" style="font-size:18px;">refresh</span>
          </button>
        </div>
        <small style="color:#666; font-size:0.8rem; margin-top:3px; display:block;">Dejar vacío para usar el margen general</small>
      </div>
      <!-- Nueva sección para Orden Personalizado -->
      <div class="form-group" id="customOrderSection" style="position: relative; z-index: 350;">
        <label for="editCustomSortPosition">Posición en Orden Personalizado</label>
        <select id="editCustomSortPosition" style="position: relative; z-index: 350;">
          {/* Opciones se llenarán dinámicamente con JavaScript */}
        </select>
      </div>
      {/* Fin Nueva sección */}
      <!-- Información de la Caja -->
      <div class="form-group">
        <label>Información de la Caja</label>
        <div class="form-row">
          <div class="form-group" style="flex: 1;">
            <label for="editUnidadesPorCaja">Unidades por caja</label>
            <input type="number" id="editUnidadesPorCaja" placeholder="Ej. 24" min="0" step="1" />
          </div>
          <div class="form-group" style="flex: 1;">
            <label for="editPaquetesPorCaja">Paquetes por caja</label>
            <input type="number" id="editPaquetesPorCaja" placeholder="Ej. 4" min="0" step="1" />
          </div>
        </div>
      </div>
      
      <!-- Sección de Precios -->
      <div class="form-group" id="priceSection">
        <label>Precios por Compañía</label>
        <div id="priceContainer"></div>
        <button type="button" onclick="addPriceRow()" style="width: auto; height: auto; border-radius: 6px; padding: 8px 12px; margin-top: 10px; background: #333; color: white; text-align: center;">Agregar Precio</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="editImageFile">Seleccionar archivo</label>
          <input type="file" id="editImageFile" accept="image/*" />
        </div>
        <div class="form-group">
          <label for="editImageUrl">URL de la imagen</label>
          <input type="text" id="editImageUrl" placeholder="https://..." />
        </div>
      </div>
      <div class="modal-buttons">
        <button id="deleteProductBtn" onclick="deleteItem()" class="delete-btn" style="display:none; width: auto; height: auto;">Eliminar</button>
        <button onclick="closeModal()" class="cancel-btn">Cancelar</button>
        <button onclick="saveChanges()" class="save-btn">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFO DE PRODUCTO -->
  <div id="infoModal" class="info-modal">
    <div class="modal-content" style="padding:0; max-width:400px; overflow:hidden;">
      <div id="infoContent"></div>
      <div class="modal-buttons" style="margin:15px;">
        <button onclick="closeInfoModal()" class="cancel-btn">Cerrar</button>
      </div>
    </div>
  </div>
  
  <!-- MODAL CRÉDITOS -->
  <div id="creditModal" class="modal">
    <div class="modal-content modern-modal" style="max-width: 350px;">
      <h3>Agregar Crédito</h3>
      <div class="form-group" style="position: relative; z-index: 450;">
        <label for="creditPresentation">Etiqueta de Cantidad</label>
        <select id="creditPresentation" style="position: relative; z-index: 450;"></select>
      </div>
      <div class="form-group">
        <label for="creditQty">Cantidad</label>
        <input type="text" id="creditQty" inputmode="decimal" placeholder="Ej. 1, 1/2, 2.5" />
      </div>
      <div class="modal-buttons">
        <button onclick="closeCreditModal()" class="cancel-btn">Cancelar</button>
        <button onclick="saveCreditInfo()" class="save-btn">Guardar</button>
      </div>
    </div>
  </div>

  <!-- MODAL BORRAR PEDIDO -->
  <div id="deletePedidoModal" class="modal">
    <div class="modal-content" style="max-width:300px;">
      <h3>¿Borrar Cantidades de Pedido?</h3>
      <p>¿Estás seguro de que quieres borrar las cantidades de la sección Pedido?</p>
      <div class="modal-buttons">
        <button onclick="confirmDeletePedido()" class="delete-btn">Borrar</button>
        <button onclick="closeDeletePedidoModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL BORRAR INVENTARIO -->
  <div id="deleteInventarioModal" class="modal">
    <div class="modal-content" style="max-width:300px;">
      <h3>¿Borrar Cantidades de Inventario?</h3>
      <p>¿Estás seguro de que quieres borrar las cantidades de la sección Inventario?</p>
      <div class="modal-buttons">
        <button onclick="confirmDeleteInventario()" class="delete-btn">Borrar</button>
        <button onclick="closeDeleteInventarioModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIRMAR ESTABLECER INVENTARIO A 1 -->
  <div id="setAllInventoryToOneModal" class="modal">
    <div class="modal-content" style="max-width:350px;">
      <h3>Confirmar Acción</h3>
      <p>¿Estás seguro de que quieres establecer la cantidad de todos los productos en el inventario actual a 1?</p>
      <div class="modal-buttons">
        <button onclick="confirmSetAllInventoryToOne()" class="save-btn">Confirmar</button>
        <button onclick="closeSetAllInventoryToOneModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL EXPORTAR JSON -->
  <div id="exportModal" class="modal">
    <div class="modal-content" style="max-width:400px;">
      <h3>Exportar Inventario</h3>
      <p>¿Quieres exportar todo el inventario, imágenes y contenido de la app para usarla en otro dispositivo?</p>
      <div class="modal-buttons">
        <button onclick="confirmExport()" class="download-btn">Descargar</button>
        <button onclick="closeExportModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- DATALIST para cantidades rápidas -->
  <datalist id="numbers">
    <option value="1/2"></option>
    <option value="1"></option>
    <option value="2"></option>
    <option value="3"></option>
    <option value="4"></option>
    <option value="5"></option>
    <option value="6"></option>
    <option value="7"></option>
    <option value="8"></option>
    <option value="9"></option>
    <option value="10"></option>
  </datalist>

  <!-- MODAL ZOOM IMAGEN -->
  <div id="imageZoomModal" class="modal">
    <div class="modal-content">
      <img id="zoomedImage" src="" alt="Imagen Ampliada">
      <button onclick="closeImageZoomModal()" style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.7); color:white; border-radius:50%; width:30px; height:30px; font-size:18px; line-height:1; padding:0;">&times;</button>
    </div>
  </div>

  <!-- MODAL ENVIAR MENSAJE -->
  <div id="sendMessageModal" class="modal">
    <div class="modal-content modern-modal" style="max-width: 450px;">
      <h3 id="sendMessageModalTitle">Enviar Orden</h3>
      <div class="form-group">
        <label for="sendMessageText">Mensaje a enviar:</label>
        <textarea id="sendMessageText" rows="8" style="width:100%; font-size:0.9rem; padding:8px; border:1px solid #ccc; border-radius:6px;"></textarea>
      </div>
      <p id="sendOrderToInfo" style="font-size:0.85rem; color:#555; text-align:center; margin-bottom:10px;"></p>
      <div class="modal-buttons">
        <button onclick="sendViaSMS()" class="save-btn" style="background-color:#007bff;">SMS</button>
        <button onclick="sendViaWhatsApp()" class="save-btn" style="background-color:#25D366;">WhatsApp</button>
        <button onclick="closeSendMessageModal()" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL INFO BADGE -->
  <div id="infoBadgeModal" class="modal">
    <div class="modal-content info-badge-modal-content">
      <div class="info-badge-modal-header">
        <span id="infoBadgeModalIcon" class="material-icons">shopping_cart</span>
        <!-- Botón de cierre eliminado -->
      </div>
      <div id="infoBadgeModalText" class="info-badge-modal-text-content">
        <!-- El texto se inyectará aquí vía JavaScript -->
      </div>
    </div>
  </div>

  <script>
    /* ===== FUNCIONES BÁSICAS ===== */
    // Deshabilitar la restauración de scroll automática del navegador
    if (history.scrollRestoration) {
      history.scrollRestoration = 'manual';
    }

    const APP_DEFAULT_LOGO = "https://i.postimg.cc/DzmFHHq2/Beige-and-Black-Simple-Circle-Organic-Produce-Brand-Logo.png";
    const UNITS_KEY = "allUnits_v2";
    const PRESENTATIONS_KEY = "allPresentations_v2";
    const CATEGORIES_KEY = "allCategories_v2";
    const COMPANIES_KEY = "allCompanies_v2";
    const ORDER_SYSTEM_MIGRATED_KEY = "orderSystemMigrated_v1"; // Nueva clave para la migración

    // Función para escapar caracteres especiales
    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Inicialización
    function initApp() {
      // Inicializar listas si no existen
      if (!localStorage.getItem(UNITS_KEY)) {
        localStorage.setItem(UNITS_KEY, JSON.stringify(["pz", "kg", "lt"]));
      }
      if (!localStorage.getItem(PRESENTATIONS_KEY)) {
        localStorage.setItem(PRESENTATIONS_KEY, JSON.stringify(["caja", "paquete", "costal", "pieza"]));
      }
      if (!localStorage.getItem(CATEGORIES_KEY)) {
        localStorage.setItem(CATEGORIES_KEY, JSON.stringify(["General", "Alimentos", "Limpieza"]));
      }
      if (!localStorage.getItem(COMPANIES_KEY)) {
        localStorage.setItem(COMPANIES_KEY, JSON.stringify([]));
      }

      // Restaurar filtros guardados
      restoreFiltersAndState();
      
      // *** Nueva: Migración del sistema de ordenamiento ***
      migrateOrderSystem();
      // *** Fin Nueva Migración ***

      // Cargar inventario
      renderTabs(); // Renderiza el contenido, pero las listas están opacity 0 debido a showTab y CSS
      updateDeleteButtons();
      
      // Restaurar posición de desplazamiento después de renderizar
      restoreScrollPosition(); // Esto tiene un setTimeout interno de 100ms para aplicar el scroll

      // Hacemos visible el contenido de la lista activa DESPUÉS de que restoreScrollPosition haya actuado.
      setTimeout(() => {
        const activeTabName = localStorage.getItem('activeTab') || 'pedido';
        const activeListElement = document.getElementById(activeTabName + 'List');
        if (activeListElement) {
          activeListElement.style.opacity = '1';
        }
      }, 150); // Esperar 150ms para dar tiempo a que el scroll (100ms) se aplique.
    }
    
    // Guardar y restaurar estado
    function saveFiltersAndState() {
      localStorage.setItem('sortMode', sortMode);
      localStorage.setItem('currentColumns', currentColumns);
      localStorage.setItem('currentCompanyFilter', currentCompanyFilter || '');
      localStorage.setItem('searchTerm', searchTerm || '');
      
      // Guardar posición de desplazamiento
      const activeTab = document.querySelector('.tab.active').textContent.toLowerCase();
      lastScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
      localStorage.setItem('scrollPosition', lastScrollPosition);
      localStorage.setItem('activeTab', activeTab);
    }
    
    function restoreFiltersAndState() {
      // Restaurar filtros
      sortMode = localStorage.getItem('sortMode') || 'byNameAsc'; // Default byNameAsc si no hay nada
      currentColumns = localStorage.getItem('currentColumns') || 'pc';
      currentCompanyFilter = localStorage.getItem('currentCompanyFilter') || '';
      searchTerm = localStorage.getItem('searchTerm') || '';
      
      // Actualizar UI con los filtros restaurados
      document.getElementById('searchInput').value = searchTerm;
      updateCurrentCompanyLogo();
      
      // Restaurar pestaña activa
      const activeTab = localStorage.getItem('activeTab') || 'pedido';
      showTab(activeTab, false); // Pasar false para evitar renderizado duplicado
    }
    
    function restoreScrollPosition() {
      const savedPosition = parseInt(localStorage.getItem('scrollPosition') || '0');
      if (savedPosition) {
        window.scrollTo(0, savedPosition);
      }
    }

    // Funciones para obtener/guardar listas
    function getUnits() { return JSON.parse(localStorage.getItem(UNITS_KEY) || '["pz", "kg", "lt"]'); }
    function getPresentations() { return JSON.parse(localStorage.getItem(PRESENTATIONS_KEY) || '["caja", "paquete", "costal", "pieza"]'); }
    function getCategories() { return JSON.parse(localStorage.getItem(CATEGORIES_KEY) || '["General", "Alimentos", "Limpieza"]'); }
    function getCompanies() { return JSON.parse(localStorage.getItem(COMPANIES_KEY) || '[]'); }

    /* ===== FUNCIONES DE INVENTARIO ===== */
    function getAllItems() {
      try {
        const raw = localStorage.getItem('inventory_v2_moderno');
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        console.error("Error al cargar inventario:", e);
        return {};
      }
    }

    function setAllItems(obj) {
      try {
        localStorage.setItem('inventory_v2_moderno', JSON.stringify(obj));
      } catch (e) {
        console.error("Error al guardar inventario:", e);
      }
    }

    // Variables globales
    let searchTerm = "";
    let currentCompanyFilter = "";
    let sortMode = localStorage.getItem('sortMode') || 'byNameAsc';
    let currentColumns = localStorage.getItem('currentColumns') || 'pc';
    let currentEdit = null;
    let lastScrollPosition = 0;
    let currentOrderPDFFile = null; // Para almacenar el PDF generado para compartir
    window.longPressTimer = null; // Para el temporizador de pulsación larga

    // Funciones para la interfaz
    function showTab(tabName, shouldRender = true) {
      // saveFiltersAndState(); // <--- Eliminada esta línea
      
      const pedidoTabContent = document.getElementById('pedidoTab');
      const ordenTabContent = document.getElementById('ordenTab');
      const inventarioTabContent = document.getElementById('inventarioTab');

      const pedidoList = document.getElementById('pedidoList');
      const ordenList = document.getElementById('ordenList');
      const inventarioList = document.getElementById('inventarioList');

      // Ocultar todas las pestañas y poner sus listas a opacidad 0
      pedidoTabContent.style.display = 'none';
      pedidoList.style.opacity = '0';

      ordenTabContent.style.display = 'none';
      ordenList.style.opacity = '0';

      inventarioTabContent.style.display = 'none';
      inventarioList.style.opacity = '0';
      
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      const clickedTab = document.querySelector(`.tab[onclick="showTab('${tabName}')"]`);
      if (clickedTab) clickedTab.classList.add('active');
      
      // Mostrar la pestaña correcta (el div contenedor del tab)
      document.getElementById(tabName + 'Tab').style.display = 'block';
      
      if (shouldRender) { // Cambio manual de pestaña
        renderTabs(); // Renderiza el contenido dentro de los divs de lista (que aún están opacity 0)
        updateDeleteButtons();
        
        // Hacer visible el contenido de la lista de la pestaña actual inmediatamente
        document.getElementById(tabName + 'List').style.opacity = '1';
        
        // localStorage.setItem('activeTab', tabName); // <--- Eliminada esta línea
        saveFiltersAndState(); // <--- Añadida esta línea al final del bloque if
      }
      // Si !shouldRender (es decir, durante la carga inicial), initApp se encargará de la opacidad DESPUÉS del scroll.
    }

    function updateDeleteButtons() {
      const btnPedido = document.getElementById('btnBorrarPedido');
      const btnInventario = document.getElementById('btnBorrarInventario');
      const btnSendMessage = document.getElementById('btnSendMessage'); // Nuevo botón
      const btnSetAllInventoryToOne = document.getElementById('btnSetAllInventoryToOne'); // Nuevo botón para inventario a 1

      const pedidoTabActive = document.getElementById('pedidoTab').style.display !== 'none';
      const ordenTabActive = document.getElementById('ordenTab').style.display !== 'none';
      const inventarioTabActive = document.getElementById('inventarioTab').style.display !== 'none';

      if (pedidoTabActive) {
        btnPedido.style.display = 'inline-block';
        btnInventario.style.display = 'none';
        btnSendMessage.style.display = 'none'; 
        btnSetAllInventoryToOne.style.display = 'none'; // Ocultar en Pedido
      } else if (ordenTabActive) {
        btnPedido.style.display = 'none';
        btnInventario.style.display = 'none';
        btnSendMessage.style.display = 'inline-block'; 
        btnSetAllInventoryToOne.style.display = 'none'; // Ocultar en Orden
      } else if (inventarioTabActive) {
        btnPedido.style.display = 'none';
        btnInventario.style.display = 'inline-block';
        btnSendMessage.style.display = 'none'; 
        btnSetAllInventoryToOne.style.display = 'inline-block'; // Mostrar en Inventario
      } else {
        btnPedido.style.display = 'none';
        btnInventario.style.display = 'none';
        btnSendMessage.style.display = 'none';
        btnSetAllInventoryToOne.style.display = 'none'; // Ocultar por defecto
      }
    }

    function renderTabs() {
      renderPedidoTab();
      renderOrdenTab();
      renderInventarioTab();
    }

    // Función para renderizar la pestaña Orden (solo productos con cantidades de pedido > 0)
    function renderOrdenTab() {
      const container = document.getElementById('ordenList');
      container.innerHTML = ''; // Limpiar el contenedor
      container.className = (currentColumns === 1) ? 'grid-1col' : (currentColumns === 2 ? 'grid-2col' : 'grid-pc');
      const itemCountElement = document.getElementById('itemCountDisplay');
      const currentTabType = 'orden'; // Definir tipo de pestaña
      
      const items = getAllItems();
      let entries = Object.entries(items);
      
      // Filtrar solo productos con cantidades de pedido
      entries = entries.filter(([, data]) => {
        return data && (
          (data.pedidoQty && data.pedidoQty !== 0 && data.pedidoQty !== '0') || 
          (data.creditQty && data.creditQty !== 0 && data.creditQty !== '0')
        );
      });
      
      // Aplicar filtros adicionales (búsqueda y compañía)
      if (searchTerm) {
        const lowerSearchTerm = searchTerm.toLowerCase();
        entries = entries.filter(([key, data]) => {
          const lowerKey = key.toLowerCase();
          const productTags = data.tags || []; // Asegurarse de que tags exista
          return lowerKey.includes(lowerSearchTerm) || 
                 productTags.some(tag => tag.toLowerCase().includes(lowerSearchTerm));
        });
      } 
      if (currentCompanyFilter) {
        entries = entries.filter(([, data]) => data && data.company === currentCompanyFilter);
    }
    
      // Ordenar entradas usando la función de ordenación
      entries = sortEntriesByCurrentMode(entries);
      
      // Actualizar contador de ítems para la pestaña ORDEN
      let distinctItemCountInOrder = entries.length;
      let totalQuantitySumInOrder = 0;

      if (distinctItemCountInOrder > 0) {
        entries.forEach(([, data]) => {
          totalQuantitySumInOrder += parseQuantity(data.pedidoQty || 0);
          totalQuantitySumInOrder += parseQuantity(data.creditQty || 0);
        });
      }

      if (itemCountElement) {
        if (document.getElementById('ordenTab').style.display !== 'none') { // Comprobar si la pestaña está activa
          if (distinctItemCountInOrder === 0) {
            // Anular la visualización de la cuadrícula para centrar el mensaje
            container.className = ''; // Limpiar clases de cuadrícula
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.justifyContent = 'center';
            container.style.alignItems = 'center';
            container.style.height = 'calc(100vh - 280px)'; // Ajustar según la altura de la cabecera/botones
            container.style.gap = '0'; // Asegurar que no haya espacio de la cuadrícula

            const emptyMessage = document.createElement('div');
            emptyMessage.style.textAlign = 'center';
            emptyMessage.style.padding = '20px';
            emptyMessage.style.color = '#666';
            emptyMessage.innerHTML = '<span class="material-icons" style="font-size:48px; margin-bottom:10px; display:block;">shopping_cart</span>No hay productos en tu orden.<br>Añade cantidades en la pestaña "Pedido".';
            container.appendChild(emptyMessage);

            if (itemCountElement && document.getElementById('ordenTab').style.display !== 'none') {
                itemCountElement.textContent = "Orden vacía";
            }
            return;
      } else {
            let countText = `Orden: ${distinctItemCountInOrder} ítem(s)`;
            if (totalQuantitySumInOrder > 0) {
              countText += ` / Total: ${formatQuantity(totalQuantitySumInOrder)} unidades`; // Usamos formatQuantity por si da 0.5
            }
            itemCountElement.textContent = countText;
          }
        }
      }
      
      // Si no hay productos con cantidad, mostrar mensaje
      if (entries.length === 0) {
        // Anular la visualización de la cuadrícula para centrar el mensaje
        container.className = ''; // Limpiar clases de cuadrícula
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.justifyContent = 'center';
        container.style.alignItems = 'center';
        container.style.height = 'calc(100vh - 280px)'; // Ajustar según la altura de la cabecera/botones
        container.style.gap = '0'; // Asegurar que no haya espacio de la cuadrícula

        const emptyMessage = document.createElement('div');
        emptyMessage.style.textAlign = 'center';
        emptyMessage.style.padding = '20px';
        emptyMessage.style.color = '#666';
        emptyMessage.innerHTML = '<span class="material-icons" style="font-size:48px; margin-bottom:10px; display:block;">shopping_cart</span>No hay productos en tu orden.<br>Añade cantidades en la pestaña "Pedido".';
        container.appendChild(emptyMessage);

        if (itemCountElement && document.getElementById('ordenTab').style.display !== 'none') {
            itemCountElement.textContent = "Orden vacía";
        }
        return;
      }
      
      // Si no está vacío, asegurar que los estilos flex se eliminen y la cuadrícula esté activa
      // La clase de cuadrícula ya se estableció arriba, solo limpiar los estilos en línea.
      container.style.display = ''; 
      container.style.flexDirection = '';
      container.style.justifyContent = '';
      container.style.alignItems = '';
      container.style.height = '';
      container.style.gap = '';
      
      // Renderizar cada producto (igual que en renderPedidoTab pero solo productos con cantidad)
      entries.forEach(([name, data]) => {
        if (!data) return; // Skip invalid items
        
        // Crear el elemento de producto
        const item = document.createElement('div');
        item.className = 'item highlight'; // Siempre highlight porque siempre tienen cantidad
        
        // Espacio de imagen
        const imgSpace = document.createElement('div');
        imgSpace.className = 'img-space';
        imgSpace.onclick = () => showImageZoomModal(data.image, name);
        
        // Botón de edición
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-icon-btn';
        editBtn.innerHTML = '<span class="material-icons">edit</span>';
        editBtn.onclick = function(e) { 
          e.stopPropagation();
          editItem(name);
          return false;
        };
        
        // Botón de créditos
        const creditBtn = document.createElement('button');
        creditBtn.className = 'credit-icon-btn';
        creditBtn.innerHTML = '<span class="material-icons">loyalty</span>';
        creditBtn.onclick = function(e) { 
          e.stopPropagation();
          openCreditModal(name);
          return false;
        };
        
        imgSpace.appendChild(editBtn);
        imgSpace.appendChild(creditBtn);
        
        // Imagen del producto (si existe)
        if (data.image) {
          const img = document.createElement('img');
          img.src = data.image;
          imgSpace.appendChild(img);
        }
        
        // Información del producto
        const header = document.createElement('div');
        header.className = 'item-header';
        
        const productName = document.createElement('div');
        productName.className = 'product-name';
        productName.textContent = name;
        productName.onclick = () => showProductInfo(name);
        productName.style.cursor = 'pointer';
        
        const productNumber = document.createElement('div');
        productNumber.className = 'product-number';
        productNumber.textContent = '#' + (data.numero || '');
        
        header.appendChild(productName);
        header.appendChild(productNumber);
      
        // Fila de cantidad
        const quantityRow = document.createElement('div');
        quantityRow.className = 'quantity-row';
        
        const label = document.createElement('span');
        label.textContent = data.presentation || 'caja';
        
        const inputContainer = document.createElement('div');
        inputContainer.className = 'quantity-input-container';
        
        // Botón de decrementar siempre está presente porque siempre hay cantidad
        const decrementBtn = createQuantityButton('decrease', name, currentTabType);
        inputContainer.appendChild(decrementBtn);
        
        const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.value = data.pedidoQty && data.pedidoQty !== '0' ? data.pedidoQty : '';
        input.setAttribute('list', 'numbers');
        input.style.textAlign = 'center';
        input.style.display = 'inline-block';
        input.style.alignItems = 'center';
        input.style.justifyContent = 'center';
        input.onfocus = function() { this.select(); };
        input.onblur = function() { 
      const items = getAllItems();
          if (items[name]) {
            // Si el valor es 0 o vacío, establecer a 0 (que se interpretará como sin cantidad)
            const newValue = this.value && this.value !== '0' ? this.value : 0;
            items[name].pedidoQty = newValue;
      setAllItems(items);
      
            // Si el valor es 0, establecer el valor visible a vacío
            if (newValue === 0 || newValue === '0') {
              this.value = '';
            }
            
            // Actualizar todas las pestañas para reflejar el cambio
            renderTabs();
          }
        };
        input.onkeydown = function(e) {
          if (e.key === 'Enter') this.blur();
        };
        
        inputContainer.appendChild(input);
        
        // Botón de incrementar
        const incrementBtn = createQuantityButton('increase', name, currentTabType);
        inputContainer.appendChild(incrementBtn);
        
        quantityRow.appendChild(label);
        quantityRow.appendChild(inputContainer);
        
        // Agregar todos los elementos al ítem
        item.appendChild(imgSpace);
        item.appendChild(header);
        item.appendChild(quantityRow);
        
        // Agregar el ítem al contenedor
        container.appendChild(item);
        
        // Verificar si hay créditos para este producto y crear un elemento adicional si es necesario
        if (data.creditQty && data.creditQty !== 0) {
          // Crear el elemento de crédito (casi idéntico pero con indicadores visuales de crédito)
          const creditItem = document.createElement('div');
          creditItem.className = 'item highlight';
          creditItem.style.borderColor = '#c00';
      
          // Espacio de imagen (igual al original)
          const creditImgSpace = document.createElement('div');
          creditImgSpace.className = 'img-space';
          creditImgSpace.onclick = () => showImageZoomModal(data.image, name);
          
          if (data.image) {
            const creditImg = document.createElement('img');
            creditImg.src = data.image;
            creditImgSpace.appendChild(creditImg);
          }
          
          // Overlay para indicar crédito
          const creditOverlay = document.createElement('div');
          creditOverlay.style.position = 'absolute';
          creditOverlay.style.top = '0';
          creditOverlay.style.right = '0';
          creditOverlay.style.background = '#c00';
          creditOverlay.style.color = 'white';
          creditOverlay.style.padding = '2px 6px';
          creditOverlay.style.fontSize = '0.7rem';
          creditOverlay.style.borderRadius = '0 0 0 8px';
          creditOverlay.textContent = 'CRÉDITO';
          
          creditImgSpace.appendChild(creditOverlay);
          
          // Información del producto (igual al original)
          const creditHeader = document.createElement('div');
          creditHeader.className = 'item-header';
          
          const creditProductName = document.createElement('div');
          creditProductName.className = 'product-name';
          creditProductName.textContent = name;
          creditProductName.onclick = () => showProductInfo(name);
          creditProductName.style.cursor = 'pointer';
      
          const creditProductNumber = document.createElement('div');
          creditProductNumber.className = 'product-number';
          creditProductNumber.textContent = '#' + (data.numero || '');
          
          creditHeader.appendChild(creditProductName);
          creditHeader.appendChild(creditProductNumber);
          
          // Fila de cantidad (con etiqueta de crédito)
          const creditQuantityRow = document.createElement('div');
          creditQuantityRow.className = 'quantity-row';
          
          const creditLabel = document.createElement('span');
          creditLabel.textContent = (data.creditPresentation || data.presentation || 'caja') + ' (CRÉDITO)';
          creditLabel.style.color = '#c00';
          
          const creditInputContainer = document.createElement('div');
          creditInputContainer.className = 'quantity-input-container';
          
          const creditInput = document.createElement('input');
          creditInput.type = 'text';
          creditInput.inputMode = 'decimal';
          creditInput.value = data.creditQty && data.creditQty !== '0' ? data.creditQty : '';
          creditInput.setAttribute('list', 'numbers');
          creditInput.style.borderColor = '#c00';
          creditInput.style.color = '#c00';
          creditInput.style.textAlign = 'center';
          creditInput.style.display = 'inline-block';
          creditInput.style.alignItems = 'center';
          creditInput.style.justifyContent = 'center';
          creditInput.onfocus = function() { this.select(); };
          creditInput.onblur = function() { 
      const items = getAllItems();
            if (items[name]) {
              // Si el valor es 0 o vacío, se considera como sin crédito
              const newValue = this.value && this.value !== '0' ? this.value : 0;
              items[name].creditQty = newValue;
              items[name].creditPresentation = data.creditPresentation;
      setAllItems(items);
      
              // Si el valor es 0, establecer el valor visible a vacío
              if (newValue === 0 || newValue === '0') {
                this.value = '';
              }
              
              // Actualizar todas las pestañas porque hay cambios en créditos
              renderTabs();
            }
          };
          creditInput.onkeydown = function(e) {
            if (e.key === 'Enter') this.blur();
          };
          
          creditInputContainer.appendChild(creditInput);
          
          // Botón para eliminar crédito
          const removeCreditBtn = document.createElement('button');
          removeCreditBtn.type = "button";
          removeCreditBtn.className = 'quantity-btn';
          removeCreditBtn.style.background = '#c00';
          removeCreditBtn.innerHTML = 'x';
          removeCreditBtn.setAttribute('data-product', name);
          removeCreditBtn.onclick = function(event) { // Añadir event
            event.stopPropagation(); // Evitar que se propague a otros listeners del item
            removeCredit(this.getAttribute('data-product'));
            return false;
          };
          creditInputContainer.appendChild(removeCreditBtn);
          
          creditQuantityRow.appendChild(creditLabel);
          creditQuantityRow.appendChild(creditInputContainer);
          
          // Agregar todos los elementos al ítem de crédito
          creditItem.appendChild(creditImgSpace);
          creditItem.appendChild(creditHeader);
          creditItem.appendChild(creditQuantityRow);
          
          // Agregar el ítem de crédito al contenedor
          container.appendChild(creditItem);
        }
      });
    }

    function renderPedidoTab() {
      const container = document.getElementById('pedidoList');
      container.innerHTML = ''; // Limpiar el contenedor
      container.className = (currentColumns === 1) ? 'grid-1col' : (currentColumns === 2 ? 'grid-2col' : 'grid-pc');
      const itemCountElement = document.getElementById('itemCountDisplay');
      const currentTabType = 'pedido'; // Definir tipo de pestaña
      
      const items = getAllItems();
      let entries = Object.entries(items);
      
      // Aplicar filtros
      if (searchTerm) {
        const lowerSearchTerm = searchTerm.toLowerCase();
        entries = entries.filter(([key, data]) => {
          const lowerKey = key.toLowerCase();
          const productTags = data.tags || []; // Asegurarse de que tags exista
          return lowerKey.includes(lowerSearchTerm) || 
                 productTags.some(tag => tag.toLowerCase().includes(lowerSearchTerm));
        });
      }
      if (currentCompanyFilter) {
        entries = entries.filter(([, data]) => data && data.company === currentCompanyFilter);
      }
      
      // Ordenar entradas usando la nueva función de ordenación
      entries = sortEntriesByCurrentMode(entries);
      
      // Actualizar contador de ítems para la pestaña PEDIDO
      // Contar solo productos con cantidad de pedido > 0
      const pedidoConCantidad = entries.filter(([, data]) => data && data.pedidoQty && parseQuantity(data.pedidoQty) > 0);
      if (itemCountElement) {
        if (document.getElementById('pedidoTab').style.display !== 'none') { // Comprobar si la pestaña está activa
          if (pedidoConCantidad.length === 0) {
            itemCountElement.textContent = "Nada en pedido";
          } else if (pedidoConCantidad.length === 1) {
            itemCountElement.textContent = `1 producto en pedido`;
          } else {
            itemCountElement.textContent = `${pedidoConCantidad.length} productos en pedido`;
          }
        }
      }
      
      // Renderizar cada producto
      entries.forEach(([name, data]) => {
        if (!data) return; // Skip invalid items
        
        // Crear el elemento de producto
        const item = document.createElement('div');
        item.className = 'item' + ((data.pedidoQty && data.pedidoQty !== 0 && data.pedidoQty !== '0') ? ' highlight' : '');
        
        // Espacio de imagen
        const imgSpace = document.createElement('div');
        imgSpace.className = 'img-space';
        imgSpace.onclick = () => showImageZoomModal(data.image, name);
        
        // Botón de edición
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-icon-btn';
        editBtn.innerHTML = '<span class="material-icons">edit</span>';
        editBtn.onclick = function(e) { 
          e.stopPropagation();
          editItem(name);
          return false;
        };
        
        // Botón de créditos
        const creditBtn = document.createElement('button');
        creditBtn.className = 'credit-icon-btn';
        creditBtn.innerHTML = '<span class="material-icons">loyalty</span>';
        creditBtn.onclick = function(e) { 
          e.stopPropagation();
          openCreditModal(name);
          return false;
        };
        
        imgSpace.appendChild(editBtn);
        imgSpace.appendChild(creditBtn);
        
        // Imagen del producto (si existe)
        if (data.image) {
          const img = document.createElement('img');
          img.src = data.image;
          imgSpace.appendChild(img);
        }
        
        // Información del producto
        const header = document.createElement('div');
        header.className = 'item-header';
        
        const productName = document.createElement('div');
        productName.className = 'product-name';
        productName.textContent = name;
        productName.onclick = () => showProductInfo(name);
        productName.style.cursor = 'pointer';
        
        const productNumber = document.createElement('div');
        productNumber.className = 'product-number';
        productNumber.textContent = '#' + (data.numero || '');
        
        header.appendChild(productName);
        header.appendChild(productNumber);
        
        // Fila de cantidad
        const quantityRow = document.createElement('div');
        quantityRow.className = 'quantity-row';
        
        const label = document.createElement('span');
        label.textContent = data.presentation || 'caja';
        
        const inputContainer = document.createElement('div');
        inputContainer.className = 'quantity-input-container';
        
        // Botón de decrementar (solo se muestra si hay cantidad mayor que cero)
        const hasQuantity = data.pedidoQty && data.pedidoQty !== 0 && data.pedidoQty !== '0';
        
        if (hasQuantity) {
          const decrementBtn = createQuantityButton('decrease', name, currentTabType);
          inputContainer.appendChild(decrementBtn);
        }
        
                  const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.value = data.pedidoQty && data.pedidoQty !== '0' ? data.pedidoQty : '';
        input.setAttribute('list', 'numbers');
        input.style.textAlign = 'center';
        input.style.display = 'inline-block';
        input.style.alignItems = 'center';
        input.style.justifyContent = 'center';
        input.onfocus = function() { this.select(); };
        input.onblur = function() { 
          const items = getAllItems();
          if (items[name]) {
            // Si el valor es 0 o vacío, establecer a 0 (que se interpretará como sin cantidad)
            const newValue = this.value && this.value !== '0' ? this.value : 0;
            items[name].pedidoQty = newValue;
            setAllItems(items);
            
            // Si el valor es 0, establecer el valor visible a vacío
            if (newValue === 0 || newValue === '0') {
              this.value = '';
            }
            
            // Update just this product without reloading the entire tab
            updateProductQuantityUI(name, newValue, 'pedido');
          }
        };
        input.onkeydown = function(e) {
          if (e.key === 'Enter') this.blur();
        };
        
        inputContainer.appendChild(input);
        
        // Botón de incrementar
        const incrementBtn = createQuantityButton('increase', name, currentTabType);
        inputContainer.appendChild(incrementBtn);
        
        quantityRow.appendChild(label);
        quantityRow.appendChild(inputContainer);
        
        // Agregar todos los elementos al ítem
        item.appendChild(imgSpace);
        item.appendChild(header);
        item.appendChild(quantityRow);
        
        // Agregar el ítem al contenedor
        container.appendChild(item);
        
        // Verificar si hay créditos para este producto y crear un elemento adicional si es necesario
        if (data.creditQty && data.creditQty !== 0) {
          // Crear el elemento de crédito (casi idéntico pero con indicadores visuales de crédito)
          const creditItem = document.createElement('div');
          creditItem.className = 'item highlight';
          creditItem.style.borderColor = '#c00';
          
          // Espacio de imagen (igual al original)
          const creditImgSpace = document.createElement('div');
          creditImgSpace.className = 'img-space';
          creditImgSpace.onclick = () => showImageZoomModal(data.image, name);
          
          if (data.image) {
            const creditImg = document.createElement('img');
            creditImg.src = data.image;
            creditImgSpace.appendChild(creditImg);
          }
          
          // Overlay para indicar crédito
          const creditOverlay = document.createElement('div');
          creditOverlay.style.position = 'absolute';
          creditOverlay.style.top = '0';
          creditOverlay.style.right = '0';
          creditOverlay.style.background = '#c00';
          creditOverlay.style.color = 'white';
          creditOverlay.style.padding = '2px 6px';
          creditOverlay.style.fontSize = '0.7rem';
          creditOverlay.style.borderRadius = '0 0 0 8px';
          creditOverlay.textContent = 'CRÉDITO';
          
          creditImgSpace.appendChild(creditOverlay);
          
          // Información del producto (igual al original)
          const creditHeader = document.createElement('div');
          creditHeader.className = 'item-header';
          
          const creditProductName = document.createElement('div');
          creditProductName.className = 'product-name';
          creditProductName.textContent = name;
          creditProductName.onclick = () => showProductInfo(name);
          creditProductName.style.cursor = 'pointer';
      
          const creditProductNumber = document.createElement('div');
          creditProductNumber.className = 'product-number';
          creditProductNumber.textContent = '#' + (data.numero || '');
          
          creditHeader.appendChild(creditProductName);
          creditHeader.appendChild(creditProductNumber);
          
          // Fila de cantidad (con etiqueta de crédito)
          const creditQuantityRow = document.createElement('div');
          creditQuantityRow.className = 'quantity-row';
          
          const creditLabel = document.createElement('span');
          creditLabel.textContent = (data.creditPresentation || data.presentation || 'caja') + ' (CRÉDITO)';
          creditLabel.style.color = '#c00';
          
          const creditInputContainer = document.createElement('div');
          creditInputContainer.className = 'quantity-input-container';
          
          const creditInput = document.createElement('input');
          creditInput.type = 'text';
          creditInput.inputMode = 'decimal';
          creditInput.value = data.creditQty && data.creditQty !== '0' ? data.creditQty : '';
          creditInput.setAttribute('list', 'numbers');
          creditInput.style.borderColor = '#c00';
          creditInput.style.color = '#c00';
          creditInput.style.textAlign = 'center';
          creditInput.style.display = 'inline-block';
          creditInput.style.alignItems = 'center';
          creditInput.style.justifyContent = 'center';
          creditInput.onfocus = function() { this.select(); };
          creditInput.onblur = function() { 
            const items = getAllItems();
            if (items[name]) {
              // Si el valor es 0 o vacío, se considera como sin crédito
              const newValue = this.value && this.value !== '0' ? this.value : 0;
              items[name].creditQty = newValue;
              items[name].creditPresentation = data.creditPresentation;
              setAllItems(items);
              
              // Si el valor es 0, establecer el valor visible a vacío
              if (newValue === 0 || newValue === '0') {
                this.value = '';
              }
              
              // Actualizar todas las pestañas porque hay cambios en créditos
              renderTabs();
            }
          };
          creditInput.onkeydown = function(e) {
            if (e.key === 'Enter') this.blur();
          };
          
          creditInputContainer.appendChild(creditInput);
          
          // Botón para eliminar crédito
          const removeCreditBtn = document.createElement('button');
          removeCreditBtn.type = "button";
          removeCreditBtn.className = 'quantity-btn';
          removeCreditBtn.style.background = '#c00';
          removeCreditBtn.innerHTML = 'x';
          removeCreditBtn.setAttribute('data-product', name);
          removeCreditBtn.onclick = function(event) { // Añadir event
            event.stopPropagation(); // Evitar que se propague a otros listeners del item
            removeCredit(this.getAttribute('data-product'));
            return false;
          };
          creditInputContainer.appendChild(removeCreditBtn);
          
          creditQuantityRow.appendChild(creditLabel);
          creditQuantityRow.appendChild(creditInputContainer);
          
          // Agregar todos los elementos al ítem de crédito
          creditItem.appendChild(creditImgSpace);
          creditItem.appendChild(creditHeader);
          creditItem.appendChild(creditQuantityRow);
          
          // Agregar el ítem de crédito al contenedor
          container.appendChild(creditItem);
        }
      });
    }

    function renderInventarioTab() {
      const container = document.getElementById('inventarioList');
      container.innerHTML = ''; // Limpiar el contenedor
      container.className = (currentColumns === 1) ? 'grid-1col' : (currentColumns === 2 ? 'grid-2col' : 'grid-pc');
      const itemCountElement = document.getElementById('itemCountDisplay');
      const currentTabType = 'inventario'; // Definir tipo de pestaña
      
      const items = getAllItems();
      let entries = Object.entries(items);
      
      // Aplicar filtros
      if (searchTerm) {
        const lowerSearchTerm = searchTerm.toLowerCase();
        entries = entries.filter(([key, data]) => {
          const lowerKey = key.toLowerCase();
          const productTags = data.tags || []; // Asegurarse de que tags exista
          return lowerKey.includes(lowerSearchTerm) || 
                 productTags.some(tag => tag.toLowerCase().includes(lowerSearchTerm));
        });
      }
      if (currentCompanyFilter) {
        entries = entries.filter(([, data]) => data && data.company === currentCompanyFilter);
      }
      
      // Ordenar entradas usando la nueva función de ordenación
      entries = sortEntriesByCurrentMode(entries);
      
      // Actualizar contador de ítems para la pestaña INVENTARIO
      // Cuenta todos los productos que coinciden con los filtros, tengan o no cantidad.
      if (itemCountElement) {
        if (document.getElementById('inventarioTab').style.display !== 'none') { // Comprobar si la pestaña está activa
          if (entries.length === 0) {
            itemCountElement.textContent = "Inventario vacío";
          } else if (entries.length === 1) {
            itemCountElement.textContent = `1 producto en inventario`;
          } else {
            itemCountElement.textContent = `${entries.length} productos en inventario`;
          }
        }
      }
      
      // Renderizar cada producto
      entries.forEach(([name, data]) => {
        if (!data) return; // Skip invalid items
        
        // Crear el elemento de producto
        const item = document.createElement('div');
        item.className = 'item' + ((data.inventarioQty && data.inventarioQty !== 0 && data.inventarioQty !== '0') ? ' highlight' : '');
        
        // Espacio de imagen
        const imgSpace = document.createElement('div');
        imgSpace.className = 'img-space';
        imgSpace.onclick = () => showImageZoomModal(data.image, name);
        
        // Botón de edición
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-icon-btn';
        editBtn.innerHTML = '<span class="material-icons">edit</span>';
        editBtn.onclick = function(e) { 
          e.stopPropagation();
          editItem(name);
          return false;
        };
        
        imgSpace.appendChild(editBtn);
        
        // Imagen del producto (si existe)
        if (data.image) {
          const img = document.createElement('img');
          img.src = data.image;
          imgSpace.appendChild(img);
        }
        
        // Información del producto
        const header = document.createElement('div');
        header.className = 'item-header';
        
        const productName = document.createElement('div');
        productName.className = 'product-name';
        productName.textContent = name;
        productName.onclick = () => showProductInfo(name);
        productName.style.cursor = 'pointer';
        
        const productNumber = document.createElement('div');
        productNumber.className = 'product-number';
        productNumber.textContent = '#' + (data.numero || '');
        
        header.appendChild(productName);
        header.appendChild(productNumber);
        
        // Fila de cantidad
        const quantityRow = document.createElement('div');
        quantityRow.className = 'quantity-row';
        
        const inputContainer = document.createElement('div');
        inputContainer.className = 'quantity-input-container';
        
        // Botón de decrementar (solo se muestra si hay cantidad mayor que cero)
        const hasQuantity = data.inventarioQty && data.inventarioQty !== 0 && data.inventarioQty !== '0';
        
        if (hasQuantity) {
          const decrementBtn = createQuantityButton('decrease', name, currentTabType);
          inputContainer.appendChild(decrementBtn);
        }
        
                  const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.value = data.inventarioQty && data.inventarioQty !== '0' ? data.inventarioQty : '';
        input.setAttribute('list', 'numbers');
        input.onfocus = function() { this.select(); };
        input.onblur = function() { 
          const items = getAllItems();
          if (items[name]) {
            // Si el valor es 0 o vacío, establecer a 0 (que se interpretará como sin cantidad)
            const newValue = this.value && this.value !== '0' ? this.value : 0;
            items[name].inventarioQty = newValue;
            setAllItems(items);
            
            // Si el valor es 0, establecer el valor visible a vacío
            if (newValue === 0 || newValue === '0') {
              this.value = '';
            }
            
            // Update just this product without reloading the entire tab
            updateProductQuantityUI(name, newValue, 'inventario');
          }
        };
        input.onkeydown = function(e) {
          if (e.key === 'Enter') this.blur();
        };
        
        inputContainer.appendChild(input);
        
        // Botón de incrementar
        const incrementBtn = createQuantityButton('increase', name, currentTabType);
        inputContainer.appendChild(incrementBtn);
        
        const unit = document.createElement('span');
        unit.textContent = data.unit || 'pz';
        
        quantityRow.appendChild(inputContainer);
        quantityRow.appendChild(unit);
        
        // Agregar todos los elementos al ítem
        item.appendChild(imgSpace);
        item.appendChild(header);
        item.appendChild(quantityRow);
        
        // Agregar el ítem al contenedor
        container.appendChild(item);
      });
    }

    function updateSearch(val) {
      searchTerm = val.trim();
      const clearBtn = document.querySelector('.search-bar .clear-search-btn');
      if (clearBtn) {
        clearBtn.style.display = searchTerm ? 'inline-block' : 'none';
      }
      saveFiltersAndState();
      renderTabs();
    }

    function setColumns(mode) {
      currentColumns = mode;
      document.getElementById('viewOptions').style.display = 'none';
      saveFiltersAndState();
      renderTabs();
    }

    function setSortMode(mode) {
      sortMode = mode;
      document.getElementById('viewOptions').style.display = 'none';
      saveFiltersAndState();
      renderTabs();
    }

    function toggleViewOptions() {
      const menu = document.getElementById('viewOptions');
      menu.style.display = (menu.style.display === 'flex') ? 'none' : 'flex';
    }

    /* ===== EDICIÓN DE PRODUCTOS ===== */
    function addNewProduct() {
      currentEdit = null;
      document.getElementById('editModalTitle').textContent = 'Nuevo Producto';
      document.getElementById('deleteProductBtn').style.display = 'none';
      
      // Limpiar campos
      document.getElementById('editName').value = '';
      document.getElementById('editNumber').value = '';
      document.getElementById('editCategory').value = '';
      document.getElementById('editStock').value = '';
      document.getElementById('editCustomMargin').value = '';
      // Por defecto, el tipo de margen es porcentaje para nuevos productos
      document.getElementById('marginTypePercent').checked = true;
      document.getElementById('editImageUrl').value = '';
      document.getElementById('editImageFile').value = '';
      document.getElementById('editTags').value = ''; // Limpiar campo de tags para nuevo producto
      
      // Limpiar campos de información de caja
      document.getElementById('editUnidadesPorCaja').value = '';
      document.getElementById('editPaquetesPorCaja').value = '';
      
      // Llenar selects
      fillSelectOptions('editUnit', getUnits());
      fillSelectOptions('editPresentation', getPresentations());
      fillSelectOptions('editCompany', getCompanies().map(c => c.name));
      fillCustomSortPositionSelect(currentEdit ? name : null); // Llenar select de orden personalizado
      
      // Limpiar precios
      document.getElementById('priceContainer').innerHTML = '';
      
      // Mostrar modal
      document.getElementById('editModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function editItem(name) {
      const items = getAllItems();
      if (!items[name]) return;
      
      currentEdit = name;
      document.getElementById('editModalTitle').textContent = 'Editar Producto';
      document.getElementById('deleteProductBtn').style.display = 'inline-block';
      
      // Llenar campos
      document.getElementById('editName').value = name;
      document.getElementById('editNumber').value = items[name].numero || '';
      document.getElementById('editCategory').value = items[name].category || '';
      document.getElementById('editStock').value = items[name].stock || '';
      document.getElementById('editCustomMargin').value = items[name].customMargin || '';
      // Cargar el tipo de margen guardado, o por defecto a 'percent'
      if (items[name].marginType === 'fixed') {
        document.getElementById('marginTypeFixed').checked = true;
      } else {
        document.getElementById('marginTypePercent').checked = true;
      }
      document.getElementById('editImageUrl').value = items[name].image || '';
      document.getElementById('editImageFile').value = '';
      document.getElementById('editTags').value = items[name].tags ? items[name].tags.join(', ') : ''; // Cargar tags
      
      // Llenar campos de información de caja
      document.getElementById('editUnidadesPorCaja').value = items[name].unidadesPorCaja || '';
      document.getElementById('editPaquetesPorCaja').value = items[name].paquetesPorCaja || '';
      
      // Llenar selects
      fillSelectOptions('editUnit', getUnits(), items[name].unit);
      fillSelectOptions('editPresentation', getPresentations(), items[name].presentation);
      fillSelectOptions('editCompany', getCompanies().map(c => c.name), items[name].company);
      fillCustomSortPositionSelect(name, items[name].customSortOrder); // Llenar select de orden personalizado
      
      // Llenar precios
      document.getElementById('priceContainer').innerHTML = '';
      if (items[name].prices && items[name].prices.length) {
        items[name].prices.forEach(p => {
          addPriceRow(p.company, p.price);
        });
      }
      
      // Mostrar modal
      document.getElementById('editModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function fillSelectOptions(selectId, options, selectedValue = null) {
      const select = document.getElementById(selectId);
      select.innerHTML = '';
      
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
      });
      
      if (selectedValue !== null) {
        select.value = selectedValue;
      }
    }

    function saveChanges() {
      const name = document.getElementById('editName').value.trim().toUpperCase();
      if (!name) {
        alert('El nombre del producto no puede estar vacío');
        return;
      }
      
      const items = getAllItems();
      
      // Verificar si el nuevo nombre ya existe (solo si estamos renombrando)
      if (currentEdit && currentEdit !== name && items[name]) {
        alert('Ya existe un producto con ese nombre');
        return;
      }
      
      // Obtener valores de los campos
      const numero = document.getElementById('editNumber').value.trim();
      const unit = document.getElementById('editUnit').value;
      const presentation = document.getElementById('editPresentation').value;
      const category = document.getElementById('editCategory').value;
      const company = document.getElementById('editCompany').value;
      const stock = document.getElementById('editStock').value;
      const customMargin = document.getElementById('editCustomMargin').value.trim();
      const imageUrl = document.getElementById('editImageUrl').value.trim();
      const tagsInput = document.getElementById('editTags').value.trim();
      const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : []; // Convertir a array, limpiar y a minúsculas
      const marginType = document.querySelector('input[name="marginType"]:checked').value;
      
      // Obtener información de la caja
      const unidadesPorCaja = document.getElementById('editUnidadesPorCaja').value.trim();
      const paquetesPorCaja = document.getElementById('editPaquetesPorCaja').value.trim();
      
      // Obtener precios
      const prices = [];
      document.querySelectorAll('#priceContainer .price-row').forEach(row => {
        const companySelect = row.querySelector('select');
        const priceInput = row.querySelector('input');
        
        if (companySelect && priceInput && companySelect.value && priceInput.value) {
          prices.push({
            company: companySelect.value,
            price: priceInput.value
          });
        }
      });
      
      // Si hay una imagen de archivo, procesarla
      const imageFile = document.getElementById('editImageFile').files[0];
      if (imageFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          saveItemData(name, {
            numero,
            unit,
            presentation,
            category,
            tags, // Guardar tags
            company,
            stock,
            customMargin: customMargin || null, // Guardar valor del margen
            marginType: customMargin ? marginType : 'percent', // Guardar tipo, si no hay customMargin, default a percent
            unidadesPorCaja: unidadesPorCaja || null,
            paquetesPorCaja: paquetesPorCaja || null,
            prices,
            image: e.target.result,
            pedidoQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].pedidoQty || 0) : 0,
            inventarioQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].inventarioQty || 0) : 0
          });
        };
        reader.readAsDataURL(imageFile);
      } else {
        // Usar la URL de imagen
        saveItemData(name, {
          numero,
          unit,
          presentation,
          category,
          tags, // Guardar tags
          company,
          stock,
          customMargin: customMargin || null, // Guardar valor del margen
          marginType: customMargin ? marginType : 'percent', // Guardar tipo, si no hay customMargin, default a percent
          unidadesPorCaja: unidadesPorCaja || null,
          paquetesPorCaja: paquetesPorCaja || null,
          prices,
          image: imageUrl,
          pedidoQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].pedidoQty || 0) : 0,
          inventarioQty: (currentEdit && items[currentEdit]) ? (items[currentEdit].inventarioQty || 0) : 0
        });
      }
    }

    function saveItemData(name, data) {
      const items = getAllItems();
      
      // Si estamos renombrando, eliminar el item original
      if (currentEdit && currentEdit !== name) {
        delete items[currentEdit];
      }
      
      // Guardar el nuevo item
      items[name] = data;
      setAllItems(items);
      
      // Cerrar modal y actualizar vista
      closeModal();
      renderTabs();
    }

    function deleteItem() {
      if (!currentEdit) return;
      
      if (confirm(`¿Seguro que quieres eliminar "${currentEdit}"?`)) {
        const items = getAllItems();
        delete items[currentEdit];
        setAllItems(items);
        closeModal();
        renderTabs();
      }
    }

    function closeModal() {
      document.getElementById('editModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
      currentEdit = null;
    }

    /* ===== FUNCIONES DE PRECIOS ===== */
    function addPriceRow(company = '', price = '') {
      const container = document.getElementById('priceContainer');
      
      const row = document.createElement('div');
      row.className = 'price-row';
      
      // Select de compañía
      const select = document.createElement('select');
      select.className = 'price-company';
      
      getCompanies().forEach(c => {
        const option = document.createElement('option');
        option.value = c.name;
        option.textContent = c.name;
        if (c.name === company) option.selected = true;
        select.appendChild(option);
      });
      
      // Input de precio
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'price-value';
      input.value = price;
      input.placeholder = 'Precio';
      input.style.width = '80px';
      input.inputMode = 'decimal'; // Mejorar experiencia en móviles para precios
      
      // Botón de eliminar
      const button = document.createElement('button');
      button.type = 'button';
      // button.textContent = 'Eliminar'; // Modificado para usar icono
      button.innerHTML = '<span class="material-icons" style="font-size: 20px; vertical-align: middle;">delete_outline</span>';
      button.style.width = 'auto';
      button.style.height = 'auto';
      button.style.borderRadius = '6px'; // Este estilo se moverá a CSS
      // button.style.padding = '8px 12px'; // Este estilo se manejará por CSS
      button.onclick = function() {
        row.remove();
      };
      
      row.appendChild(select);
      row.appendChild(input);
      row.appendChild(button);
      
      container.appendChild(row);
    }

    /* ===== FUNCIONES DE INFORMACIÓN DE PRODUCTO ===== */
    function showProductInfo(name) {
      const items = getAllItems();
      if (!items[name]) return;
      
      const product = items[name];
      
      // Obtener logo de compañía
      let mainLogo = APP_DEFAULT_LOGO;
      if (product.company) {
        const comp = getCompanies().find(c => c.name === product.company);
        if (comp && comp.image) mainLogo = comp.image;
      }
      
      // Calcular precio sugerido
      let lowestPrice = 0;
      if (product.prices && product.prices.length) {
        lowestPrice = Math.min(...product.prices.map(p => parseFloat(p.price) || 0));
      }
      
      const defaultMargin = parseFloat(localStorage.getItem('defaultMarginPercent') || '45');
      const customMarginValue = product.customMargin ? parseFloat(product.customMargin) : null;
      const marginType = product.marginType || 'percent'; // Default a 'percent' si no está definido
      
      let suggestedPriceNum = 0;
      if (lowestPrice > 0) {
        if (customMarginValue !== null && product.customMargin !== '') { // Hay un margen personalizado y no está vacío
          if (marginType === 'fixed') {
            suggestedPriceNum = lowestPrice + customMarginValue;
          } else { // Es 'percent'
            const marginToUse = customMarginValue;
      const marginMultiplier = 1 + (marginToUse / 100);
            suggestedPriceNum = lowestPrice * marginMultiplier;
          }
        } else { // No hay margen personalizado o está vacío, usar el general (que es siempre porcentaje)
          const marginToUse = defaultMargin;
          const marginMultiplier = 1 + (marginToUse / 100);
          suggestedPriceNum = lowestPrice * marginMultiplier;
        }
      }
      
      const suggestedPrice = suggestedPriceNum > 0 ? suggestedPriceNum.toFixed(2) : '0.00';
      
      // Calcular precio individual
      let precioIndividual = '0.00';
      let precioCaja = suggestedPrice;
      
      // Si hay información de unidades por caja, calcular precio individual
      if (product.unidadesPorCaja && parseFloat(product.unidadesPorCaja) > 0 && lowestPrice > 0) {
        // Precio por unidad
        const unidadesPorCaja = parseFloat(product.unidadesPorCaja);
        precioIndividual = (parseFloat(suggestedPrice) / unidadesPorCaja).toFixed(2);
      }
      
      // Construir HTML
      let infoHTML = `
        <div class="product-card">
          <div class="product-header">
            <img src="${mainLogo}" alt="${product.company || 'Logo'}" class="product-logo" />
            <div class="header-text">
              <h2 class="product-name">${escapeHtml(name)}</h2>
              <p class="product-code">${product.numero ? '#' + product.numero : ''}</p>
            </div>
          </div>
          
          <div class="product-details">
            <div class="detail-item">
              <span class="detail-label">Departamento:</span>
              <span class="detail-value">${product.category || 'General'}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Stock:</span>
              <span class="detail-value">${product.stock || '0'} ${product.unit || 'pz'}</span>
            </div>`;
      
      // Agregar información de la caja si existe
      if (product.unidadesPorCaja || product.paquetesPorCaja) {
        infoHTML += `
            <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">
            <h4 style="margin: 10px 0 5px; font-size: 0.95rem; color: #333;">Información de la Caja</h4>`;
        
        if (product.unidadesPorCaja) {
          infoHTML += `
            <div class="detail-item">
              <span class="detail-label">Unidades por caja:</span>
              <span class="detail-value">${product.unidadesPorCaja}</span>
            </div>`;
        }
        
        if (product.paquetesPorCaja) {
          infoHTML += `
            <div class="detail-item">
              <span class="detail-label">Paquetes por caja:</span>
              <span class="detail-value">${product.paquetesPorCaja}</span>
            </div>`;
        }
      }
      
      infoHTML += `
          </div>
          
          <div class="price-list">
            <h3 class="section-title">Precios</h3>
            <div class="prices-container">`;
      
      // Agregar precios
      if (product.prices && product.prices.length) {
        product.prices.forEach(p => {
          let compLogo = APP_DEFAULT_LOGO;
          const comp = getCompanies().find(c => c.name === p.company);
          if (comp && comp.image) compLogo = comp.image;
          
          infoHTML += `
            <div class="price-row">
              <div class="price-company">
                <img src="${compLogo}" alt="${p.company}" class="company-logo" />
                <span class="company-name">${p.company}</span>
              </div>
              <div class="price-value">${p.price}</div>
            </div>`;
        });
        
        // Precios sugeridos (caja e individual)
        infoHTML += `
          <div style="margin-top: 15px;">
            <div class="suggested-price" style="margin-bottom: 8px;">
              <div class="suggested-label">Precio sugerido por caja</div>
              <div class="suggested-value">${precioCaja}</div>
            </div>`;
          
        // Mostrar precio individual si hay unidades por caja
        if (product.unidadesPorCaja && parseFloat(product.unidadesPorCaja) > 0) {
          infoHTML += `
            <div class="suggested-price" style="background: #555;">
              <div class="suggested-label">Precio sugerido por unidad</div>
              <div class="suggested-value">${precioIndividual}</div>
            </div>`;
        }
        
        infoHTML += `</div>`;
      } else {
        infoHTML += `<p class="no-prices">No hay precios definidos.</p>`;
      }
      
      infoHTML += `
            </div>
          </div>
        </div>`;
      
      document.getElementById('infoContent').innerHTML = infoHTML;
      document.getElementById('infoModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeInfoModal() {
      document.getElementById('infoModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    /* ===== FUNCIONES DE COMPAÑÍA ===== */
    // Event listener para cerrar el popup al hacer clic en cualquier parte
    document.addEventListener('click', function(event) {
      const popup = document.getElementById('companyPopup');
      const companySelector = document.querySelector('.company-selector');
      
      // Si el popup está abierto y se hace clic fuera del popup y del selector
      if (popup.classList.contains('show') && 
          !popup.contains(event.target) && 
          !companySelector.contains(event.target)) {
        popup.classList.remove('show');
      }
    });

    function toggleCompanyPopup(event) {
      if (event) {
        event.stopPropagation();
      }
      
      const popup = document.getElementById('companyPopup');
      popup.classList.toggle('show');
      
      if (popup.classList.contains('show')) {
        buildCompanyPopup();
      }
    }

    function buildCompanyPopup() {
      const popup = document.getElementById('companyPopup');
      popup.innerHTML = '';
      
      // Opción "Todas"
      const allItem = document.createElement('div');
      allItem.className = 'company-item';
      // No mostrar logo para "Todas" en el popup, solo texto, o un icono genérico si se prefiere.
      allItem.innerHTML = `<span class="material-icons" style="margin-right:10px; font-size:20px; vertical-align:middle;">storefront</span><span>Todas las Compañías</span>`;
      allItem.onclick = function(e) {
        e.stopPropagation(); // Add this line
        selectCompany('');
      };
      popup.appendChild(allItem);
      
      // Opciones de compañías
      getCompanies().forEach(c => {
        const item = document.createElement('div');
        item.className = 'company-item';
        item.innerHTML = `<img src="${c.image || APP_DEFAULT_LOGO}" alt="${c.name}" /><span>${c.name}</span>`;
        item.onclick = function(e) {
          e.stopPropagation(); // Add this line
          selectCompany(c.name);
        };
        popup.appendChild(item);
      });
    }

    function selectCompany(name) {
      currentCompanyFilter = name;
      toggleCompanyPopup(); // Esto debería cerrar el popup
      // updateCurrentCompanyLogo(); // Ya no hay un logo visible permanente para actualizar aquí.
      // Sin embargo, la lógica de filtrado y guardado debe permanecer.
      saveFiltersAndState();
      renderTabs();
      updateCurrentCompanyLogo(); // <--- AÑADIR ESTA LLAMADA AQUÍ
    }

    function updateCurrentCompanyLogo() {
      // const logoElem = document.getElementById('currentCompanyLogo'); // Elemento ya no existe
      // if (!logoElem) return; 

      // Esta función ahora podría usarse para actualizar el 'title' del botón de tienda
      // o alguna otra indicación visual si se decide implementar.
      const storeButton = document.querySelector('.store-icon-btn');
      if (storeButton) {
        if (!currentCompanyFilter) {
          storeButton.title = "Seleccionar Compañía (Todas)";
        } else {
          storeButton.title = `Compañía: ${currentCompanyFilter}`;
        }
      }
      // La lógica original que actualizaba un img src ya no es necesaria.
      /*
      if (!currentCompanyFilter) {
        logoElem.src = APP_DEFAULT_LOGO;
      } else {
        const comp = getCompanies().find(c => c.name === currentCompanyFilter);
        logoElem.src = comp && comp.image ? comp.image : APP_DEFAULT_LOGO;
      }
      */

      // Nueva lógica para actualizar el icono/logo del botón de tienda
      const iconContainer = document.getElementById('storeButtonIconContainer');
      if (!iconContainer) return;

      if (!currentCompanyFilter) {
        // Mostrar icono storefront si "Todas las Compañías" está seleccionado
        iconContainer.innerHTML = '<span class="material-icons">storefront</span>';
      } else {
        const comp = getCompanies().find(c => c.name === currentCompanyFilter);
        if (comp && comp.image) {
          // Mostrar imagen de la compañía si existe
          iconContainer.innerHTML = `<img src="${comp.image}" alt="${escapeHtml(comp.name)}">`;
        } else {
          // Mostrar icono storefront si la compañía no tiene imagen
          iconContainer.innerHTML = '<span class="material-icons">storefront</span>';
        }
      }
    }

    /* ===== FUNCIONES DE CONFIGURACIÓN ===== */
    function openSettingsTab() {
      document.getElementById('settingsOverlay').classList.add('show');
      document.getElementById('settingsTab').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
      
      // Cargar margen predeterminado
      document.getElementById('defaultMarginPercent').value = localStorage.getItem('defaultMarginPercent') || '45';
      
      // Mostrar listas
      renderSettingsLists();
    }

    function closeSettingsTab() {
      document.getElementById('settingsOverlay').classList.remove('show');
      document.getElementById('settingsTab').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function renderSettingsLists() {
      // Unidades
      const unitsList = document.getElementById('unitsList');
      unitsList.innerHTML = '';
      
      getUnits().forEach(unit => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        item.innerHTML = `
          <span>${unit}</span>
          <div class="settings-actions">
            <button class="rename-btn"><span class="material-icons">edit</span></button>
            <button class="remove-btn"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.rename-btn').onclick = function() {
          const newName = prompt('Renombrar unidad:', unit);
          if (newName && newName.trim()) {
            const units = getUnits();
            const index = units.indexOf(unit);
            if (index !== -1) {
              units[index] = newName.trim();
              localStorage.setItem(UNITS_KEY, JSON.stringify(units));
              renderSettingsLists();
            }
          }
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          const units = getUnits();
          const index = units.indexOf(unit);
          if (index !== -1) {
            units.splice(index, 1);
            localStorage.setItem(UNITS_KEY, JSON.stringify(units));
            renderSettingsLists();
          }
        };
        
        unitsList.appendChild(item);
      });
      
      // Presentaciones (similar a unidades)
      const presentationsList = document.getElementById('presentationsList');
      presentationsList.innerHTML = '';
      
      getPresentations().forEach(presentation => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        item.innerHTML = `
          <span>${presentation}</span>
          <div class="settings-actions">
            <button class="rename-btn"><span class="material-icons">edit</span></button>
            <button class="remove-btn"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.rename-btn').onclick = function() {
          const newName = prompt('Renombrar presentación:', presentation);
          if (newName && newName.trim()) {
            const presentations = getPresentations();
            const index = presentations.indexOf(presentation);
            if (index !== -1) {
              presentations[index] = newName.trim();
              localStorage.setItem(PRESENTATIONS_KEY, JSON.stringify(presentations));
              renderSettingsLists();
            }
          }
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          const presentations = getPresentations();
          const index = presentations.indexOf(presentation);
          if (index !== -1) {
            presentations.splice(index, 1);
            localStorage.setItem(PRESENTATIONS_KEY, JSON.stringify(presentations));
            renderSettingsLists();
          }
        };
        
        presentationsList.appendChild(item);
      });
      
      // Categorías (similar a unidades)
      const categoriesList = document.getElementById('categoriesList');
      categoriesList.innerHTML = '';
      
      getCategories().forEach(category => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        item.innerHTML = `
          <span>${category}</span>
          <div class="settings-actions">
            <button class="rename-btn"><span class="material-icons">edit</span></button>
            <button class="remove-btn"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.rename-btn').onclick = function() {
          const newName = prompt('Renombrar categoría:', category);
          if (newName && newName.trim()) {
            const categories = getCategories();
            const index = categories.indexOf(category);
            if (index !== -1) {
              categories[index] = newName.trim();
              localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
              renderSettingsLists();
            }
          }
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          const categories = getCategories();
          const index = categories.indexOf(category);
          if (index !== -1) {
            categories.splice(index, 1);
            localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
            renderSettingsLists();
          }
        };
        
        categoriesList.appendChild(item);
      });
      
      // Compañías
      const companiesList = document.getElementById('companiesList');
      companiesList.innerHTML = '';
      
      getCompanies().forEach((company, index) => {
        const item = document.createElement('div');
        item.className = 'settings-list-item';
        
        // Mostrar miniatura de logo si existe
        let logoPreview = '';
        if (company.image) {
          logoPreview = `<img src="${company.image}" alt="${company.name}" style="width: 25px; height: 25px; border-radius: 50%; margin-right: 10px; object-fit: cover;">`;
        }
        
        let companyDetails = `<span>${logoPreview}${company.name}`;
        if (company.phone) {
          companyDetails += ` <small style="color: #777;">(${company.phone})</small>`;
        }
        companyDetails += `</span>`;
        
        item.innerHTML = `
          ${companyDetails}
          <div class="settings-actions">
            <button class="edit-btn" title="Editar compañía"><span class="material-icons">edit</span></button>
            <button class="remove-btn" title="Eliminar compañía"><span class="material-icons">close</span></button>
          </div>
        `;
        
        // Asignar eventos
        item.querySelector('.edit-btn').onclick = function() {
          editCompany(index);
        };
        
        item.querySelector('.remove-btn').onclick = function() {
          if (confirm(`¿Seguro que deseas eliminar la compañía "${company.name}"?`)) {
            const companies = getCompanies();
            companies.splice(index, 1);
            localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
            renderSettingsLists();
            updateCurrentCompanyLogo();
          }
        };
        
        companiesList.appendChild(item);
      });
    }
    
    function editCompany(index) {
      const companies = getCompanies();
      const company = companies[index];
      
      // Crear modal para editar
      const modalHTML = `
        <div id="editCompanyModal" class="modal" style="display: flex; opacity: 1; pointer-events: auto;">
          <div class="modal-content" style="max-width: 400px;">
            <h3>Editar Compañía</h3>
            <div class="form-group">
              <label for="editCompanyName">Nombre:</label>
              <input type="text" id="editCompanyName" value="${company.name}" />
            </div>
            <div class="form-group" style="margin-top: 10px;">
              ${company.image ? `<div style="text-align:center; margin-bottom: 10px;"><img src="${company.image}" style="max-width: 100px; max-height: 100px; margin: 0 auto;"></div>` : ''}
              <label for="editCompanyLogoFile">Actualizar logo (archivo):</label>
              <input type="file" id="editCompanyLogoFile" accept="image/*" />
            </div>
            <div style="margin-top: 8px; text-align: center;">
              <label>O</label>
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label for="editCompanyLogoUrl">URL del logo:</label>
              <input type="text" id="editCompanyLogoUrl" value="${company.image || ''}" placeholder="URL del logo" />
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label for="editCompanyPhone">Número de Teléfono:</label>
              <input type="tel" id="editCompanyPhone" value="${company.phone || ''}" placeholder="Ej. +1234567890" />
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label for="editCompanyMessage">Mensaje Predeterminado:</label>
              <textarea id="editCompanyMessage" placeholder="Ej. Hola, te envío la orden..." rows="3">${company.defaultMessage || ''}</textarea>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
              <button onclick="saveCompanyEdit(${index})" class="save-btn">Guardar</button>
              <button onclick="closeEditCompanyModal()" class="cancel-btn">Cancelar</button>
            </div>
          </div>
        </div>
      `;
      
      // Añadir modal al DOM
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHTML;
      document.body.appendChild(modalContainer);
    }
    
    function closeEditCompanyModal() {
      const modal = document.getElementById('editCompanyModal');
      if (modal) {
        modal.remove();
      }
    }
    
    function saveCompanyEdit(index) {
      const companies = getCompanies();
      const nameInput = document.getElementById('editCompanyName');
      const logoUrlInput = document.getElementById('editCompanyLogoUrl');
      const logoFileInput = document.getElementById('editCompanyLogoFile');
      const phoneInput = document.getElementById('editCompanyPhone');
      const messageInput = document.getElementById('editCompanyMessage');
      
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const defaultMessage = messageInput.value.trim();
      
      if (!name) {
        alert("Por favor ingresa un nombre para la compañía");
        return;
      }
      
      // Verificar si el nombre ya existe (excepto el mismo índice)
      if (companies.some((c, i) => i !== index && c.name === name)) {
        alert("Ya existe una compañía con ese nombre");
        return;
      }
      
      // Verificar si se seleccionó un archivo
      if (logoFileInput.files && logoFileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Actualizar con la imagen base64
          companies[index].name = name;
          companies[index].image = e.target.result;
          companies[index].phone = phone;
          companies[index].defaultMessage = defaultMessage;
          
          localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
          closeEditCompanyModal();
          renderSettingsLists();
          updateCurrentCompanyLogo();
        };
        reader.readAsDataURL(logoFileInput.files[0]);
      } 
      // Si no hay archivo, usar URL si está presente
      else if (logoUrlInput.value.trim()) {
        companies[index].name = name;
        companies[index].image = logoUrlInput.value.trim();
        companies[index].phone = phone;
        companies[index].defaultMessage = defaultMessage;
        
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        closeEditCompanyModal();
        renderSettingsLists();
        updateCurrentCompanyLogo();
      }
      // Solo actualizar nombre
      else {
        companies[index].name = name;
        // Mantener la imagen existente
        companies[index].phone = phone;
        companies[index].defaultMessage = defaultMessage;
        
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        closeEditCompanyModal();
        renderSettingsLists();
        updateCurrentCompanyLogo();
      }
    }

    function addUnit() {
      const input = document.getElementById('newUnitInput');
      const value = input.value.trim();
      
      if (value) {
        const units = getUnits();
        if (!units.includes(value)) {
          units.push(value);
          localStorage.setItem(UNITS_KEY, JSON.stringify(units));
          input.value = '';
          renderSettingsLists();
        }
      }
    }

    function addPresentation() {
      const input = document.getElementById('newPresentationInput');
      const value = input.value.trim();
      
      if (value) {
        const presentations = getPresentations();
        if (!presentations.includes(value)) {
          presentations.push(value);
          localStorage.setItem(PRESENTATIONS_KEY, JSON.stringify(presentations));
          input.value = '';
          renderSettingsLists();
        }
      }
    }

    function addCategory() {
      const input = document.getElementById('newCategoryInput');
      const value = input.value.trim();
      
      if (value) {
        const categories = getCategories();
        if (!categories.includes(value)) {
          categories.push(value);
          localStorage.setItem(CATEGORIES_KEY, JSON.stringify(categories));
          input.value = '';
          renderSettingsLists();
        }
      }
    }

    function addCompany() {
      const nameInput = document.getElementById('newCompanyName');
      const logoUrlInput = document.getElementById('newCompanyLogoUrl');
      const logoFileInput = document.getElementById('newCompanyLogoFile');
      const phoneInput = document.getElementById('newCompanyPhone');
      const messageInput = document.getElementById('newCompanyMessage');
      
      const name = nameInput.value.trim();
      const phone = phoneInput.value.trim();
      const defaultMessage = messageInput.value.trim();
      
      if (!name) {
        alert("Por favor ingresa un nombre para la compañía");
        return;
      }
      
      const companies = getCompanies();
      if (companies.some(c => c.name === name)) {
        alert("Ya existe una compañía con ese nombre");
        return;
      }
      
      // Verificar si se seleccionó un archivo
      if (logoFileInput.files && logoFileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Guardar la imagen como base64
          companies.push({ 
            name: name, 
            image: e.target.result,
            phone: phone,
            defaultMessage: defaultMessage
          });
          localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
          
          // Limpiar inputs
          nameInput.value = '';
          logoUrlInput.value = '';
          logoFileInput.value = '';
          phoneInput.value = '';
          messageInput.value = '';
          
          renderSettingsLists();
          alert("Compañía agregada correctamente con logo local");
        };
        reader.readAsDataURL(logoFileInput.files[0]);
      } 
      // Si no hay archivo, usar URL si está presente
      else if (logoUrlInput.value.trim()) {
        companies.push({ 
          name: name, 
          image: logoUrlInput.value.trim(),
          phone: phone,
          defaultMessage: defaultMessage
        });
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        
        // Limpiar inputs
        nameInput.value = '';
        logoUrlInput.value = '';
        logoFileInput.value = '';
        phoneInput.value = '';
        messageInput.value = '';
        
        renderSettingsLists();
        alert("Compañía agregada correctamente sin logo");
      }
      // Sin logo
      else {
        companies.push({ 
          name: name, 
          image: '',
          phone: phone,
          defaultMessage: defaultMessage
        });
        localStorage.setItem(COMPANIES_KEY, JSON.stringify(companies));
        
        // Limpiar inputs
        nameInput.value = '';
        logoUrlInput.value = '';
        logoFileInput.value = '';
        phoneInput.value = '';
        messageInput.value = '';
        
        renderSettingsLists();
        alert("Compañía agregada correctamente sin logo");
      }
    }

    function saveDefaultMargin() {
      const input = document.getElementById('defaultMarginPercent');
      const value = input.value.trim();
      
      if (value && !isNaN(parseFloat(value))) {
        localStorage.setItem('defaultMarginPercent', value);
        alert('Margen actualizado correctamente');
      } else {
        alert('Por favor ingresa un valor numérico válido');
        input.value = localStorage.getItem('defaultMarginPercent') || '45';
      }
    }

    function resetCustomMargin() {
      document.getElementById('editCustomMargin').value = '';
    }

    /* ===== FUNCIONES DE EXPORTAR/IMPORTAR ===== */
    function openExportModal() {
      document.getElementById('exportModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeExportModal() {
      document.getElementById('exportModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function confirmExport() {
      const items = getAllItems();
      const jsonStr = JSON.stringify(items, null, 2);
      const filename = "inventario_" + new Date().toISOString().split('T')[0] + ".json";
      
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      closeExportModal();
    }

    function triggerImport() {
      document.getElementById('importFile').click();
    }

    function importInventoryFile(file) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedItems = JSON.parse(e.target.result);
          setAllItems(importedItems);
          renderTabs();
          alert("Inventario importado con éxito");
        } catch (err) {
          console.error("Error al importar:", err);
          alert("Error al leer el archivo JSON. Revisa que sea un formato válido.");
        }
      };
      
      reader.readAsText(file);
    }

    /* ===== FUNCIONES DE BORRAR CANTIDADES ===== */
    function openDeletePedidoModal() {
      document.getElementById('deletePedidoModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeDeletePedidoModal() {
      document.getElementById('deletePedidoModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function confirmDeletePedido() {
      const items = getAllItems();
      
      for (const name in items) {
        if (items[name]) {
          items[name].pedidoQty = 0;
          items[name].creditQty = 0; // También borrar créditos
        }
      }
      
      setAllItems(items);
      renderTabs();
      closeDeletePedidoModal();
    }

    function openDeleteInventarioModal() {
      document.getElementById('deleteInventarioModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeDeleteInventarioModal() {
      document.getElementById('deleteInventarioModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function confirmDeleteInventario() {
      const items = getAllItems();
      
      for (const name in items) {
        if (items[name]) {
          items[name].inventarioQty = 0;
        }
      }
      
      setAllItems(items);
      renderTabs();
      closeDeleteInventarioModal();
    }

    /* ===== FUNCIONES PDF MEJORADAS ===== */
    function openShareModal() {
      document.getElementById('shareModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function generateAndProcessPDF(action) {
      try {
        const activeTabElement = document.querySelector('.tab.active');
        if (!activeTabElement) {
          alert("No se pudo determinar la pestaña activa.");
          return;
        }
        const activeTabName = activeTabElement.textContent.toLowerCase();
        const { jsPDF } = window.jspdf; // Mover la importación de jsPDF aquí si se usa en agrupado
        const pageWidth = new jsPDF().internal.pageSize.getWidth();
        const pageHeight = new jsPDF().internal.pageSize.getHeight();
        const margin = 15;

        let doc; // Para almacenar el documento PDF final
        let dataForPdf = [];
        let pdfTitle = "";
        let companyToDisplayInHeader = currentCompanyFilter; // Por defecto, si hay filtro global
        let pdfColumns = ['PRODUCTO', 'CANT.', 'UNIDAD'];
        let pdfColumnStyles = {
          0: { cellWidth: pageWidth - margin * 2 - 30 - 25 },
          1: { cellWidth: 25, halign: 'center' },
          2: { cellWidth: 30, halign: 'center' }
        };

        const allItemsObject = getAllItems();
        let baseEntries = Object.entries(allItemsObject);

        // CASO ESPECIAL: Pedido sin filtro de compañía - PDF Agrupado
        if (activeTabName === 'pedido' && !currentCompanyFilter) {
          console.log("[PDF GEN PREP] Iniciando generación de PDF agrupado para Pedido sin filtro.");
          doc = new jsPDF(); // Crear un nuevo doc para el agrupado
          let yPos = margin;

          doc.setFontSize(18);
          doc.setFont('helvetica', 'bold');
          doc.text("PEDIDO", pageWidth / 2, yPos, { align: 'center' });
          yPos += 10;

          doc.setFontSize(10);
          doc.setFont('helvetica', 'normal');
          const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
          doc.text('Fecha: ' + currentDate, pageWidth - margin - doc.getTextWidth('Fecha: ' + currentDate), yPos - 7);
          yPos += 7;

          const pedidoItems = baseEntries
              .filter(([, data]) => data && ((data.pedidoQty && parseQuantity(data.pedidoQty) > 0) || (data.creditQty && parseQuantity(data.creditQty) > 0)))
              .sort((a, b) => (a[1].company || 'ZZZ').localeCompare(b[1].company || 'ZZZ') || a[0].localeCompare(b[0]));

          const groupedByCompany = pedidoItems.reduce((acc, [name, data]) => {
              const companyName = data.company || 'Sin Compañía Asignada';
              if (!acc[companyName]) acc[companyName] = [];
              if (data.pedidoQty && parseQuantity(data.pedidoQty) > 0) {
                  acc[companyName].push([name, formatQuantity(parseQuantity(data.pedidoQty)), data.presentation || 'caja']);
              }
              if (data.creditQty && parseQuantity(data.creditQty) > 0) {
                  acc[companyName].push([name + " (CRÉDITO)", formatQuantity(parseQuantity(data.creditQty)), data.creditPresentation || data.presentation || 'caja']);
              }
              return acc;
          }, {});

          let totalItemsInOrder = 0;
          let totalQuantityInOrder = 0;

          Object.keys(groupedByCompany).sort().forEach((companyName, index, array) => {
              if (yPos > margin + 5) yPos += 7;
              const companyHeaderHeight = 25; const minSpaceNeeded = companyHeaderHeight + 20;
              if (yPos + minSpaceNeeded > pageHeight - margin - 15) { doc.addPage(); yPos = margin; }

              yPos = drawCompanyHeaderForGroupedPDF(doc, companyName, yPos, pageWidth, margin);
              const companyData = groupedByCompany[companyName];
              companyData.forEach(itemRow => { totalItemsInOrder++; totalQuantityInOrder += parseQuantity(itemRow[1]); });

              doc.autoTable({
                  startY: yPos, head: [pdfColumns], body: companyData, theme: 'grid',
                  margin: { left: margin, right: margin }, styles: { fontSize: 9, cellPadding: 1.5, lineColor: [200,200,200], lineWidth: 0.1 },
                  headStyles: { fillColor: [230, 230, 230], textColor: [50,50,50], fontSize: 10, fontStyle: 'bold', cellPadding: 2 },
                  columnStyles: pdfColumnStyles,
                  didParseCell: function(cellData) {
                      if (cellData.section === 'body' && cellData.row.raw[0].toString().includes("(CRÉDITO)")) {
                          cellData.cell.styles.textColor = [200, 0, 0]; cellData.cell.styles.fontStyle = 'italic';
                      }
                  },
                  didDrawPage: function (dataHook) {
                    doc.setFontSize(8); doc.setTextColor(150, 150, 150);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), pageWidth - margin, pageHeight - 7, { align: 'right' });
                    doc.text('Generado el ' + new Date().toLocaleString('es-ES', {dateStyle: 'medium', timeStyle: 'short'}), margin, pageHeight - 7);
                  }
              });
              yPos = doc.lastAutoTable.finalY;
              if (index < array.length - 1) {
                  yPos += 3;
                  if (yPos + 5 < pageHeight - margin -15) { doc.setDrawColor(200, 200, 200); doc.line(margin, yPos, pageWidth - margin, yPos); }
                  yPos += 3;
              }
          });
          
          const estimatedSummaryHeight = 40;
          if (yPos + estimatedSummaryHeight > pageHeight - margin - 15) { doc.addPage(); yPos = margin; }
          yPos += 10;
          doc.setFontSize(10); doc.setFont('helvetica', 'bold');
          doc.text("RESUMEN GENERAL DEL PEDIDO:", margin, yPos); yPos += 6;
          doc.setFont('helvetica', 'normal');
          doc.text(`Total de Líneas de Producto: ${totalItemsInOrder}`, margin + 5, yPos); yPos += 5;
          doc.text(`Total de Unidades Pedidas: ${formatQuantity(totalQuantityInOrder)}`, margin + 5, yPos);
          pdfTitle = "Pedido_Agrupado"; // Para el nombre del archivo
        } else {
          // OTROS CASOS: Inventario, Orden, o Pedido CON filtro
          let entriesToProcess = baseEntries;
          if (currentCompanyFilter) {
              entriesToProcess = baseEntries.filter(([, data]) => data && data.company === currentCompanyFilter);
          }

          if (activeTabName === 'inventario') {
              pdfTitle = "INVENTARIO";
              if (currentCompanyFilter) pdfTitle += " - " + currentCompanyFilter.toUpperCase();
              else companyToDisplayInHeader = null; // No mostrar logo de compañía si es inventario general
              
              const inventarioItems = entriesToProcess.filter(([, data]) => data && data.inventarioQty && parseQuantity(data.inventarioQty) > 0);
              dataForPdf = sortEntriesByCurrentMode(inventarioItems).map(([name, data]) => [
                  name, formatQuantity(parseQuantity(data.inventarioQty)), data.unit || 'pz'
              ]);
          } else { // Pedido CON FILTRO u Orden (con o sin filtro)
              pdfTitle = "ORDEN"; // Para Pedido con filtro, el título sigue siendo ORDEN + compañía
              if (currentCompanyFilter) pdfTitle += " - " + currentCompanyFilter.toUpperCase();
              else companyToDisplayInHeader = null;

              const orderItems = entriesToProcess.filter(([, data]) => 
                  data && ((data.pedidoQty && parseQuantity(data.pedidoQty) > 0) || (data.creditQty && parseQuantity(data.creditQty) > 0))
              );
              const sortedOrderItems = sortEntriesByCurrentMode(orderItems);
              sortedOrderItems.forEach(([name, data]) => {
                  if (data.pedidoQty && parseQuantity(data.pedidoQty) > 0) {
                      dataForPdf.push([name, formatQuantity(parseQuantity(data.pedidoQty)), data.presentation || 'caja']);
                  }
                  if (data.creditQty && parseQuantity(data.creditQty) > 0) {
                      dataForPdf.push([name + " (CRÉDITO)", formatQuantity(parseQuantity(data.creditQty)), data.creditPresentation || data.presentation || 'caja']);
                  }
              });
          }

          if (dataForPdf.length === 0) {
              alert("No hay datos para generar el PDF en la vista actual.");
              return;
          }
          console.log(`[PDF GEN PREP] Llamando a createPDFDocument para: "${pdfTitle}", Compañía en cabecera: "${companyToDisplayInHeader || 'N/A'}"`);
          doc = createPDFDocument(dataForPdf, pdfTitle, companyToDisplayInHeader, pdfColumns, pdfColumnStyles);
        }

        // Procesar el PDF (descargar o compartir) - común para ambos flujos (agrupado o simple)
        if (!doc) { // Seguridad por si doc no se creó
            console.error("[PDF GEN ERROR] El objeto 'doc' no fue creado.");
            alert("Error crítico al generar PDF: el documento no pudo ser creado.");
            return;
        }

        const fileNameToUse = pdfTitle.replace(/ /g, "_") + ".pdf";
        if (action === 'share') {
          const pdfBlob = doc.output('blob');
          const file = new File([pdfBlob], fileNameToUse, { type: "application/pdf" });
          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({ files: [file], title: pdfTitle, text: "Documento: " + pdfTitle })
              .catch(err => { console.error("Error al compartir PDF:", err); doc.save(fileNameToUse); });
          } else { doc.save(fileNameToUse); }
        } else { // action === 'download'
          doc.save(fileNameToUse);
        }
        closeShareModal();

      } catch (e) {
        console.error("Error principal en generateAndProcessPDF:", e);
        alert("Error al generar el PDF.");
      }
    }

    function sharePDF() { // Alias
      generateAndProcessPDF('share');
    }

    function downloadPDF() { // Alias
      generateAndProcessPDF('download');
    }

    function drawCompanyHeaderForGroupedPDF(doc, companyName, startY, pageWidth, margin) {
      const logoSize = 15;
      let yPos = startY;
      let companyLogoSrc = APP_DEFAULT_LOGO;
      const company = getCompanies().find(c => c.name === companyName);

      if (company && company.image) {
          companyLogoSrc = company.image;
      }

      try {
          doc.addImage(companyLogoSrc, 'PNG', margin, yPos, logoSize, logoSize, undefined, 'FAST');
      } catch (e) {
          console.error(`[PDF GROUPED LOGO ERR] Compañía: ${companyName}, Src: ${companyLogoSrc}`, e);
      }

      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text(companyName.toUpperCase(), margin + logoSize + 5, yPos + logoSize / 2 + 3);
      
      yPos += logoSize + 5; // Espacio después del encabezado de compañía
      return yPos;
    }

    function createPDFDocument(dataEntries, documentTitle, companyForHeaderName, columns = ['PRODUCTO', 'CANT.', 'UNIDAD'], columnStyles = { 0: { cellWidth: 'auto' }, 1: { cellWidth: 25, halign: 'center' }, 2: { cellWidth: 30, halign: 'center' } }) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Configuración inicial
      doc.setFont('helvetica', 'normal');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight(); // Used for footer
      const margin = 15;
      let yPos = margin; // Start yPos at the top margin

      const logoSize = 20; // Altura y anchura del logo
      let actualLogoSrc = APP_DEFAULT_LOGO; 
      let companyDisplayNameForLog = companyForHeaderName || "N/A (General)";

      console.log(`[PDF LOGO PREP] createPDFDocument received companyForHeaderName: "${companyDisplayNameForLog}"`);

      // Determinar el logo a usar
      if (companyForHeaderName && companyForHeaderName.trim() !== "") { // Asegurarse que no sea una cadena vacía
        const company = getCompanies().find(c => c.name === companyForHeaderName);
        if (company) {
            console.log(`[PDF LOGO PREP] Found company in settings: "${company.name}". It has image URL: "${company.image || '(no image URL)'}"`);
            if (company.image) {
                actualLogoSrc = company.image;
            }
        } else {
            console.log(`[PDF LOGO PREP] Company named "${companyForHeaderName}" was NOT FOUND in settings. Using default logo.`);
        }
      } else {
          console.log(`[PDF LOGO PREP] No specific company provided for header (companyForHeaderName is falsy or empty). Using default logo.`);
      }
      console.log(`[PDF LOGO PREP] Final actualLogoSrc for PDF: "${actualLogoSrc}"`);

      // 1. Dibujar Logo (Alineado a la Izquierda)
      try {
        // La base del logo estará en yPos
        // console.log("Intentando agregar logo al PDF. CompanyForHeaderName:", companyForHeaderName, "ActualLogoSrc:", actualLogoSrc); // Depuración anterior
        doc.addImage(actualLogoSrc, 'PNG', margin, yPos, logoSize, logoSize, undefined, 'FAST');
      } catch (e) {
        console.error("[PDF LOGO ERROR] Error adding logo to PDF:", e, "Logo source que falló:", actualLogoSrc); // Depuración mejorada
        // No hacer nada más si el logo falla, el texto seguirá apareciendo
      }

      // 2. Fecha (Arriba a la Derecha)
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      const currentDate = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
      const dateText = 'Fecha: ' + currentDate;
      const dateTextWidth = doc.getTextWidth(dateText);
      // Posicionar la fecha. Su línea base estará un poco arriba del centro del logo.
      const yFecha = yPos + (logoSize / 2) - (doc.getLineHeight(dateText) / 2) + 2; // Centrado vertical de la fecha con el logo
      doc.text(dateText, pageWidth - margin - dateTextWidth, yFecha);

      // 3. Título del Documento (A la derecha del logo)
      const titleX = margin + logoSize + 5; // 5px de espacio entre logo y título
      // Centrar el título verticalmente con el logo
      // Para centrar texto, se usa la mitad de la altura del texto (aproximada por el tamaño de fuente)
      // La línea base del título estará aproximadamente en el centro del logo.
      const titleFontSize = 18;
      doc.setFontSize(titleFontSize);
      doc.setFont('helvetica', 'bold');
      const yTitulo = yPos + (logoSize / 2) + (titleFontSize / 2.8); // Ajuste para centrar línea base de texto grande
      
      // Ancho máximo para el título, dejando espacio para la fecha y márgenes
      const titleMaxWidth = pageWidth - titleX - margin - dateTextWidth - 10; // 10px de margen con la fecha
      
      doc.text(documentTitle.toUpperCase(), titleX, yTitulo, { maxWidth: titleMaxWidth });
      
      // Actualizar yPos para estar debajo del bloque del logo/título (el elemento más alto es el logo)
      yPos += logoSize + 15; // Aumentado a 15px de espacio después de la cabecera antes de la tabla

      doc.autoTable({
        startY: yPos,
        head: [columns],
        body: dataEntries,
        theme: 'grid',
        margin: { left: margin, right: margin },
        styles: { fontSize: 9, cellPadding: 1.5, lineColor: [200,200,200], lineWidth: 0.1 },
        headStyles: { fillColor: [230, 230, 230], textColor: [50,50,50], fontSize: 10, fontStyle: 'bold', cellPadding: 2 },
        columnStyles: columnStyles,
        didDrawPage: function (data) {
          doc.setFontSize(8);
          doc.setTextColor(150, 150, 150);
          doc.text('Página ' + doc.internal.getNumberOfPages(), pageWidth - margin, pageHeight - 7, { align: 'right' });
          doc.text('Generado el ' + new Date().toLocaleString('es-ES', {dateStyle: 'medium', timeStyle: 'short'}), margin, pageHeight - 7);
        },
        didParseCell: function(data) {
            if (data.section === 'body' && data.row.raw[0].toString().includes("(CRÉDITO)")) { // Convertir a string por si acaso
                data.cell.styles.textColor = [200, 0, 0];
                data.cell.styles.fontStyle = 'italic';
            }
        }
      });

      yPos = doc.lastAutoTable.finalY + 10; // Espacio después de la tabla

      // Antes de dibujar el resumen, verificar si hay espacio o añadir nueva página
      const estimatedSummaryHeight = 40; // Altura aproximada para 3-4 líneas de resumen + buffer
      const footerAreaHeight = 15; // Espacio reservado para el footer

      if (yPos + estimatedSummaryHeight > pageHeight - footerAreaHeight - margin) {
        doc.addPage();
        yPos = margin; // Reiniciar yPos para la nueva página
      }

      // Resumen solo si es un documento de ORDEN (verificando el título)
      if (documentTitle.toUpperCase().startsWith("ORDEN")) {
        let distinctItemCountForPDF = 0;
        let totalQuantitySumForPDF = 0;
        dataEntries.forEach(entry => {
            distinctItemCountForPDF++; // Cada entrada es un ítem distinto en la tabla
            totalQuantitySumForPDF += parseQuantity(entry[1]); // La cantidad está en la segunda columna
        });

        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text("RESUMEN DEL PEDIDO:", margin, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'normal');
        doc.text(`Total de Ítems Distintos: ${distinctItemCountForPDF}`, margin + 5, yPos);
        yPos += 5;
        doc.text(`Total de Unidades: ${formatQuantity(totalQuantitySumForPDF)}`, margin + 5, yPos);
      } else if (documentTitle.toUpperCase().startsWith("INVENTARIO")) { // NUEVO: Resumen para Inventario
        let distinctItemCountForPDF = 0;
        let totalQuantitySumForPDF = 0;
        dataEntries.forEach(entry => {
            distinctItemCountForPDF++; 
            totalQuantitySumForPDF += parseQuantity(entry[1]);
        });

        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text("RESUMEN DEL INVENTARIO:", margin, yPos);
        yPos += 6;
        doc.setFont('helvetica', 'normal');
        doc.text(`Total de Ítems Distintos: ${distinctItemCountForPDF}`, margin + 5, yPos);
        yPos += 5;
        doc.text(`Total de Unidades en Inventario: ${formatQuantity(totalQuantitySumForPDF)}`, margin + 5, yPos);
      }
      
      return doc;
    }

    // Ocultar splash y cargar la aplicación
    const splash = document.getElementById('splash');
    window.onload = function() {
      try {
        // Ocultar splash después de 2 segundos
        setTimeout(function() {
          splash.style.display = 'none';
          // Inicializar la aplicación
          initApp();
          
          // Limpiar cualquier texto de código que aparezca en la interfaz
          cleanupCodeText();
          
          // Configurar controlador para guardar estado al cerrar/recargar
          window.addEventListener('beforeunload', saveFiltersAndState);
        }, 2000);
      } catch (error) {
        // En caso de error, garantizar que la aplicación al menos se muestre
        console.error("Error al iniciar la aplicación:", error);
        splash.style.display = 'none';
        alert("Hubo un problema al cargar la aplicación. Se realizará una restauración.");
        
        // Intentar recuperar la aplicación con valores por defecto
        try {
          initApp();
        } catch (e) {
          document.body.innerHTML = '<div style="text-align:center; padding:50px; font-family:sans-serif;"><h2>Error al cargar la aplicación</h2><p>Por favor recarga la página o borra los datos de navegación.</p></div>';
        }
      }
    };
    
    // Guardar estado al desplazarse
    window.addEventListener('scroll', function() {
      // Usar debounce para evitar llamadas excesivas
      clearTimeout(window.scrollDebounce);
      window.scrollDebounce = setTimeout(function() {
        lastScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        localStorage.setItem('scrollPosition', lastScrollPosition);
      }, 300);
    });
    
    // Manejador de errores global
    window.addEventListener('error', function(e) {
      console.error("Error capturado:", e.error);
      // Prevenir pantalla en blanco
      if (splash.style.display === 'flex') {
        splash.style.display = 'none';
      }
    });
    
    // Función para limpiar texto de código visible en la interfaz
    function cleanupCodeText() {
      // Buscar nodos de texto en el cuerpo del documento
      const walker = document.createTreeWalker(
        document.body, 
        NodeFilter.SHOW_TEXT,
        null,
        false
      );
      
      const nodesToRemove = [];
      let node;
      
      // Recolectar nodos que contienen código
      while(node = walker.nextNode()) {
        // Buscar fragmentos de código específicos
        if (node.nodeValue && (
            node.nodeValue.includes('logoFileInput.value') || 
            node.nodeValue.includes('companies.push') ||
            node.nodeValue.includes('localStorage.setItem(COMPANIES_KEY') ||
            node.nodeValue.includes('renderSettingsLists')
           )) {
          nodesToRemove.push(node);
        }
      }
      
      // Eliminar los nodos encontrados
      nodesToRemove.forEach(node => {
        if (node.parentNode) {
          node.parentNode.removeChild(node);
        }
      });
      
      // Programar ejecuciones periódicas para capturar texto que aparezca después
      setTimeout(cleanupCodeText, 2000);
    }

    /* ===== FUNCIONES MODAL ZOOM IMAGEN ===== */
    function showImageZoomModal(imageUrl, productName) {
      if (!imageUrl) return;
      document.getElementById('zoomedImage').src = imageUrl;
      document.getElementById('zoomedImage').alt = productName;
      document.getElementById('imageZoomModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
      
      // Implementar zoom con gestos táctiles y mouse
      const zoomedImage = document.getElementById('zoomedImage');
      
      // Variables para el zoom
      let scale = 1;
      let panning = false;
      let pointX = 0;
      let pointY = 0;
      let start = { x: 0, y: 0 };
      
      // Función para actualizar la transformación
      function updateTransform() {
        zoomedImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
      }
      
      // Eventos para PC (mouse)
      zoomedImage.addEventListener('mousedown', (e) => {
        e.preventDefault();
        start = { x: e.clientX - pointX, y: e.clientY - pointY };
        panning = true;
      });
      
      zoomedImage.addEventListener('mouseup', (e) => {
        panning = false;
      });
      
      zoomedImage.addEventListener('mousemove', (e) => {
        e.preventDefault();
        if (!panning) return;
        pointX = (e.clientX - start.x);
        pointY = (e.clientY - start.y);
        updateTransform();
      });
      
      zoomedImage.addEventListener('wheel', (e) => {
        e.preventDefault();
        const xs = (e.clientX - pointX) / scale;
        const ys = (e.clientY - pointY) / scale;
        const delta = -e.deltaY * 0.01;
        
        // Limitar el zoom entre 0.5 y 4
        scale = Math.min(Math.max(0.5, scale + delta), 4);
        
        pointX = e.clientX - xs * scale;
        pointY = e.clientY - ys * scale;
        
        updateTransform();
      });
      
      // Eventos para móviles (táctil)
      let evCache = [];
      let prevDiff = -1;
      
      zoomedImage.addEventListener('touchstart', (e) => {
        for (let i = 0; i < e.changedTouches.length; i++) {
          evCache.push(e.changedTouches[i]);
        }
        if (evCache.length === 1) {
          start = { x: evCache[0].clientX - pointX, y: evCache[0].clientY - pointY };
          panning = true;
        }
      });
      
      zoomedImage.addEventListener('touchmove', (e) => {
        e.preventDefault();
        
        for (let i = 0; i < e.changedTouches.length; i++) {
          const idx = evCache.findIndex(item => item.identifier === e.changedTouches[i].identifier);
          if (idx !== -1) evCache[idx] = e.changedTouches[i];
        }
        
        // Manejar desplazamiento con un dedo
        if (evCache.length === 1 && panning) {
          pointX = (evCache[0].clientX - start.x);
          pointY = (evCache[0].clientY - start.y);
          updateTransform();
        } 
        // Manejar zoom con dos dedos (pinch)
        else if (evCache.length === 2) {
          const curDiff = Math.hypot(
            evCache[0].clientX - evCache[1].clientX,
            evCache[0].clientY - evCache[1].clientY
          );
          
          if (prevDiff > 0) {
            // Aumentar o disminuir escala según el gesto de pinch
            if (curDiff > prevDiff) {
              // Los dedos se separan, aumentar zoom
              scale = Math.min(scale * 1.02, 4);
            }
            if (curDiff < prevDiff) {
              // Los dedos se juntan, disminuir zoom
              scale = Math.max(scale * 0.98, 0.5);
            }
            
            updateTransform();
          }
          
          prevDiff = curDiff;
        }
      });
      
      function touchEndHandler(e) {
        for (let i = 0; i < e.changedTouches.length; i++) {
          const idx = evCache.findIndex(item => item.identifier === e.changedTouches[i].identifier);
          if (idx !== -1) evCache.splice(idx, 1);
        }
        
        if (evCache.length < 2) prevDiff = -1;
        if (evCache.length === 0) panning = false;
      }
      
      zoomedImage.addEventListener('touchend', touchEndHandler);
      zoomedImage.addEventListener('touchcancel', touchEndHandler);
      
      // Doble clic/toque para resetear zoom
      let lastTap = 0;
      
      zoomedImage.addEventListener('click', (e) => {
        const curTime = new Date().getTime();
        const tapLength = curTime - lastTap;
        
        if (tapLength < 300 && tapLength > 0) {
          // Doble clic detectado, resetear zoom
          scale = 1;
          pointX = 0;
          pointY = 0;
          updateTransform();
          e.preventDefault();
        }
        
        lastTap = curTime;
      });
      
      // Asegurarse de que el cursor refleje el estado de zoom
      zoomedImage.style.cursor = 'zoom-in';
    }

    function closeImageZoomModal() {
      document.getElementById('imageZoomModal').classList.remove('show');
      document.getElementById('zoomedImage').src = ""; // Limpiar src para evitar que se muestre imagen anterior brevemente
      document.getElementById('zoomedImage').style.transform = ''; // Resetear transformación
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    // Función para ordenar entradas según el modo seleccionado
    function sortEntriesByCurrentMode(entries) {
      const sortModeToUse = sortMode; // Usar la variable global sortMode

      if (sortModeToUse === 'byCustomOrder') {
        return entries.sort((a, b) => {
          const orderA = a[1]?.customSortOrder ?? Number.MAX_SAFE_INTEGER; // Los que no tengan orden, al final
          const orderB = b[1]?.customSortOrder ?? Number.MAX_SAFE_INTEGER;
          if (orderA === orderB) { // Si el orden personalizado es igual, usar nombre como secundario
            return a[0].localeCompare(b[0]);
          }
          return orderA - orderB;
        });
      }
      if (sortMode === 'byNumberAsc') {
        return entries.sort((a, b) => {
          // Convertir números de producto a enteros para comparación numérica
          const numA = parseInt(a[1]?.numero || "0", 10);
          const numB = parseInt(b[1]?.numero || "0", 10);
          
          // Si los números son iguales, ordenar por nombre
          if (numA === numB) {
            return a[0].localeCompare(b[0]);
          }
          
          return numA - numB; // Orden ascendente
        });
      } 
      else if (sortMode === 'byNumberDesc') {
        return entries.sort((a, b) => {
          const numA = parseInt(a[1]?.numero || "0", 10);
          const numB = parseInt(b[1]?.numero || "0", 10);
          
          if (numA === numB) {
            return a[0].localeCompare(b[0]);
          }
          
          return numB - numA; // Orden descendente
        });
      } 
      else if (sortMode === 'byNameDesc') {
        return entries.sort((a, b) => b[0].localeCompare(a[0]));
      } 
      else {
        // Por defecto: byNameAsc
        return entries.sort((a, b) => a[0].localeCompare(b[0]));
      }
    }

    // --- INICIO FUNCIONES PARA BOTONES +/- ---
    function parseQuantity(value) {
      if (value === "1/2") return 0.5;
      if (value === null || value === undefined || value === "") return 0;
      const num = parseFloat(String(value)); // Convertir a string primero por si es 0 (número)
      return isNaN(num) ? 0 : num;
    }

    function formatQuantity(num) {
      if (num === 0) return 0; // Devuelve el número 0 para "sin cantidad"
      if (num === 0.5) return "1/2";
      return String(num);
    }

    function incrementQuantity(event, productName) {
      const items = getAllItems();
      if (!items[productName]) return;

      // Resetear el botón de decremento si estaba en modo confirmación
      const decreaseButton = event.target.parentElement.querySelector('.decrease-qty-btn');
      if (decreaseButton && decreaseButton.dataset.confirmDelete === 'true') {
        decreaseButton.innerHTML = '-';
        delete decreaseButton.dataset.confirmDelete;
        delete decreaseButton.dataset.isPressing; // Asegurar limpieza
        clearTimeout(window.longPressTimer);
      }

      let currentQtyNum = parseQuantity(items[productName].pedidoQty);
      currentQtyNum += 1;
      items[productName].pedidoQty = formatQuantity(currentQtyNum);
      
      setAllItems(items);
      updateProductQuantityUI(productName, items[productName].pedidoQty, 'pedido');
      updateItemCount(); // Actualizar contador general
    }

    function decrementQuantity(productName) { // Ya no necesita el botón como argumento si solo hace la lógica
      const items = getAllItems();
      if (!items[productName]) return;

      let currentQtyNum = parseQuantity(items[productName].pedidoQty);

      if (currentQtyNum <= 0) { // No debería llegar aquí si el botón desaparece, pero por seguridad
        currentQtyNum = 0;
      } else if (currentQtyNum === 0.5) {
        currentQtyNum = 0;
      } else {
        currentQtyNum -= 1;
      }
      
      if (currentQtyNum < 0) currentQtyNum = 0;

      items[productName].pedidoQty = formatQuantity(currentQtyNum);
      
      setAllItems(items);
      updateProductQuantityUI(productName, items[productName].pedidoQty, 'pedido');
      updateItemCount(); // Actualizar contador general
    }

    function incrementInventoryQuantity(event, productName) {
      const items = getAllItems();
      if (!items[productName]) return;

      // Resetear el botón de decremento si estaba en modo confirmación
      const decreaseButton = event.target.parentElement.querySelector('.decrease-qty-btn');
      if (decreaseButton && decreaseButton.dataset.confirmDelete === 'true') {
        decreaseButton.innerHTML = '-';
        delete decreaseButton.dataset.confirmDelete;
        delete decreaseButton.dataset.isPressing; // Asegurar limpieza
        clearTimeout(window.longPressTimer);
      }

      let currentQtyNum = parseQuantity(items[productName].inventarioQty);
      currentQtyNum += 1;
      items[productName].inventarioQty = formatQuantity(currentQtyNum);

      setAllItems(items);
      updateProductQuantityUI(productName, items[productName].inventarioQty, 'inventario');
      updateItemCount(); // Actualizar contador general
    }

    function decrementInventoryQuantity(productName) { // Ya no necesita el botón como argumento
      const items = getAllItems();
      if (!items[productName]) return;

      let currentQtyNum = parseQuantity(items[productName].inventarioQty);

      if (currentQtyNum <= 0) {
        currentQtyNum = 0;
      } else if (currentQtyNum === 0.5) {
        currentQtyNum = 0;
      } else {
        currentQtyNum -= 1;
      }

      if (currentQtyNum < 0) currentQtyNum = 0;
      
      items[productName].inventarioQty = formatQuantity(currentQtyNum);

      setAllItems(items);
      updateProductQuantityUI(productName, items[productName].inventarioQty, 'inventario');
      updateItemCount(); // Actualizar contador general
    }
    // --- FIN FUNCIONES PARA BOTONES +/- ---

    // --- INICIO NUEVAS FUNCIONES PARA PULSACIÓN LARGA Y BOTONES DE CANTIDAD ---
    function createQuantityButton(type, productName, tabType) {
      const button = document.createElement('button');
      button.type = "button";
      button.className = 'quantity-btn';
      button.setAttribute('data-product', productName);

      if (type === 'increase') {
        button.innerHTML = '+';
        button.classList.add('increase-qty-btn'); // Clase para identificarlo
        if (tabType === 'pedido' || tabType === 'orden') {
          button.onclick = function(event) { incrementQuantity(event, productName); return false; };
        } else { // inventario
          button.onclick = function(event) { incrementInventoryQuantity(event, productName); return false; };
        }
      } else { // decrease
        button.innerHTML = '-';
        button.classList.add('decrease-qty-btn'); // Clase para identificarlo
        button.onmousedown = function(event) { handleDecrementButtonDown(event, productName, tabType); };
        button.onmouseup = function(event) { handleDecrementButtonUpOrLeave(event, productName, tabType); };
        button.onmouseleave = function(event) { handleDecrementButtonUpOrLeave(event, productName, tabType); };
        button.ontouchstart = function(event) { handleDecrementButtonDown(event, productName, tabType); };
        button.ontouchend = function(event) { handleDecrementButtonUpOrLeave(event, productName, tabType); };
        button.onclick = function(event) { handleDecrementButtonClick(event, productName, tabType); return false; };
      }
      return button;
    }

    function handleDecrementButtonDown(event, productName, tabType) {
      const button = event.currentTarget;
      clearTimeout(window.longPressTimer);
      button.dataset.isPressing = "true";

      window.longPressTimer = setTimeout(() => {
        if (button.dataset.isPressing === "true") {
          button.innerHTML = '<i class="material-icons" style="font-size: 1em; vertical-align: middle; line-height: 1;">delete</i>';
          button.dataset.confirmDelete = "true";
          if (navigator.vibrate) navigator.vibrate(50);
        }
      }, 300); // Cambiado de 1000ms a 300ms (0.3 segundo)
      // event.preventDefault(); // Podría ser necesario para touchstart, probar con cuidado
    }

    function handleDecrementButtonUpOrLeave(event, productName, tabType) {
      const button = event.currentTarget;
      clearTimeout(window.longPressTimer);
      delete button.dataset.isPressing;
      // No cambiar la cantidad ni el ícono aquí, el onclick se encargará.
    }

    function handleDecrementButtonClick(event, productName, tabType) {
      const button = event.currentTarget;
      clearTimeout(window.longPressTimer); // Asegurar que el timer se limpie
      
      if (button.dataset.confirmDelete === "true") {
        // Modo basura activo: poner cantidad a 0
        setProductQuantityToZero(productName, tabType);
        button.innerHTML = "-"; // Restaurar ícono
        delete button.dataset.confirmDelete; // Limpiar estado
      } else {
        // Clic corto normal: decrementar cantidad
        if (tabType === 'pedido' || tabType === 'orden') {
          decrementQuantity(productName);
        } else { // inventario
          decrementInventoryQuantity(productName);
        }
      }
      delete button.dataset.isPressing; // Limpiar estado de presión por si acaso
    }

    function setProductQuantityToZero(productName, tabType) {
      const items = getAllItems();
      if (!items[productName]) return;

      let qtyChanged = false;
      if (tabType === 'pedido' || tabType === 'orden') {
        if (items[productName].pedidoQty !== 0 && items[productName].pedidoQty !== "0") {
           items[productName].pedidoQty = 0;
           qtyChanged = true;
        }
      } else { // inventario
         if (items[productName].inventarioQty !== 0 && items[productName].inventarioQty !== "0") {
            items[productName].inventarioQty = 0;
            qtyChanged = true;
         }
      }

      if (qtyChanged) {
        setAllItems(items);
        // La función updateProductQuantityUI se encargará de actualizar la UI del ítem,
        // incluyendo ocultar el botón '-' si la cantidad es 0.
        // Si estamos en 'orden', un renderOrdenTab podría ser más simple para asegurar que el ítem desaparezca.
        if (tabType === 'orden') {
            renderOrdenTab();
        } else {
            updateProductQuantityUI(productName, 0, tabType);
        }
        updateItemCount(); // Actualizar contador general
      }
    }
    // --- FIN NUEVAS FUNCIONES ---

    // Helper function to update UI without full reload
    function updateProductQuantityUI(productName, newQty, tab) {
      // Considerar como "sin cantidad" si el valor es 0, '0' o falsy
      const hasQuantity = newQty && newQty !== "0" && newQty !== 0;
      const itemCountElement = document.getElementById('itemCountDisplay'); // Obtener el elemento del contador

      // Para la pestaña de pedido, también actualizar la pestaña de orden
      if (tab === 'pedido') {
        // Actualizar en la pestaña de pedido
        let containerSelector = '#pedidoList';
        let container = document.querySelector(containerSelector);
        updateItemUI(container, productName, newQty, hasQuantity, tab);
        
        // También actualizar en la pestaña orden, si tiene cantidad (o remover si ya no tiene)
        containerSelector = '#ordenList';
        container = document.querySelector(containerSelector);
        
        if (hasQuantity) {
          // Si tiene cantidad, actualizar elemento existente o renderizar toda la pestaña si no existe
          const item = findItemInContainer(container, productName);
          if (item) {
            updateItemUI(container, productName, newQty, hasQuantity, 'pedido');
          } else {
            // Si no encontramos el item pero debería tener cantidad, mejor renderizar toda la pestaña
            renderOrdenTab();
          }
        } else {
          // Si ya no tiene cantidad, debe eliminarse de la pestaña orden
          const item = findItemInContainer(container, productName);
          if (item) {
            container.removeChild(item);
            
            // Si era un ítem con crédito, también buscar y remover el ítem de crédito
            const items = getAllItems();
            if (items[productName] && items[productName].creditQty && 
                items[productName].creditQty !== 0 && items[productName].creditQty !== '0') {
              // Hay un ítem de crédito, buscar por su etiqueta especial
              const creditItems = Array.from(container.querySelectorAll('.item'));
              for (let i = 0; i < creditItems.length; i++) {
                const creditLabel = creditItems[i].querySelector('.quantity-row span');
                if (creditLabel && creditLabel.textContent.includes('CRÉDITO') && 
                    creditItems[i].querySelector('.product-name').textContent === productName) {
                  container.removeChild(creditItems[i]);
                  break;
                }
              }
            }
            
            // Si ya no hay elementos, mostrar mensaje
            if (container.childElementCount === 0) {
              const emptyMessage = document.createElement('div');
              emptyMessage.style.textAlign = 'center';
              emptyMessage.style.padding = '50px 20px';
              emptyMessage.style.color = '#666';
              emptyMessage.style.width = '100%';
              emptyMessage.innerHTML = '<span class="material-icons" style="font-size:48px; margin-bottom:10px;">shopping_cart</span><br>No hay productos en tu orden.<br>Añade cantidades en la pestaña "Pedido".';
              container.appendChild(emptyMessage);
            }
          }
        }
      } else {
        // Para la pestaña de inventario, comportamiento normal
        const containerSelector = '#inventarioList';
        const container = document.querySelector(containerSelector);
        updateItemUI(container, productName, newQty, hasQuantity, tab);
      }

      // Forzar actualización del contador si estamos en la pestaña Pedido y se modificó una cantidad allí
      if (tab === 'pedido' && itemCountElement && document.getElementById('pedidoTab').style.display !== 'none') {
        const items = getAllItems();
        let entries = Object.entries(items);

        // Aplicar filtros actuales (búsqueda y compañía) para el conteo
        if (searchTerm) {
          entries = entries.filter(([key]) => key.toLowerCase().includes(searchTerm.toLowerCase()));
        }
        if (currentCompanyFilter) {
          entries = entries.filter(([, data]) => data && data.company === currentCompanyFilter);
        }

        const pedidoConCantidad = entries.filter(([, data]) => data && data.pedidoQty && parseQuantity(data.pedidoQty) > 0);
        
        if (pedidoConCantidad.length === 0) {
          itemCountElement.textContent = "Nada en pedido";
        } else if (pedidoConCantidad.length === 1) {
          itemCountElement.textContent = `1 producto en pedido`;
        } else {
          itemCountElement.textContent = `${pedidoConCantidad.length} productos en pedido`;
        }
      }
    }
    
    // Función auxiliar para actualizar un elemento específico en un contenedor
    function findItemInContainer(container, productName) {
      if (!container) return null;
      
      // Buscar el elemento correspondiente al producto
      const items = container.querySelectorAll('.item');
      for (let i = 0; i < items.length; i++) {
        const itemNameElement = items[i].querySelector('.product-name');
        if (itemNameElement && itemNameElement.textContent === productName) {
          // Skip credit items
          const isCreditItem = items[i].querySelector('.quantity-row span')?.textContent.includes('CRÉDITO');
          if (!isCreditItem) {
            return items[i];
          }
        }
      }
      return null;
    }
    
    // Función auxiliar para actualizar la UI de un item
    function updateItemUI(container, productName, newQty, hasQuantity, tab) {
      if (!container) return;
      
      const productItem = findItemInContainer(container, productName);
      if (!productItem) return;
      
      // Update the input value - si la cantidad es 0, mostrar un campo vacío
      const input = productItem.querySelector('input[type="text"]'); // Más específico
      if (input) input.value = hasQuantity ? formatQuantity(parseQuantity(newQty)) : ''; // Usar formatQuantity
      
      // Update the highlight class - solo destacar si realmente hay una cantidad
      if (hasQuantity) {
        productItem.classList.add('highlight');
      } else {
        productItem.classList.remove('highlight');
      }
      
      // Handle the decrement button visibility
      const inputContainer = productItem.querySelector('.quantity-input-container');
      if (!inputContainer) return;
      
      let existingDecrementBtn = inputContainer.querySelector('.decrease-qty-btn');
      
      if (!hasQuantity && existingDecrementBtn) {
        // Si la cantidad es 0 y el botón existe, removerlo.
        inputContainer.removeChild(existingDecrementBtn);
      } else if (hasQuantity && !existingDecrementBtn) {
        // Si hay cantidad y el botón no existe, crearlo y añadirlo.
        const newDecrementBtn = createQuantityButton('decrease', productName, tab);
        // El input es el segundo hijo usualmente (después de '-' si existe, o primero si no).
        // El botón '+' es el último.
        const plusButton = inputContainer.querySelector('.increase-qty-btn');
        if (plusButton) {
            inputContainer.insertBefore(newDecrementBtn, plusButton.previousSibling); // Antes del input
        } else { // Si no hay botón plus (no debería pasar), añadir al inicio.
            inputContainer.insertBefore(newDecrementBtn, inputContainer.firstChild);
        }
      }
      // Si hasQuantity y existingDecrementBtn existen, no hacer nada (ya está bien).
    }

    // --- INICIO FUNCIONES MODAL ENVIAR MENSAJE ---
    function openSendMessageModal() {
      if (!currentCompanyFilter) {
        alert("Por favor, filtra por una compañía para enviar la orden.");
        return;
      }

      const companies = getCompanies();
      const company = companies.find(c => c.name === currentCompanyFilter);

      if (!company || !company.phone) {
        alert("Esta compañía no tiene un número de teléfono configurado en Ajustes o no se encontró la compañía.");
        return;
      }

      const items = getAllItems();
      let orderText = ""; // Esta variable ahora es principalmente para la lógica de productCount
      let productCount = 0;

      // Recopilar productos de la pestaña Orden (los que están visibles y tienen cantidad)
      const ordenListContainer = document.getElementById('ordenList');
      const displayedItems = ordenListContainer.querySelectorAll('.item');

      displayedItems.forEach(itemElement => {
        const productNameElement = itemElement.querySelector('.product-name');
        const quantityInputElement = itemElement.querySelector('.quantity-row input');
        // const presentationLabelElement = itemElement.querySelector('.quantity-row > span:not([class])'); 

        if (productNameElement && quantityInputElement) {
          const productName = productNameElement.textContent;
          let quantity = quantityInputElement.value;
                    
          if (quantity && parseFloat(quantity) > 0) {
            // Ya no necesitamos construir orderText aquí, solo contar productos.
            productCount++;
          }
        }
      });

      if (productCount === 0) {
        alert("No hay productos con cantidad en la orden actual para esta compañía.");
        return;
      }

      // El mensaje de texto será solo el mensaje predeterminado de la compañía o un placeholder
      let textMessage = company.defaultMessage ? company.defaultMessage : "Hola, te adjunto la orden de productos:"; // Ajustado el placeholder
      
      // Generar el PDF para adjuntar
      try {
        // Preparamos los datos específicamente para la ORDEN de ESTA compañía
        let orderDataForPdf = [];
        const allItemsObject = getAllItems();
        let orderEntries = Object.entries(allItemsObject);

        // Filtrar por la compañía actual del mensaje (importante)
        orderEntries = orderEntries.filter(([, data]) => data && data.company === currentCompanyFilter);
        
        // Filtrar por productos con cantidad de pedido o crédito
        orderEntries = orderEntries.filter(([, data]) => 
          data && (
            (data.pedidoQty && parseQuantity(data.pedidoQty) > 0) || 
            (data.creditQty && parseQuantity(data.creditQty) > 0)
          )
        );
        orderEntries = sortEntriesByCurrentMode(orderEntries); // Ordenar

        orderEntries.forEach(([name, data]) => {
          if (data.pedidoQty && parseQuantity(data.pedidoQty) > 0) {
            orderDataForPdf.push([
              name,
              formatQuantity(parseQuantity(data.pedidoQty)),
              data.presentation || 'caja'
            ]);
          }
          if (data.creditQty && parseQuantity(data.creditQty) > 0) {
            orderDataForPdf.push([
              name + " (CRÉDITO)",
              formatQuantity(parseQuantity(data.creditQty)),
              data.creditPresentation || data.presentation || 'caja'
            ]);
          }
        });

        if (orderDataForPdf.length === 0) {
          // No hay items en la orden para esta compañía, no adjuntar PDF
          currentOrderPDFFile = null;
        } else {
          const pdfTitle = "ORDEN - " + currentCompanyFilter.toUpperCase();
          const pdfColumns = ['PRODUCTO', 'CANT.', 'UNIDAD'];
          const pageWidth = new jsPDF().internal.pageSize.getWidth();
          const margin = 15;
          const pdfColumnStyles = {
            0: { cellWidth: pageWidth - margin * 2 - 30 - 25 }, 
            1: { cellWidth: 25, halign: 'center' }, 
            2: { cellWidth: 30, halign: 'center' }  
          };
          const doc = createPDFDocument(orderDataForPdf, pdfTitle, currentCompanyFilter, pdfColumns, pdfColumnStyles);
          const pdfBlob = doc.output('blob');
          const companyNameForFile = currentCompanyFilter.replace(/[^a-z0-9]/gi, '_').toLowerCase();
          const dateSuffix = new Date().toISOString().split('T')[0];
          currentOrderPDFFile = new File([pdfBlob], `orden_${companyNameForFile}_${dateSuffix}.pdf`, { type: "application/pdf" });
        }
      } catch (e) {
        console.error("Error al generar PDF para compartir:", e);
        currentOrderPDFFile = null; // Asegurarse de que esté nulo si falla
        alert("Hubo un error al generar el PDF para adjuntar. Solo se enviará el mensaje de texto.");
      }

      document.getElementById('sendMessageText').value = textMessage;
      document.getElementById('sendOrderToInfo').textContent = `Se enviará a: ${company.name} (${company.phone})`;
      document.getElementById('sendMessageModal').classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function closeSendMessageModal() {
      document.getElementById('sendMessageModal').classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
    }

    function sendViaSMS() {
      const phoneNumber = currentCompanyFilter ? getCompanies().find(c => c.name === currentCompanyFilter)?.phone : null;
      const message = document.getElementById('sendMessageText').value;
      if (!phoneNumber) {
        alert("No se pudo obtener el número de teléfono de la compañía.");
        return;
      }

      if (navigator.share && currentOrderPDFFile) {
        navigator.share({
          title: 'Orden de Compra',
          text: message,
          files: [currentOrderPDFFile]
        })
        .then(() => console.log('Contenido compartido exitosamente (SMS)'))
        .catch((error) => {
          console.error('Error al compartir (SMS):', error);
          alert('No se pudo compartir automáticamente. Intenta descargar el PDF y enviarlo manualmente.\nError: ' + error.message);
          // Fallback si navigator.share falla o es cancelado por el usuario con archivo adjunto
          // Podríamos intentar compartir solo texto si el error indica que los archivos no son soportados por el target
          // o simplemente mostrar el mensaje de error como ya se hace.
        });
      } else if (navigator.share) { // Puede compartir texto pero no se generó el PDF
         navigator.share({ title: 'Orden de Compra', text: message })
        .then(() => console.log('Mensaje de texto compartido exitosamente (SMS)'))
        .catch((error) => console.error('Error al compartir texto (SMS):', error));
      } else {
        alert("La función de compartir no está disponible en este navegador. Copia el mensaje e intenta enviar el PDF manualmente si lo necesitas.");
        // Fallback para navegadores sin navigator.share: (esto ya no es necesario si nos basamos en navigator.share)
        // window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(message)}`;
      }
      closeSendMessageModal();
    }

    function sendViaWhatsApp() {
      const phoneNumber = currentCompanyFilter ? getCompanies().find(c => c.name === currentCompanyFilter)?.phone : null;
      const message = document.getElementById('sendMessageText').value;
      if (!phoneNumber) {
        alert("No se pudo obtener el número de teléfono de la compañía.");
        return;
      }
      // Limpiar el número de teléfono para WhatsApp (quitar +, espacios, guiones)
      const cleanPhoneNumber = phoneNumber.replace(/\D/g, '');

      if (navigator.share && currentOrderPDFFile) {
        navigator.share({
          title: 'Orden de Compra',
          text: message,
          files: [currentOrderPDFFile]
        })
        .then(() => console.log('Contenido compartido exitosamente (WhatsApp)'))
        .catch((error) => {
          console.error('Error al compartir (WhatsApp):', error);
          alert('No se pudo compartir automáticamente. Intenta descargar el PDF y enviarlo manualmente.\nError: ' + error.message);
           // Fallback si navigator.share falla o es cancelado por el usuario con archivo adjunto
        });
      } else if (navigator.share) { // Puede compartir texto pero no se generó el PDF
         navigator.share({ title: 'Orden de Compra', text: message })
        .then(() => console.log('Mensaje de texto compartido exitosamente (WhatsApp)'))
        .catch((error) => {
           console.error('Error al compartir texto (WhatsApp):', error);
           // Si falla el share de solo texto, intentar el método tradicional de WhatsApp
           window.open(`https://wa.me/${cleanPhoneNumber}?text=${encodeURIComponent(message)}`, '_blank');
        });
      } else {
        alert("La función de compartir no está disponible en este navegador. Intentando abrir WhatsApp directamente (solo mensaje).");
        window.open(`https://wa.me/${cleanPhoneNumber}?text=${encodeURIComponent(message)}`, '_blank');
      }
      closeSendMessageModal();
    }
    // --- FIN FUNCIONES MODAL ENVIAR MENSAJE ---

    /* ===== FUNCIONES MODAL CRÉDITOS ===== */
    function openCreditModal(productName) {
      // currentEdit = productName; // Ya no usamos currentEdit aquí
      const creditModalElement = document.getElementById('creditModal');
      if (!creditModalElement) {
        console.error("Modal de crédito no encontrado"); 
        return;
      }
      creditModalElement.dataset.editingProduct = productName; // Guardar el nombre del producto en el modal

      const items = getAllItems();
      const product = items[productName];

      if (!product) {
        alert("Producto no encontrado para agregar crédito.");
        closeCreditModal(); // Cierra el modal si el producto no existe
        return;
      }

      const creditPresentationSelect = document.getElementById('creditPresentation');
      fillSelectOptions('creditPresentation', getPresentations(), product.creditPresentation || product.presentation);

      // Usar formatQuantity aquí podría ser útil si quieres mostrar "1/2" en vez de 0.5 si ese es el valor guardado.
      // Pero para la edición, usualmente se muestra el valor tal cual o vacío para 0.
      document.getElementById('creditQty').value = (product.creditQty && product.creditQty !== 0 && product.creditQty !== '0') ? String(product.creditQty) : '';
      
      creditModalElement.classList.add('show');
      document.body.classList.add('body-modal-open'); // Bloquear scroll
    }

    function saveCreditInfo() {
      const creditModalElement = document.getElementById('creditModal');
      if (!creditModalElement) {
        console.error("Modal de crédito no encontrado al guardar");
        return;
      }

      const productName = creditModalElement.dataset.editingProduct;
      if (!productName) {
        alert("Error: No se pudo identificar el producto para el crédito.");
        closeCreditModal();
        return;
      }

      const items = getAllItems();
      if (!items[productName]) {
        alert("Error: Producto no encontrado al guardar el crédito.");
        closeCreditModal();
        return;
      }

      const creditQtyValue = document.getElementById('creditQty').value.trim();
      const creditPresentationValue = document.getElementById('creditPresentation').value;
      
      // Validar y formatear la cantidad usando las funciones existentes
      const parsedCreditQty = parseQuantity(creditQtyValue);

      items[productName].creditQty = formatQuantity(parsedCreditQty);
      items[productName].creditPresentation = creditPresentationValue;
      
      // Si la cantidad final es 0, podríamos considerar limpiar creditPresentation
      if (items[productName].creditQty === 0 || items[productName].creditQty === '0') {
        // items[productName].creditPresentation = ''; // Opcional: resetear si no hay cantidad
      }

      setAllItems(items);
      closeCreditModal();
      renderTabs(); 
    }

    function closeCreditModal() {
      const creditModalElement = document.getElementById('creditModal');
      if (!creditModalElement) {
        console.error("Modal de crédito no encontrado al cerrar");
        return;
      }
      creditModalElement.classList.remove('show');
      document.body.classList.remove('body-modal-open'); // Desbloquear scroll
      delete creditModalElement.dataset.editingProduct; // Limpiar el atributo data
    }
    // --- FIN FUNCIONES MODAL CRÉDITOS ---

    // --- INICIO FUNCIÓN REMOVER CRÉDITO ---
    function removeCredit(productName) {
      const items = getAllItems();
      if (items[productName]) {
        items[productName].creditQty = 0; // O null, para ser consistentes con "sin cantidad"
        items[productName].creditPresentation = ''; // O null
        setAllItems(items);
        renderTabs(); // Para refrescar la vista y que el ítem de crédito desaparezca
      } else {
        console.warn("Producto no encontrado al intentar remover crédito:", productName);
      }
    }
    // --- FIN FUNCIÓN REMOVER CRÉDITO ---

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('searchInput').focus();
      document.querySelector('.clear-search-btn').style.display = 'none';
      updateSearch('');
    }

    // *** INICIO NUEVAS FUNCIONES PARA MIGRACIÓN Y ORDEN PERSONALIZADO ***
    function migrateOrderSystem() {
      if (localStorage.getItem(ORDER_SYSTEM_MIGRATED_KEY)) {
        console.log("El sistema de orden personalizado ya ha sido migrado.");
        return;
      }

      console.log("Iniciando migración del sistema de orden personalizado...");
      const items = getAllItems();
      let entries = Object.entries(items);

      // Determinar el orden actual basado en el sortMode guardado (o un default)
      // Usamos el sortMode que se carga en restoreFiltersAndState() o el default 'byNameAsc'
      // La función sortEntriesByCurrentMode usará la variable global 'sortMode'
      const currentEffectiveSortMode = localStorage.getItem('sortMode') || 'byNameAsc';
      
      // Clonamos las entries para no modificar las originales si sortEntriesByCurrentMode lo hace in-place
      let sortedEntriesForMigration = [...entries];

      // Necesitamos una versión de sortEntriesByCurrentMode que acepte el modo como parámetro
      // para no depender del `sortMode` global que podría no estar inicializado aún de la forma que queremos aquí.
      // Por ahora, asumiremos que el `sortMode` global ya está establecido por `restoreFiltersAndState`.
      // Si no, tendríamos que replicar la lógica de sortEntriesByCurrentMode aquí.
      // Para simplificar, vamos a usar el `sortMode` global que ya debería estar cargado.
      // Nota: La función sortEntriesByCurrentMode ahora sí toma `entries` como argumento y lo devuelve ordenado.

      if (currentEffectiveSortMode === 'byCustomOrder') {
         // Si el modo por defecto ya era customOrder y estamos migrando, algo es raro.
         // Mejor usar un orden base como nombre para la migración inicial.
         console.warn("Migrando con customOrder como base no es ideal, usando orden por nombre A-Z.");
         sortedEntriesForMigration.sort((a, b) => a[0].localeCompare(b[0])); // Nombre A-Z
      } else {
        // Usamos la función global de sort, que usa el 'sortMode' global.
        // Esto es un poco indirecto. Sería más robusto si sortEntriesByCurrentMode tomara el modo como arg.
        // Temporalmente, para la migración, forzaremos el sortMode global si es necesario.
        // Creamos una copia para no modificar el sortMode global permanentemente aquí
        const tempSortModeForMigration = sortMode;
        sortMode = currentEffectiveSortMode;
        sortedEntriesForMigration = sortEntriesByCurrentMode(sortedEntriesForMigration); // sortEntriesByCurrentMode devuelve una nueva lista ordenada
        sortMode = tempSortModeForMigration; // Restaurar el sortMode original
      }


      let changesMade = false;
      sortedEntriesForMigration.forEach(([name, data], index) => {
        if (items[name] && items[name].customSortOrder === undefined) {
          items[name].customSortOrder = (index + 1) * 1000; // Empezar desde 1000, 2000, etc.
          changesMade = true;
        }
      });

      if (changesMade) {
        setAllItems(items);
        console.log("Migración completada. Se asignaron órdenes personalizadas iniciales.");
      } else {
        console.log("No se necesitaron cambios en la migración o los ítems ya tenían customSortOrder.");
      }
      localStorage.setItem(ORDER_SYSTEM_MIGRATED_KEY, 'true');
    }
    // *** FIN NUEVAS FUNCIONES PARA MIGRACIÓN Y ORDEN PERSONALIZADO ***

    // *** INICIO NUEVA FUNCIÓN PARA LLENAR SELECT DE ORDEN PERSONALIZADO ***
    function fillCustomSortPositionSelect(editingProductName, currentProductSortOrder) {
      const select = document.getElementById('editCustomSortPosition');
      select.innerHTML = ''; // Limpiar opciones previas

      const items = getAllItems();
      const productKeys = Object.keys(items).sort((a, b) => {
        const orderA = items[a]?.customSortOrder ?? Number.MAX_SAFE_INTEGER;
        const orderB = items[b]?.customSortOrder ?? Number.MAX_SAFE_INTEGER;
        if (orderA === orderB) return a.localeCompare(b);
        return orderA - orderB;
      });

      let foundCurrentProductInSortedList = false;

      // Opción: Mantener posición actual (solo si se está editando)
      if (editingProductName) {
        const optCurrent = document.createElement('option');
        optCurrent.value = `current_${currentProductSortOrder}`; // Guardar el orden actual para referencia
        optCurrent.textContent = 'Mantener posición actual';
        select.appendChild(optCurrent);
      }

      // Opción: Al principio
      const optStart = document.createElement('option');
      optStart.value = 'at_start';
      optStart.textContent = 'Al principio de la lista';
      select.appendChild(optStart);

      // Opciones: Después de [Producto X]
      productKeys.forEach(key => {
        if (key === editingProductName) {
          foundCurrentProductInSortedList = true;
          return; // No ofrecer "después de sí mismo"
        }
        const optAfter = document.createElement('option');
        optAfter.value = `after_${key}`;
        optAfter.textContent = `Después de: ${items[key].numero ? '['+items[key].numero+']' : ''} ${key}`;
        select.appendChild(optAfter);
      });

      // Opción: Al final (por defecto para nuevos productos, o si se edita y no se selecciona otra)
      const optEnd = document.createElement('option');
      optEnd.value = 'at_end';
      optEnd.textContent = 'Al final de la lista';
      select.appendChild(optEnd);

      // Seleccionar la opción por defecto
      if (editingProductName) {
        select.value = `current_${currentProductSortOrder}`; // Default a mantener posición
      } else {
        select.value = 'at_end'; // Default al final para nuevos productos
      }
    }
    // *** FIN NUEVA FUNCIÓN PARA LLENAR SELECT DE ORDEN PERSONALIZADO ***

    // === ACTUALIZAR BADGE Y MODAL ===
    function updateInfoBadge() {
      const badge = document.getElementById('infoBadgeCount');
      const icon = document.getElementById('infoBadgeIcon');
      const tabPedido = document.getElementById('pedidoTab').style.display !== 'none';
      const tabOrden = document.getElementById('ordenTab').style.display !== 'none';
      const tabInventario = document.getElementById('inventarioTab').style.display !== 'none';
      let count = 0;
      let iconName = 'shopping_cart';
      let infoText = '';
      // Usar el mismo texto y conteo que el contador actual
      const itemCountElement = document.getElementById('itemCountDisplay');
      if (itemCountElement) {
        // El texto ya se actualiza en renderTabs, solo tomar el número
        infoText = itemCountElement.textContent;
        // Extraer número del texto
        const match = infoText.match(/(\d+)/);
        if (match) count = parseInt(match[1], 10);
      }
      // Cambiar icono según pestaña
      if (tabPedido || tabOrden) iconName = 'shopping_cart';
      if (tabInventario) iconName = 'inventory_2';
      icon.textContent = iconName;
      badge.textContent = count;
    }

    // Llamar updateInfoBadge en cada renderTabs y cuando cambie el filtro
    const _originalRenderTabs = renderTabs;
    renderTabs = function() {
      _originalRenderTabs();
      updateInfoBadge();
    }
    // También actualizar al cambiar filtros
    const _originalUpdateSearch = updateSearch;
    updateSearch = function(val) {
      _originalUpdateSearch(val);
      updateInfoBadge();
    }
    // Y al seleccionar compañía
    const _originalSelectCompany = selectCompany;
    selectCompany = function(name) {
      _originalSelectCompany(name);
      updateInfoBadge();
    }

    // === MODAL INFO BADGE ===
    function openInfoBadgeModal(event) {
      event.stopPropagation();
      const modal = document.getElementById('infoBadgeModal');
      const iconEl = document.getElementById('infoBadgeModalIcon');
      const textEl = document.getElementById('infoBadgeModalText');
      const tabPedido = document.getElementById('pedidoTab').style.display !== 'none';
      const tabOrden = document.getElementById('ordenTab').style.display !== 'none';
      const tabInventario = document.getElementById('inventarioTab').style.display !== 'none';
      
      let iconName = 'shopping_cart';
      if (tabPedido || tabOrden) iconName = 'shopping_cart';
      if (tabInventario) iconName = 'inventory_2';
      
      iconEl.textContent = iconName;
      
      // Obtener el texto del contador de itemCountDisplay y mostrarlo en el modal
      const itemCountElement = document.getElementById('itemCountDisplay');
      textEl.textContent = itemCountElement ? itemCountElement.textContent : 'Información no disponible';
      
      modal.classList.add('show');
      document.body.classList.add('body-modal-open');
    }
    function closeInfoBadgeModal() {
      document.getElementById('infoBadgeModal').classList.remove('show');
      document.body.classList.remove('body-modal-open');
    }
    // Cerrar modal al hacer click fuera
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('infoBadgeModal');
      if (modal && modal.classList.contains('show')) {
        const content = modal.querySelector('.modal-content');
        if (content && !content.contains(e.target)) { 
          closeInfoBadgeModal();
        }
      }
    });
    // Inicializar badge al cargar
    window.addEventListener('DOMContentLoaded', updateInfoBadge);

    function updateItemCount() {
      const itemCountElement = document.getElementById('itemCountDisplay');
      if (!itemCountElement) return;

      const activeTabElement = document.querySelector('.tab.active');
      if (!activeTabElement) return;
      
      const activeTabName = activeTabElement.textContent.toLowerCase();
      const items = getAllItems();
      let entries = Object.entries(items);

      // Aplicar filtros para el conteo (búsqueda y compañía)
      if (searchTerm) {
          const lowerSearchTerm = searchTerm.toLowerCase();
          entries = entries.filter(([key, data]) => {
            const lowerKey = key.toLowerCase();
            const productTags = data.tags || [];
            return lowerKey.includes(lowerSearchTerm) || 
                   productTags.some(tag => tag.toLowerCase().includes(lowerSearchTerm));
          });
      }
      if (currentCompanyFilter) {
          entries = entries.filter(([, data]) => data && data.company === currentCompanyFilter);
      }

      if (activeTabName === 'pedido') {
          const pedidoConCantidad = entries.filter(([, data]) => data && data.pedidoQty && parseQuantity(data.pedidoQty) > 0);
          if (pedidoConCantidad.length === 0) {
              itemCountElement.textContent = "Nada en pedido";
          } else if (pedidoConCantidad.length === 1) {
              itemCountElement.textContent = `1 producto en pedido`;
          } else {
              itemCountElement.textContent = `${pedidoConCantidad.length} productos en pedido`;
          }
      } else if (activeTabName === 'orden') {
          let distinctItemCountInOrder = 0;
          let totalQuantitySumInOrder = 0;
          const itemsEnOrden = entries.filter(([, data]) => 
              data && (
                  (data.pedidoQty && parseQuantity(data.pedidoQty) > 0) ||
                  (data.creditQty && parseQuantity(data.creditQty) > 0)
              )
          );

          if (itemsEnOrden.length > 0) {
              distinctItemCountInOrder = itemsEnOrden.length; // Cada entrada filtrada es un ítem distinto en la orden
              itemsEnOrden.forEach(([, data]) => {
                  totalQuantitySumInOrder += parseQuantity(data.pedidoQty || 0);
                  totalQuantitySumInOrder += parseQuantity(data.creditQty || 0);
              });
          }

          if (distinctItemCountInOrder === 0) {
              itemCountElement.textContent = "Orden vacía";
          } else {
              let countText = `Orden: ${distinctItemCountInOrder} ítem(s)`;
              if (totalQuantitySumInOrder > 0) {
                  countText += ` / Total: ${formatQuantity(totalQuantitySumInOrder)} unidades`;
              }
              itemCountElement.textContent = countText;
          }

      } else if (activeTabName === 'inventario') {
          if (entries.length === 0) {
              itemCountElement.textContent = "Inventario vacío";
          } else if (entries.length === 1) {
              itemCountElement.textContent = `1 producto en inventario`;
          } else {
              itemCountElement.textContent = `${entries.length} productos en inventario`;
          }
      }
      updateInfoBadge(); // Asegurarse que el badge también se actualice
    }

    // Event listener para cerrar el popup al hacer clic en cualquier parte
    document.addEventListener('click', function(event) {
      const target = event.target;

      // 1. Company Popup
      const companyPopup = document.getElementById('companyPopup');
      const companyPopupButton = document.querySelector('.store-icon-btn'); 
      
      if (companyPopup && companyPopup.classList.contains('show')) {
        // Cerrar si el clic NO es en el botón que lo abre Y NO es dentro del popup
        if (companyPopupButton && !companyPopupButton.contains(target) && !companyPopup.contains(target)) {
          companyPopup.classList.remove('show');
        }
      }

      // 2. View Options Popup
      const viewOptionsPopup = document.getElementById('viewOptions');
      // El botón de opciones de vista ahora es el segundo .header-icon-btn en .header-icon-group-right
      const viewOptionsButton = document.querySelector('.header-icon-group-right .header-icon-btn:nth-child(2)'); 

      if (viewOptionsPopup && viewOptionsPopup.style.display === 'flex') {
        // Cerrar si el clic NO es en el botón que lo abre Y NO es dentro del popup
        if (viewOptionsButton && !viewOptionsButton.contains(target) && !viewOptionsPopup.contains(target)) {
          toggleViewOptions(); // Esta función maneja el cierre/apertura
        }
      }

      // 3. Info Badge Modal (Carrito)
      const infoBadgeModal = document.getElementById('infoBadgeModal');
      const infoBadgeButton = document.getElementById('infoBadgeBtn'); // Botón que abre este modal

      if (infoBadgeModal && infoBadgeModal.classList.contains('show')) {
        const modalContent = infoBadgeModal.querySelector('.info-badge-modal-content');
        // Cerrar si el clic es en el backdrop (directamente en infoBadgeModal pero no en su contenido) 
        // O si es fuera del contenido y NO en el botón que lo abre.
        if (target === infoBadgeModal || 
            (modalContent && !modalContent.contains(target) && infoBadgeButton && !infoBadgeButton.contains(target)) ) {
          closeInfoBadgeModal();
        }
      }
    });
    // --- FIN NUEVAS FUNCIONES ---

    // --- INICIO NUEVAS FUNCIONES PARA ESTABLECER INVENTARIO A 1 ---
    function openSetAllInventoryToOneModal() {
      console.log("openSetAllInventoryToOneModal CALLED"); // <-- Linea de depuración
      document.getElementById('setAllInventoryToOneModal').classList.add('show');
      document.body.classList.add('body-modal-open');
    }

    function confirmSetAllInventoryToOne() {
      const items = getAllItems();
      for (const name in items) {
        if (items.hasOwnProperty(name) && items[name]) { // Asegurar que el producto exista y sea propio del objeto
          items[name].inventarioQty = 1; // Establecer a 1
        }
      }
      setAllItems(items);
      renderInventarioTab(); // Solo renderizar la pestaña de inventario
      updateItemCount(); // Actualizar el contador
      closeSetAllInventoryToOneModal();
    }

    function closeSetAllInventoryToOneModal() {
      document.getElementById('setAllInventoryToOneModal').classList.remove('show');
      document.body.classList.remove('body-modal-open');
    }
    // --- FIN NUEVAS FUNCIONES PARA ESTABLECER INVENTARIO A 1 ---
  </script>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js")
      .then(r => console.log("SW registrado:", r.scope))
      .catch(console.error);
  }
</script>
</body>
</html>
